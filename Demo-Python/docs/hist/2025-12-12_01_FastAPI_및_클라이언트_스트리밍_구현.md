# 작업 히스토리: FastAPI 및 gRPC 클라이언트 스트리밍 구현

- **작업 일자:** 2025년 12월 12일
- **담당자:** Gemini
- **티켓:** N/A

---

## 1. 상황 요약

기존 `Demo-Python` 서버는 배치 서버의 요청을 받아 데이터를 전송하는 gRPC 서버(서버 스트리밍) 역할만 수행했습니다.

이번 작업의 목표는 다음과 같이 서버의 역할을 확장하는 것이었습니다.
- **FastAPI 엔드포인트 추가**: 외부 HTTP 요청을 통해 데이터 처리를 트리거할 수 있는 API를 제공합니다.
- **gRPC 클라이언트 스트리밍 구현**: 파이썬 서버가 '클라이언트'가 되어 배치 서버로 대용량 데이터를 스트리밍으로 전송합니다.
- **계층형 아키텍처 적용**: 역할(API, 서비스, 도메인, 인프라)에 따라 프로젝트 구조를 리팩토링합니다.
- **제네릭 데이터 로딩**: 다양한 형태의 `.pkl` 파일을 처리할 수 있도록 공변성을 활용한 유연한 데이터 로더를 구현합니다.

## 2. 구현 내용

### 가. gRPC 인터페이스 (`proto`) 수정

- `embedding_stream.proto` 파일에 Python -> Java 방향의 **클라이언트 스트리밍** RPC `IngestDataStream`을 새로 추가했습니다.
- 스트리밍 데이터 전송을 위한 `IngestDataRequest`, `IngestMetadata`와 최종 응답을 위한 `IngestDataResponse` 메시지를 정의했습니다.

### 나. 계층형 아키텍처 리팩토링

- 기존의 단일 계층 구조를 역할 기반의 계층형 아키텍처로 전면 리팩토링했습니다.
- 생성된 디렉토리 구조는 다음과 같습니다.
  ```
  src/
  ├── api/           # FastAPI 엔드포인트
  ├── config/        # 환경 설정
  ├── domain/        # 데이터 모델, 핵심 유틸리티
  ├── infrastructure/  # 외부 시스템 연동 (gRPC, 파일 로더)
  ├── services/      # 비즈니스 로직
  ├── proto/         # .proto 및 생성된 gRPC 코드
  └── main.py        # 애플리케이션 진입점
  ```

### 다. 제네릭 데이터 로더 구현

- `typing.TypeVar`의 공변성(`covariant=True`)을 사용하여 `DataLoader` 프로토콜을 `infrastructure/loaders.py`에 정의했습니다.
- `Recruit`, `Candidate` 등 각 도메인별 데이터 구조를 `domain/models.py`에 `Pydantic` 모델로 정의했습니다.
- 도메인 이름에 따라 적절한 로더를 반환하는 팩토리 함수 `get_loader`를 구현하여 확장성을 확보했습니다.

### 라. FastAPI 엔드포인트 및 gRPC 클라이언트 구현

- **FastAPI 엔드포인트**: `api/endpoints.py`에 `POST /data/ingest/{domain}` 엔드포인트를 구현했습니다. 이 엔드포인트는 `file_name`을 쿼리 파라미터로 받아 데이터 수집 프로세스를 트리거합니다.
- **gRPC 클라이언트**: `infrastructure/grpc_clients.py`에 `stream_data_to_batch_server` 비동기 함수를 구현했습니다. 이 함수는 제네릭 로더를 통해 읽은 데이터를 청크 단위로 분할하고, 비동기 제너레이터를 사용하여 배치 서버의 `IngestDataStream` RPC로 전송합니다.
- **서비스 계층**: `services/ingestion_service.py`에서 데이터 로딩 -> gRPC 전송으로 이어지는 전체 비즈니스 흐름을 관장하도록 구현했습니다.

## 3. 결과 및 검증 방법

### 가. 실행 방법

1.  **의존성 설치**: (이미 설치했다면 생략)
    ```bash
    pip install -r requirements.txt
    ```

2.  **FastAPI 서버 실행**: `Demo-Python` 루트 디렉토리에서 다음 명령어를 실행합니다.
    ```bash
    uvicorn src.main:app --reload --port 8000
    ```

### 나. 테스트 방법

- 터미널에서 `curl`을 사용하여 `recruit` 도메인의 데이터를 처리하도록 요청합니다.

  ```bash
  curl -X POST "http://localhost:8000/data/ingest/recruit?file_name=processed_recruitment_data.pkl" -H "accept: application/json"
  ```

### 다. 주의사항

- 이 기능은 **Java 배치 서버**가 `IngestDataStream` RPC를 구현해야 정상적으로 동작합니다. 현재는 gRPC 클라이언트 로직만 구현되었으므로, 배치 서버가 준비되지 않았다면 `curl` 요청 시 gRPC 연결 오류가 발생합니다.
