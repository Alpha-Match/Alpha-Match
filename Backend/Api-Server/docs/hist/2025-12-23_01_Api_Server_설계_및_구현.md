# Api-Server 설계 및 구현 (2025-12-23)

## 1. 작업 개요

Alpha-Match 프로젝트의 **Api-Server**를 설계하고 구현했습니다. Api-Server는 Frontend의 GraphQL 요청을 처리하고, pgvector 기반 벡터 유사도 검색을 수행하는 역할을 담당합니다.

**작업 순서:**
1. Frontend 요구사항 분석 (GraphQL 쿼리 분석)
2. 아키텍처 설계 (Clean Architecture 적용)
3. 도메인 모델 구현 (Recruit, Candidate, Skill Dictionary)
4. Repository Layer 구현 (R2DBC + PGvector)
5. Service Layer 구현 (스킬 정규화, 검색)
6. GraphQL Resolver 구현
7. 테스트 코드 작성 (JUnit 5 + Mockito + Reactor Test)

---

## 2. Frontend 요구사항 분석 결과

### 2.1. Frontend GraphQL 쿼리 분석

**분석 파일:**
- `C:\Final_2025-12-09\Alpha-Match\Frontend\Front-Server\src\hooks\useSearchMatches.ts`
- `C:\Final_2025-12-09\Alpha-Match\Frontend\Front-Server\src\components\AppInitializer.tsx`

**식별된 요구사항:**

#### Query 1: `SEARCH_MATCHES_QUERY`
```graphql
query SearchMatches($mode: UserMode!, $skills: [String!]!, $experience: String!) {
  searchMatches(mode: $mode, skills: $skills, experience: $experience) {
    matches {
      id
      title
      company
      score
      skills
      experience
      description
    }
    vectorVisualization {
      skill
      isCore
      x
      y
    }
  }
}
```

**파라미터:**
- `mode`: `CANDIDATE` (구직자) 또는 `RECRUITER` (구인자)
- `skills`: 기술 스택 리스트 (예: `["Java", "Python", "C"]`)
- `experience`: 경력 범위 문자열 (예: `"3-5 Years"`)

**반환값:**
- `matches`: 매칭된 결과 리스트 (채용 공고 또는 지원자)
- `vectorVisualization`: 벡터 시각화 데이터 (Frontend에서 차트로 표시)

#### Query 2: `GET_SKILL_CATEGORIES`
```graphql
query GetSkillCategories {
  skillCategories {
    category
    skills
  }
}
```

**반환값:**
- 카테고리별 기술 스택 목록 (예: Backend: [Java, Python, Go])
- Frontend의 기술 스택 셀렉터 초기화에 사용

---

## 3. 구현된 아키텍처 (Clean Architecture)

### 3.1. 레이어 구조

```
┌─────────────────────────────────────────────────────────────┐
│                    GraphQL Layer                            │
│  - QueryResolver: GraphQL 쿼리 처리                         │
│  - Type: MatchItem, SkillCategory, SearchMatchesResult      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Service Layer                            │
│  - SearchService: 통합 검색 로직                            │
│  - SkillNormalizationService: 스킬 정규화                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Domain Layer (Port)                      │
│  - Entity: Recruit, Candidate, SkillEmbeddingDic            │
│  - Repository Interface: RecruitRepository, ...             │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                Infrastructure Layer (Adapter)               │
│  - R2DBC Repository: Spring Data R2DBC 구현                 │
│  - PGvector 쿼리: 벡터 유사도 검색                          │
└─────────────────────────────────────────────────────────────┘
```

### 3.2. Reactive Programming (Project Reactor)

- **Mono**: 단일 결과 반환 (예: `findById`)
- **Flux**: 다중 결과 반환 (예: `findSimilarByVector`)
- **Non-blocking**: WebFlux 기반 완전 비동기 처리

---

## 4. 구현된 컴포넌트 목록

### 4.1. Entity (Domain Model)

**위치:** `C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server\src\main\java\com\alpha\api\domain\{domain}\entity\`

#### Recruit 도메인 (4개 엔티티)
1. **Recruit**: 채용 공고 메타 정보
   - `recruit_id` (PK, UUID)
   - `position`, `company_name`, `experience_years`
   - `primary_keyword`, `english_level`, `published_at`

2. **RecruitDescription**: 채용 공고 상세 원문
   - `recruit_id` (PK/FK)
   - `long_description`, `description_lang`

3. **RecruitSkill**: 채용 공고 기술 스택 (1:N)
   - `recruit_id` (PK/FK), `skill` (PK)

4. **RecruitSkillsEmbedding**: 채용 공고 벡터 (1:1)
   - `recruit_id` (PK/FK)
   - `skills` (TEXT[]), `skills_vector` (VECTOR(384))

#### Candidate 도메인 (4개 엔티티)
1. **Candidate**: 지원자 이력서 메타 정보
   - `candidate_id` (PK, UUID)
   - `position_category`, `experience_years`, `original_resume`

2. **CandidateDescription**: 이력서 상세 원문
   - `candidate_id` (PK/FK)
   - `original_resume`, `resume_lang`

3. **CandidateSkill**: 지원자 기술 스택 (1:N)
   - `candidate_id` (PK/FK), `skill` (PK)

4. **CandidateSkillsEmbedding**: 지원자 벡터 (1:1)
   - `candidate_id` (PK/FK)
   - `skills` (TEXT[]), `skills_vector` (VECTOR(384))

#### Skill Dictionary 도메인 (2개 엔티티)
1. **SkillCategoryDic**: 직종 카테고리 사전
   - `category_id` (PK, UUID)
   - `category` (UK, e.g., "Backend", "Frontend")

2. **SkillEmbeddingDic**: 기술 스택 임베딩 사전
   - `skill_id` (PK, UUID)
   - `category_id` (FK)
   - `skill` (UK, e.g., "Java", "Python")
   - `skill_vector` (VECTOR(384))

---

### 4.2. Repository Layer (R2DBC + PGvector)

**위치:** `C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server\src\main\java\com\alpha\api\domain\{domain}\repository\`

#### RecruitRepository
- `findById(UUID)`: 채용 공고 ID로 조회
- `findSimilarByVector(String, Double, Integer)`: PGvector 유사도 검색
- `findByExperienceYearsBetween(Integer, Integer)`: 경력 범위 필터링
- `findByCompanyNameContaining(String)`: 회사명 검색

**핵심 쿼리 (PGvector):**
```sql
SELECT r.*, (1 - (rse.skills_vector <=> CAST(:queryVector AS vector))) AS similarity_score
FROM recruit r
INNER JOIN recruit_skills_embedding rse ON r.recruit_id = rse.recruit_id
WHERE (1 - (rse.skills_vector <=> CAST(:queryVector AS vector))) >= :similarityThreshold
ORDER BY rse.skills_vector <=> CAST(:queryVector AS vector)
LIMIT :limit
```

- `<=>`: Cosine distance 연산자
- `(1 - distance)`: Cosine similarity 계산
- `>= 0.7`: 유사도 임계값 필터링

#### CandidateRepository
- Recruit과 동일한 구조
- `candidate_skills_embedding` 테이블 조인

#### SkillEmbeddingDicRepository
- `findBySkill(String)`: 기술 스택명으로 조회 (대소문자 무시)
- `findBySkillIn(List<String>)`: 여러 기술 스택 일괄 조회 (스킬 정규화용)
- `findByCategoryId(UUID)`: 카테고리별 기술 스택 조회
- `findAllWithCategory()`: 전체 기술 스택 + 카테고리 정보

---

### 4.3. Service Layer

**위치:** `C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server\src\main\java\com\alpha\api\domain\{domain}\service\`

#### SkillNormalizationService

**역할:** 스킬 정규화 (기술 스택 → 쿼리 벡터 변환)

**핵심 메서드:**
```java
public Mono<String> normalizeSkillsToQueryVector(List<String> skills)
```

**플로우:**
```
입력: ["Java", "Python", "C"]
  ↓
skill_embedding_dic에서 각 스킬 벡터 조회
  ↓
벡터 평균 계산 (384차원)
  ↓
PostgreSQL vector 형식 문자열 변환: "[0.1,0.2,0.3,...]"
  ↓
반환: 쿼리 벡터 (String)
```

**주요 로직:**
- `calculateAverageVector()`: 여러 스킬 벡터의 평균 계산
- `parseVectorString()`: PostgreSQL vector 문자열 파싱
- `convertToVectorString()`: float[] → PostgreSQL vector 문자열

#### SearchService

**역할:** 통합 검색 서비스 (searchMatches 쿼리 처리)

**핵심 메서드:**
```java
public Mono<SearchMatchesResult> searchMatches(UserMode mode, List<String> skills, String experience)
```

**플로우:**
```
1. SkillNormalizationService로 쿼리 벡터 생성
2. mode에 따라 분기:
   - CANDIDATE: searchRecruits() → 채용 공고 검색
   - RECRUITER: searchCandidates() → 지원자 검색
3. 벡터 유사도 검색 (similarityThreshold: 0.7)
4. 결과 변환 (Entity → GraphQL Type)
5. vectorVisualization 생성
6. SearchMatchesResult 반환
```

**보조 메서드:**
- `parseExperienceString()`: 경력 문자열 파싱
  - `"0-2 Years"` → `ExperienceRange(0, 2)`
  - `"10+ Years"` → `ExperienceRange(10, 999)`
- `getSkillCategories()`: 카테고리별 기술 스택 조회

---

### 4.4. GraphQL Layer

#### GraphQL Schema

**위치:** `C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server\src\main\resources\graphql\schema.graphqls`

```graphql
enum UserMode {
  CANDIDATE
  RECRUITER
}

type MatchItem {
  id: String!
  title: String!
  company: String!
  score: Float!
  skills: [String!]!
  experience: Int
  description: String
}

type SkillMatch {
  skill: String!
  isCore: Boolean!
  x: Float!
  y: Float!
}

type SearchMatchesResult {
  matches: [MatchItem!]!
  vectorVisualization: [SkillMatch!]!
}

type SkillCategory {
  category: String!
  skills: [String!]!
}

type Query {
  searchMatches(mode: UserMode!, skills: [String!]!, experience: String!): SearchMatchesResult!
  skillCategories: [SkillCategory!]!
}
```

#### QueryResolver

**위치:** `C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server\src\main\java\com\alpha\api\graphql\resolver\QueryResolver.java`

```java
@Controller
public class QueryResolver {

    @QueryMapping
    public Mono<SearchMatchesResult> searchMatches(
            @Argument UserMode mode,
            @Argument List<String> skills,
            @Argument String experience) {
        return searchService.searchMatches(mode, skills, experience);
    }

    @QueryMapping
    public Mono<List<SkillCategory>> skillCategories() {
        return searchService.getSkillCategories();
    }
}
```

---

## 5. 핵심 기능 플로우 (검색 플로우)

### 5.1. searchMatches 쿼리 전체 플로우

```
┌──────────────────────────────────────────────────────────────┐
│ Frontend (Apollo Client)                                     │
│                                                              │
│  useSearchMatches({                                          │
│    mode: "CANDIDATE",                                        │
│    skills: ["Java", "Python"],                               │
│    experience: "3-5 Years"                                   │
│  })                                                          │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼ (GraphQL HTTP Request)
┌──────────────────────────────────────────────────────────────┐
│ Api-Server: QueryResolver.searchMatches()                   │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│ SearchService.searchMatches()                                │
│  1. SkillNormalizationService.normalizeSkillsToQueryVector() │
│     - skill_embedding_dic에서 "Java", "Python" 벡터 조회     │
│     - 벡터 평균 계산: queryVector = "[0.25,0.35,...]"       │
│                                                              │
│  2. parseExperienceString("3-5 Years")                       │
│     - ExperienceRange(3, 5) 생성                             │
│                                                              │
│  3. mode == CANDIDATE → searchRecruits()                     │
│     - RecruitRepository.findSimilarByVector(queryVector)     │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│ PostgreSQL (PGvector)                                        │
│                                                              │
│  SELECT r.*, (1 - (rse.skills_vector <=> '[0.25,0.35,...]')) │
│  FROM recruit r                                              │
│  JOIN recruit_skills_embedding rse                           │
│    ON r.recruit_id = rse.recruit_id                          │
│  WHERE (1 - (rse.skills_vector <=> '[0.25,0.35,...]')) >= 0.7│
│  ORDER BY rse.skills_vector <=> '[0.25,0.35,...]'            │
│  LIMIT 10                                                    │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│ SearchService.searchRecruits()                               │
│  4. RecruitSkillRepository.findByRecruitId() → 기술 스택 조회│
│  5. Entity → MatchItem 변환                                  │
│  6. generateVectorVisualization() → SkillMatch 생성          │
│  7. SearchMatchesResult 반환                                 │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│ Frontend: Apollo Cache → UI 렌더링                          │
└──────────────────────────────────────────────────────────────┘
```

---

## 6. PGvector 쿼리 예시

### 6.1. 벡터 유사도 검색 (Cosine Distance)

**쿼리:**
```sql
SELECT
    r.recruit_id,
    r.position,
    r.company_name,
    r.experience_years,
    (1 - (rse.skills_vector <=> CAST('[0.1,0.2,0.3,...]' AS vector))) AS similarity_score
FROM recruit r
INNER JOIN recruit_skills_embedding rse
    ON r.recruit_id = rse.recruit_id
WHERE (1 - (rse.skills_vector <=> CAST('[0.1,0.2,0.3,...]' AS vector))) >= 0.7
ORDER BY rse.skills_vector <=> CAST('[0.1,0.2,0.3,...]' AS vector)
LIMIT 10;
```

**설명:**
- `<=>`: Cosine distance 연산자 (0에 가까울수록 유사)
- `1 - distance`: Cosine similarity 계산 (1에 가까울수록 유사)
- `>= 0.7`: 유사도 70% 이상만 반환 (table_specification.md 명세)
- `ORDER BY distance ASC`: 거리 오름차순 = 유사도 내림차순
- `LIMIT 10`: 상위 10개만 반환

### 6.2. 벡터 인덱스 (성능 최적화)

**Flyway 마이그레이션에서 생성:**
```sql
CREATE INDEX idx_recruit_skills_vector
ON recruit_skills_embedding
USING ivfflat (skills_vector vector_cosine_ops)
WITH (lists = 100);
```

- **ivfflat**: IVF (Inverted File with Flat compression) 알고리즘
- **vector_cosine_ops**: Cosine distance용 연산자 클래스
- **lists = 100**: 클러스터 개수 (데이터 크기에 따라 조정)

---

## 7. 테스트 코드 작성 내역

### 7.1. Repository 테스트 (3개)

**위치:** `C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server\src\test\java\com\alpha\api\domain\{domain}\repository\`

#### RecruitRepositoryTest
- `testFindById()`: ID로 채용 공고 조회
- `testFindAll()`: 전체 채용 공고 조회
- `testFindByExperienceYearsBetween()`: 경력 범위 필터링
- `testFindByCompanyNameContaining()`: 회사명 검색
- `testCount()`: 전체 개수 조회
- `testFindSimilarByVector()`: PGvector 유사도 검색
- `testFindSimilarByVectorWithThreshold()`: 유사도 임계값 필터링
- `testFindSimilarByVectorWithLimit()`: 결과 개수 제한

**테스트 프레임워크:**
- `@DataR2dbcTest`: R2DBC 리포지토리 슬라이스 테스트
- `StepVerifier`: Reactor 테스트 도구 (Mono/Flux 검증)

#### CandidateRepositoryTest
- RecruitRepositoryTest와 동일한 구조

#### SkillEmbeddingDicRepositoryTest
- `testFindBySkill()`: 기술 스택명으로 조회 (대소문자 무시)
- `testFindBySkillIn()`: 여러 기술 스택 일괄 조회
- `testFindBySkillNotFound()`: 존재하지 않는 기술 스택 처리
- `testFindByCategoryId()`: 카테고리별 기술 스택 조회
- `testFindAllWithCategory()`: 전체 기술 스택 + 카테고리 조회
- `testSearchBySkillContaining()`: 부분 일치 검색
- `testFindBySkillInCaseInsensitive()`: 대소문자 혼합 조회

---

### 7.2. Service 테스트 (2개)

**위치:** `C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server\src\test\java\com\alpha\api\domain\{domain}\service\`

#### SkillNormalizationServiceTest
- `testNormalizeSkillsToQueryVector()`: 스킬 정규화 (평균 벡터 계산)
- `testNormalizeSkillsCaseInsensitive()`: 대소문자 변환 확인
- `testNormalizeSkillsEmptyList()`: 빈 리스트 에러 처리
- `testNormalizeSkillsNullList()`: null 리스트 에러 처리
- `testNormalizeSkillsNoMatchFound()`: 일치하는 기술 스택 없음 에러
- `testNormalizeSkillsSingleSkill()`: 단일 스킬 처리
- `testIsValidSkill()`: 기술 스택 유효성 검증
- `testGetAllSkillsWithCategory()`: 전체 기술 스택 조회
- `testVectorStringFormatting()`: 384차원 벡터 문자열 포맷 확인

**테스트 프레임워크:**
- `@ExtendWith(MockitoExtension.class)`: Mockito 확장
- `@Mock`: 의존성 모킹
- `@InjectMocks`: 테스트 대상 자동 주입

#### SearchServiceTest
- `testSearchMatchesCandidateMode()`: CANDIDATE 모드 검색 (채용 공고)
- `testSearchMatchesRecruiterMode()`: RECRUITER 모드 검색 (지원자)
- `testGetSkillCategories()`: 카테고리별 기술 스택 조회
- `testParseExperienceString0To2()`: "0-2 Years" 파싱
- `testParseExperienceString3To5()`: "3-5 Years" 파싱
- `testParseExperienceString10Plus()`: "10+ Years" 파싱
- `testParseExperienceStringEmpty()`: 빈 경력 문자열 처리
- `testVectorVisualization()`: 벡터 시각화 데이터 생성
- `testSearchMatchesEmptyResults()`: 빈 검색 결과 처리

---

### 7.3. GraphQL Resolver 테스트 (1개)

**위치:** `C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server\src\test\java\com\alpha\api\graphql\resolver\`

#### QueryResolverTest
- `testSearchMatchesCandidateMode()`: searchMatches 쿼리 (CANDIDATE 모드)
- `testSearchMatchesRecruiterMode()`: searchMatches 쿼리 (RECRUITER 모드)
- `testSearchMatchesEmptyResults()`: 빈 검색 결과 처리
- `testSearchMatchesError()`: 검색 에러 처리
- `testSkillCategories()`: skillCategories 쿼리
- `testSkillCategoriesEmpty()`: 빈 카테고리 처리
- `testSkillCategoriesError()`: 카테고리 에러 처리
- `testSearchMatchesParameterPassing()`: 파라미터 전달 검증
- `testSearchMatchesVariousExperienceFormats()`: 다양한 경력 형식 처리

---

## 8. 테스트 실행 방법

### 8.1. 전체 테스트 실행

```bash
cd C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server
.\gradlew test
```

### 8.2. 특정 테스트 클래스 실행

```bash
.\gradlew test --tests RecruitRepositoryTest
.\gradlew test --tests SkillNormalizationServiceTest
.\gradlew test --tests QueryResolverTest
```

### 8.3. 테스트 리포트 확인

```bash
# 테스트 완료 후
start build\reports\tests\test\index.html
```

---

## 9. 구현된 파일 목록

### 9.1. Entity (11개)
```
C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server\src\main\java\com\alpha\api\domain\
├── recruit\entity\
│   ├── Recruit.java
│   ├── RecruitDescription.java
│   ├── RecruitSkill.java
│   └── RecruitSkillsEmbedding.java
├── candidate\entity\
│   ├── Candidate.java
│   ├── CandidateDescription.java
│   ├── CandidateSkill.java
│   └── CandidateSkillsEmbedding.java
└── skilldic\entity\
    ├── SkillCategoryDic.java
    └── SkillEmbeddingDic.java
```

### 9.2. Repository (8개)
```
C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server\src\main\java\com\alpha\api\domain\
├── recruit\repository\
│   ├── RecruitRepository.java
│   ├── RecruitDescriptionRepository.java
│   └── RecruitSkillRepository.java
├── candidate\repository\
│   ├── CandidateRepository.java
│   └── CandidateSkillRepository.java
└── skilldic\repository\
    ├── SkillCategoryDicRepository.java
    └── SkillEmbeddingDicRepository.java
```

### 9.3. Service (2개)
```
C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server\src\main\java\com\alpha\api\domain\
├── skilldic\service\
│   └── SkillNormalizationService.java
└── search\service\
    └── SearchService.java
```

### 9.4. GraphQL (6개)
```
C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server\src\main\java\com\alpha\api\graphql\
├── resolver\
│   └── QueryResolver.java
└── type\
    ├── MatchItem.java
    ├── SkillMatch.java
    ├── SearchMatchesResult.java
    ├── SkillCategory.java
    └── UserMode.java
```

### 9.5. Configuration (2개)
```
C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server\src\main\java\com\alpha\api\config\
├── R2dbcConfig.java
└── CacheConfig.java
```

### 9.6. Test (6개)
```
C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server\src\test\java\com\alpha\api\
├── domain\
│   ├── recruit\repository\
│   │   └── RecruitRepositoryTest.java
│   ├── candidate\repository\
│   │   └── CandidateRepositoryTest.java
│   ├── skilldic\
│   │   ├── repository\
│   │   │   └── SkillEmbeddingDicRepositoryTest.java
│   │   └── service\
│   │       └── SkillNormalizationServiceTest.java
│   └── search\service\
│       └── SearchServiceTest.java
└── graphql\resolver\
    └── QueryResolverTest.java
```

---

## 10. 트러블슈팅 (Troubleshooting)

### 10.1. 빌드 실패 문제

#### 문제 1: Jackson2JsonRedisSerializer Deprecated 경고

**오류 메시지:**
```
warning: [removal] Jackson2JsonRedisSerializer in org.springframework.data.redis.serializer has been deprecated and marked for removal
```

**원인:**
- Spring Boot 4.0부터 `Jackson2JsonRedisSerializer`가 deprecated됨
- 제거 예정(marked for removal)으로 표시되어 향후 버전에서 삭제될 예정

**해결 방법:**

**파일:** `C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server\src\main\java\com\alpha\api\config\CacheConfig.java`

**변경 전:**
```java
import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;

@Bean
public ReactiveRedisTemplate<String, Object> reactiveRedisTemplate(
        ReactiveRedisConnectionFactory connectionFactory,
        JsonMapper jsonMapper) {

    Jackson2JsonRedisSerializer<Object> serializer =
        new Jackson2JsonRedisSerializer<>(jsonMapper, Object.class);

    RedisSerializationContext<String, Object> serializationContext =
        RedisSerializationContext
            .<String, Object>newSerializationContext(new StringRedisSerializer())
            .value(serializer)
            .hashValue(serializer)
            .build();

    return new ReactiveRedisTemplate<>(connectionFactory, serializationContext);
}
```

**변경 후:**
```java
import org.springframework.data.redis.serializer.RedisSerializer;

@Bean
public ReactiveRedisTemplate<String, Object> reactiveRedisTemplate(
        ReactiveRedisConnectionFactory connectionFactory,
        JsonMapper jsonMapper) {

    // Spring Boot 4.0 권장 방식: RedisSerializer.json()
    RedisSerializationContext<String, Object> serializationContext =
        RedisSerializationContext
            .<String, Object>newSerializationContext(new StringRedisSerializer())
            .key(new StringRedisSerializer())
            .value(RedisSerializer.json())
            .hashKey(new StringRedisSerializer())
            .hashValue(RedisSerializer.json())
            .build();

    return new ReactiveRedisTemplate<>(connectionFactory, serializationContext);
}
```

**결과:**
- ✅ Deprecated 경고 제거
- ✅ Spring Boot 4.0 호환성 확보
- ✅ 미래 버전 호환성 보장

---

#### 문제 2: @DataR2dbcTest 어노테이션 없음

**오류 메시지:**
```
error: package org.springframework.boot.test.autoconfigure.data.r2dbc does not exist
import org.springframework.boot.test.autoconfigure.data.r2dbc.DataR2dbcTest;
                                                             ^
```

**원인:**
- Spring Boot 4.0에서 `@DataR2dbcTest` 어노테이션이 제거되거나 패키지 변경
- 또는 R2DBC 테스트 의존성 누락

**시도한 해결 방법:**

1. **Testcontainers 의존성 추가** (`build.gradle`)

```gradle
ext {
    set('testcontainersVersion', "1.20.4")
}

dependencies {
    // R2DBC Test Support
    testImplementation 'org.springframework.boot:spring-boot-testcontainers'
    testImplementation 'org.testcontainers:postgresql'
    testImplementation 'org.testcontainers:r2dbc'
    testImplementation 'io.r2dbc:r2dbc-h2'
}

dependencyManagement {
    imports {
        mavenBom "org.testcontainers:testcontainers-bom:${testcontainersVersion}"
    }
}
```

**결과:** 여전히 `@DataR2dbcTest` 없음 → Spring Boot 4.0에서 제거된 것으로 판단

2. **최종 해결 방법: @SpringBootTest로 대체**

**파일:**
- `RecruitRepositoryTest.java`
- `CandidateRepositoryTest.java`
- `SkillEmbeddingDicRepositoryTest.java`

**변경 전:**
```java
import org.springframework.boot.test.autoconfigure.data.r2dbc.DataR2dbcTest;

@DataR2dbcTest
@TestPropertySource(properties = {
    "spring.r2dbc.url=r2dbc:postgresql://localhost:5432/alpha_match_test"
})
class RecruitRepositoryTest {
    // ...
}
```

**변경 후:**
```java
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
@TestPropertySource(properties = {
    "spring.r2dbc.url=r2dbc:postgresql://localhost:5432/alpha_match_test"
})
class RecruitRepositoryTest {
    // ...
}
```

**일괄 변경 스크립트:**
```bash
cd Backend/Api-Server/src/test/java
find . -name "*RepositoryTest.java" -exec sed -i 's/@DataR2dbcTest/@SpringBootTest/g' {} \;
find . -name "*RepositoryTest.java" -exec sed -i 's/org.springframework.boot.test.autoconfigure.data.r2dbc.DataR2dbcTest/org.springframework.boot.test.context.SpringBootTest/g' {} \;
```

**결과:**
- ✅ 컴파일 성공
- ⚠️ 전체 ApplicationContext 로딩 (테스트 속도 느려질 수 있음)
- ⚠️ 향후 R2DBC Slice Test 대안 검토 필요

**대안 (향후 고려):**
- `@SpringBootTest(webEnvironment = NONE)`: Web 환경 제외
- Custom Test Configuration: R2DBC 컴포넌트만 로딩
- TestContainers PostgreSQL: 실제 DB 환경 테스트

---

### 10.2. 빌드 성공 결과

**최종 빌드 로그:**
```
> Task :compileJava
> Task :compileTestJava
> Task :test
> Task :build

BUILD SUCCESSFUL in 22s
8 actionable tasks: 3 executed, 5 up-to-date
```

**검증 완료:**
- ✅ Main 코드 컴파일: 성공
- ✅ Test 코드 컴파일: 성공
- ✅ JAR 빌드: 성공
- ✅ 경고 없음 (Deprecated 경고 제거)

**변경된 파일 목록:**
1. `build.gradle` - Testcontainers 의존성 추가
2. `CacheConfig.java` - RedisSerializer.json() 사용
3. `RecruitRepositoryTest.java` - @SpringBootTest 변경
4. `CandidateRepositoryTest.java` - @SpringBootTest 변경
5. `SkillEmbeddingDicRepositoryTest.java` - @SpringBootTest 변경

---

### 10.3. 학습 사항 (Lessons Learned)

#### Spring Boot 4.0 주요 변경사항
1. **Jackson2JsonRedisSerializer 제거 예정**
   - 대체: `RedisSerializer.json()`
   - 이유: 내부 구현 단순화 및 유지보수성 향상

2. **@DataR2dbcTest 제거 (추정)**
   - 대체: `@SpringBootTest` 또는 Custom Configuration
   - 이유: R2DBC Slice Test 지원 중단 또는 구조 변경

3. **Testcontainers 통합 강화**
   - `spring-boot-testcontainers` 스타터 추가
   - 컨테이너 기반 통합 테스트 권장

#### 권장 사항
- **Spring Boot 업그레이드 시 주의사항:**
  - Deprecated API 조기 교체
  - 테스트 어노테이션 변경사항 확인
  - 의존성 버전 호환성 검증

- **테스트 전략:**
  - Slice Test보다 Testcontainers 기반 통합 테스트 우선 고려
  - 실제 DB 환경 테스트로 신뢰성 향상

---

## 11. 다음 단계 (예정)

### 11.1. 캐싱 구현 (우선순위: 높음)
- **L1 Cache (Caffeine)**: In-memory, 10초 TTL
- **L2 Cache (Redis)**: 분산 캐싱, 10분 TTL
- **캐싱 대상:**
  - `searchMatches` 쿼리 결과
  - `skillCategories` 쿼리 결과
  - 스킬 정규화 벡터 (중간 계산 결과)

### 11.2. gRPC 서버 구현 (캐시 무효화)
- **Batch-Server → Api-Server 통신**
- **Proto 정의:** `cache_invalidation.proto`
- **구현:**
  - `CacheInvalidateServiceImpl.java` (gRPC Server)
  - Batch 작업 완료 시 캐시 무효화

### 11.3. 통합 테스트 (End-to-End)
- **Testcontainers**: PostgreSQL + Redis 컨테이너
- **GraphQL 통합 테스트**: `@GraphQlTest`
- **실제 DB 데이터로 검증**

### 11.4. 성능 최적화
- **PGvector 인덱스 튜닝**: `lists` 파라미터 조정
- **쿼리 최적화**: N+1 문제 해결 (Batch fetching)
- **Connection Pool 설정**: R2DBC Pool 크기 조정

### 11.5. 모니터링 및 로깅
- **Micrometer Metrics**: GraphQL 쿼리 응답 시간 측정
- **Zipkin 연동**: 분산 추적
- **Structured Logging**: JSON 형식 로그

---

## 12. 참고 문서

- **프로젝트 루트 문서**: `C:\Final_2025-12-09\Alpha-Match\CLAUDE.md`
- **DB 스키마 가이드**: `C:\Final_2025-12-09\Alpha-Match\Backend\docs\DB_스키마_가이드.md`
- **테이블 명세서**: `C:\Final_2025-12-09\Alpha-Match\Backend\docs\table_specification.md`
- **Api-Server CLAUDE**: `C:\Final_2025-12-09\Alpha-Match\Backend\Api-Server\CLAUDE.md`

---

**작성일:** 2025-12-23
**작성자:** Alpha-Match Team (AI Agent)
