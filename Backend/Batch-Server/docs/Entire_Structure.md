# ğŸ“˜ í”„ë¡œì íŠ¸ ì „ì²´ ì•„í‚¤í…ì²˜ ì„¤ê³„ì„œ

ì†Œìœ ì: ê¹€íƒœí˜„
íƒœê·¸: ê°€ì´ë“œì™€ í”„ë¡œì„¸ìŠ¤

> ì´ ë¬¸ì„œëŠ” ì „ì²´ í”„ë¡œì íŠ¸ê°€ ì–´ë–¤ êµ¬ì¡°ë¡œ ë™ì‘í•˜ë©°, ê° ì»´í¬ë„ŒíŠ¸ê°€ ì–´ë–¤ ì±…ì„ì„ ê°–ëŠ”ì§€
> 
> 
> **MCP(í”„ë¡ íŠ¸Â·ë°±ì—”ë“œÂ·AIÂ·ë°°ì¹˜Â·ì¸í”„ë¼ ì „ì›ì´ ë¹ ë¥´ê²Œ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ìš”ì•½í•œ êµ¬ì¡°ë„**ì…ë‹ˆë‹¤.
> 

---

# 1. í”„ë¡œì íŠ¸ ëª©í‘œ(ìš”ì•½)

ì´ í”„ë¡œì íŠ¸ëŠ” ë‹¤ìŒ 3ê°€ì§€ í•µì‹¬ ì‹¤í—˜ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ê³„ë˜ì–´ ìˆë‹¤.

1. **Reactive ê¸°ë°˜ API ì„œë²„(WebFlux)ë¡œ ìœ ì—°í•œ GraphQL ì¡°íšŒ í™˜ê²½ êµ¬ì¶•**
2. **Python Embedding ì„œë²„ â†” Java Batch ì„œë²„ ê°„ gRPC Streaming ì„¤ê³„**
3. **Embedding ë°ì´í„°ë¥¼ PostgreSQL(pgvector)ì— ì €ì¥í•˜ê³  ìºì‹±(ë©”ëª¨ë¦¬/Redis)ìœ¼ë¡œ ê³ ì†í™”**

ì¦‰, â€œ**ëŒ€ê·œëª¨ ë²¡í„° ê¸°ë°˜ ì¶”ì²œ ì‹œìŠ¤í…œì˜ íŒŒì´í”„ë¼ì¸ì„ ì‘ì€ ë‹¨ìœ„ë¡œ ì§ì ‘ êµ¬ì¶•í•´ë³´ëŠ” í”„ë¡œì íŠ¸**â€ì´ë‹¤.

ì°¸ê³ : êµ¬í˜„ ì‹œ `Demo-Python`ì€ â€œDemo-Python/data/*.pklâ€íŒŒì¼ì„ ìŠ¤íŠ¸ë¦¬ë° í˜•ì‹ìœ¼ë¡œ gRPCë¥¼ í†µí•´ ì „ë‹¬í•˜ëŠ” ê²ƒë§Œ êµ¬í˜„í•˜ë©´ ëœë‹¤

***.pkl íŒŒì¼ ìì²´ëŠ” ìš©ëŸ‰ì´ í¬ë¯€ë¡œ ì ˆëŒ€ ì§ì ‘ ì¡°íšŒí•´ì„  ì•ˆëœë‹¤.**

---

# 2. ì „ì²´ ì‹œìŠ¤í…œ êµ¬ì„± ìš”ì†Œ

| ê³„ì¸µ | êµ¬ì„± ìš”ì†Œ                                 | ì—­í•  |
| --- |---------------------------------------| --- |
| **Frontend** | Next.js(16.0.7),TypeScript, React Query     | GraphQL API ì†Œë¹„, ë°ì´í„° ìºì‹± |
| **Backend (API ì„œë²„)** | Spring WebFlux + GraphQL              | ì¡°íšŒ API ì œê³µ, ìºì‹± ê³„ì¸µ ê´€ë¦¬, AI ì„œë²„ì™€ gRPC ì—°ë™ |
| **AI Backend** | Python + PyTorch                      | Embedding ìƒì„± ë° ì¶”ì²œ ëª¨ë¸ ì¶”ë¡  |
| **Batch Server** | Spring Batch + gRPC Client            | Pythonì—ì„œ Embedding ìŠ¤íŠ¸ë¦¬ë° ìˆ˜ì‹  â†’ DB ì €ì¥ |
| **DB/Cache** | PostgreSQL + pgvector, Redis/Caffeine | Embedding ì €ì¥, ì¡°íšŒ ìºì‹± |

### ì‘ì—… ë””ë ‰í† ë¦¬

```java
Alpha-Match/
 â”œâ”€â”€ Frontend/         
 â”‚    â””â”€â”€ Front-Server/     # Next.js + React Query
 â”‚        â”œâ”€â”€ src/
 â”‚        â””â”€â”€ package.json
 â”‚
 â”œâ”€â”€ Backend/
 â”‚    â”œâ”€â”€ Api-Server/       # Spring WebFlux + Caffeine + PostgreSQL + PGVector
 â”‚    â”‚    â””â”€â”€ src/
 â”‚    â””â”€â”€ Batch-Server/     # Spring Batch + gRPC << í˜„ì¬ ìœ„ì¹˜
 â”‚         â””â”€â”€ src/
 â”‚
 â”œâ”€â”€ Demo-Python/          # python + gRPC
 â”‚    â”œâ”€â”€ src/
 â”‚    â””â”€â”€ data/       
 â”‚         â””â”€â”€ *.pkl
 â”‚
 â””â”€â”€ deploy/                # GitHub Actions, Redis.conf, Dockerfile ë“±
```

---

# 3. ì „ì²´ êµ¬ì¡°ë„

```arduino
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          í”„ë¡ íŠ¸ì—”ë“œ(Next.js)                 â”‚
â”‚  - React Query                                                â”‚
â”‚  - GraphQL Client                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                               â”‚ GraphQL
                â”‚                               â”‚ ìš”ì²­/ì‘ë‹µ
                â”‚                               â”‚
        (ì‚¬ìš©ì ìš”ì²­)                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ë°±ì—”ë“œ Face API ì„œë²„(Spring)              â”‚
â”‚  - WebFlux (Reactive)                                        â”‚
â”‚  - GraphQL API                                               â”‚
â”‚  - Redis/Caffeine ìºì‹±                                       â”‚
â”‚  - gRPC Client â†’ AI ì„œë²„ í˜¸ì¶œ                                â”‚
â”‚  - PostgreSQL ì¡°íšŒ(pgvector)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                      â”‚
                â”‚ gRPC                 â”‚ DB ì¡°íšŒ/ì €ì¥
                â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      AI ë°±ì—”ë“œ(PyTorch)  â”‚   â”‚        PostgreSQL + pgvector   â”‚
â”‚  - Embedding ìƒì„±         â”‚   â”‚  - ì‚¬ìš©ì ë²¡í„° / ê³µê³  ë²¡í„° ì €ì¥â”‚
â”‚  - ì¶”ì²œ ëª¨ë¸ ì¶”ë¡          â”‚   â”‚  - ìœ ì‚¬ë„ ê²€ìƒ‰                 â”‚
â”‚  - gRPC/REST ì œê³µ         â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚  ëª¨ë¸ ì—…ë°ì´íŠ¸
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ë°±ì—”ë“œ Batch ì„œë²„(Spring Batch)             â”‚
â”‚  - ì‹ ê·œ ë°ì´í„° ìˆ˜ì§‘                                          â”‚
â”‚  - embedding ì¬ê³„ì‚°                                          â”‚
â”‚  - DB ê°±ì‹  / ìºì‹œ ì´ˆê¸°í™” ìš”ì²­                                â”‚
â”‚  - AI ì„œë²„ ëª¨ë¸ ì—…ë°ì´íŠ¸ í†µì§€                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

**ìš”ì•½:**

- í”„ë¡ íŠ¸ëŠ” GraphQLì„ í†µí•´ í•„ìš”í•œ ë°ì´í„°ë§Œ ì¡°íšŒ
- API ì„œë²„ëŠ” ìºì‹œ â†’ DB ìˆœìœ¼ë¡œ ì¡°íšŒ
- AI ì„œë²„ëŠ” gRPCë¡œ ê³ ì† Embedding/ì¶”ì²œ ì²˜ë¦¬
- ë°°ì¹˜ ì„œë²„ëŠ” Pythonì—ì„œ Embedding(ìŠ¤íŠ¸ë¦¬ë°) ë°›ì•„ DB ì €ì¥

---

# 4. ì „ì²´ íë¦„ êµ¬ì¡°(End-to-End)

## 4.1 ë°ì´í„° ìƒì„± â†’ ì €ì¥ â†’ ì¡°íšŒ íë¦„

```mermaid
sequenceDiagram
    autonumber

    participant PY as Python AI Server
    participant BS as Batch Server
    participant DB as PostgreSQL(pgvector)
    participant API as API Server
    participant FE as Frontend

    PY->>BS: StreamEmbeddings(gRPC Streaming)
    BS->>DB: Upsert Vector Records
    BS->>API: Cache Invalidate Request

    FE->>API: GraphQL Query
    API->>API: Cache Lookup
    API->>DB: (Cache Miss) Vector Query
    API->>FE: Response

```

**ìš”ì•½ ì„¤ëª…:**

1. Pythonì€ `.pkl` ê¸°ë°˜ Embeddingì„ chunkë¡œ ë‚˜ëˆ  gRPC ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ ì „ì†¡
2. Batch ì„œë²„ëŠ” chunk ë‹¨ìœ„ë¡œ pgvectorì— ì €ì¥ + ì²´í¬í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
3. ì €ì¥ ì™„ë£Œ ì‹œ API ì„œë²„ì˜ ìºì‹œ ë¬´íš¨í™”
4. í”„ë¡ íŠ¸ëŠ” React Queryë¡œ GraphQL ìš”ì²­ â†’ ìºì‹œ ê¸°ë°˜ìœ¼ë¡œ ë¹ ë¥¸ ì‘ë‹µ ì œê³µ

---

# 5. ê° ì»´í¬ë„ŒíŠ¸ë³„ ì—­í•  ë° ì±…ì„

## 5.1 Frontend (Next.js + React Query)

- GraphQLë§Œ í˜¸ì¶œ
- í•„ìš”í•œ ë°ì´í„°ë§Œ ì„ íƒì ìœ¼ë¡œ ë°›ì•„ íš¨ìœ¨ì  ë Œë”ë§
- React Queryë¡œ ìºì‹±í•˜ì—¬ API í˜¸ì¶œ ìˆ˜ ìµœì†Œí™”

---

## 5.2 API ì„œë²„ (Spring WebFlux + GraphQL)

### ë‹´ë‹¹ ì—­í• 

- GraphQL Resolver â†’ Service â†’ Repository íë¦„ êµ¬ì„±
- ìºì‹± ê³„ì¸µ(Caffeine/Redis) í†µí•©
- AI Backendì™€ gRPCë¥¼ í†µí•œ Embedding/ì¶”ì²œ ì¡°íšŒ
- Batch ì„œë²„ ì™„ë£Œ ì´ë²¤íŠ¸ë¥¼ í†µí•œ ìºì‹œ ë¬´íš¨í™” ì²˜ë¦¬

### ê¸°ìˆ ì  í¬ì¸íŠ¸

- ë…¼ë¸”ë¡œí‚¹ ì„œë²„(WebFlux)ë¡œ ê³ ì„±ëŠ¥ ì²˜ë¦¬
- gRPC AsyncStub + Mono/Flux ë³€í™˜
- byte[] ê¸°ë°˜ ìºì‹± êµ¬ì¡° ì‹¤í—˜ (DB ê²°ê³¼ë¥¼ Binaryë¡œ ìºì‹±)
- ìºì‹œ ì´ˆê¸°í™” ì‹œ Monitor Lockìœ¼ë¡œ ë™ì‹œì„± ì œì–´

---

## 5.3 AI Backend (Python + PyTorch)

### ì—­í• 

- Embedding ìƒì„±/ì¶”ë¡  ëª¨ë¸ ë³´ìœ 
- gRPC ì„œë²„ë¡œì„œ EmbeddingChunk ìŠ¤íŠ¸ë¦¬ë° ì œê³µ
- API ì„œë²„ì˜ ì¶”ì²œ ìš”ì²­ ì²˜ë¦¬

### ê¸°ìˆ ì  í¬ì¸íŠ¸

- `.pkl` â†’ pandas DataFrame â†’ Chunk ë¶„ë¦¬
- gRPC server-streaming
- Embedding vector(list<float>) ì§ë ¬í™”

---

## 5.4 Batch Server (Spring Batch + gRPC Client)

### ì—­í• 

- Pythonìœ¼ë¡œë¶€í„° EmbeddingChunk ìŠ¤íŠ¸ë¦¬ë° ìˆ˜ì‹ 
- pgvector í…Œì´ë¸”ì— upsert
- ì²´í¬í¬ì¸íŠ¸(Since ID) ê¸°ë°˜ ì¬ì‹œì‘/ë³µêµ¬
- ìºì‹œ ë¬´íš¨í™” ìš”ì²­(API ì„œë²„ í˜¸ì¶œ)

### ê¸°ìˆ ì  í¬ì¸íŠ¸

- gRPC server-streaming â†’ Reactor Fluxë¡œ ë³€í™˜
- blocking DB I/Oë¥¼ boundedElasticì— ë¶„ë¦¬
- chunk ë‹¨ìœ„ ë³‘ë ¬ upsertë¡œ ëŒ€ê·œëª¨ ë²¡í„° ì²˜ë¦¬
- pgvector ì €ì¥ ì‹œ PGobject(vector) ì‚¬ìš©

---

## 5.5 Database Layer (PostgreSQL + pgvector / Redis)

### PostgreSQL(pgvector)

- Embedding ì €ì¥
- `<->` ì—°ì‚°ìë¥¼ í†µí•œ ìœ ì‚¬ë„ ê²€ìƒ‰
- ivfflat ì¸ë±ìŠ¤ íŠœë‹ ê°€ëŠ¥

### Redis/Caffeine

- ìºì‹± ë ˆì´ì–´
- byte[] ê¸°ë°˜ ì €ì¥ìœ¼ë¡œ ì§ë ¬í™” ë¹„ìš© ì ˆê°
- ìºì‹œ ë§Œë£Œ/ì´ˆê¸°í™” ì‹œ Race Condition ì œì–´

---

# 6. ì£¼ìš” ì²˜ë¦¬ í”Œë¡œìš°(í•µì‹¬ë§Œ ìš”ì•½)

## 6.1 Embedding ì ì¬ í”Œë¡œìš°

```mermaid
flowchart TD
    A["Python<br>Load pkl â†’ Chunk"] --> B["gRPC Streaming<br>EmbeddingChunk"]
    B --> C["Batch Server<br>Chunk Upsert"]
    C --> D["Postgres(pgvector) ì €ì¥"]
    D --> E["API Server ìºì‹œ ì´ˆê¸°í™”"]

```

---

## 6.2 GraphQL ì¡°íšŒ í”Œë¡œìš°

```mermaid
flowchart TD
    F["Frontend<br>GraphQL Query"] --> B["API ì„œë²„"]

    B --> C["Caffeine/Redis Cache"]
    C -->|Hit| F2["Result Return"]

    C -->|Miss| D["DB ì¡°íšŒ(pgvector)"]
    D --> B
    B --> F2["Response to FE"]

```

---

# 7. ì˜ˆì™¸ ì²˜ë¦¬ ë° ì¥ì•  ëŒ€ì‘ ì„¤ê³„

## 7.1 ìŠ¤íŠ¸ë¦¬ë° ì¤‘ë‹¨ ì‹œ

- ì²´í¬í¬ì¸íŠ¸(`last_id`) ì €ì¥
- ì¬ì‹œì‘ ì‹œ `since_id`ë¶€í„° ì¬ìš”ì²­
- ë™ì¼ idëŠ” upsertì´ë¯€ë¡œ ì¬ì²˜ë¦¬ ì•ˆì „

## 7.2 ìºì‹œ ì´ˆê¸°í™” ë™ì‹œì„±

- Monitor Lock ë˜ëŠ” AtomicBoolean + synchronized
- ë™ì‹œì— ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ìºì‹œ ì´ˆê¸°í™”ë¥¼ í˜¸ì¶œí•˜ì§€ ëª»í•˜ê²Œ ë³´í˜¸

## 7.3 DB ë²¡í„° ì‚½ì… ì˜¤ë¥˜

- vector dimension mismatch ì²´í¬
- invalid float ë°œìƒ ì‹œ ë³„ë„ DLQ í…Œì´ë¸”ë¡œ ê¸°ë¡

---

# 8. ì„±ëŠ¥/í™•ì¥ì„± ê³ ë ¤ì‚¬í•­

- DB upsert bulk ì²˜ë¦¬(100~2000 rows per chunk)
- gRPC ë©”ì‹œì§€ í¬ê¸° ìƒí•œ ì¡°ì •
- WebFlux â†’ DB ì ‘ê·¼ì€ boundedElastic Pool ë¶„ë¦¬
- Redis í™•ì¥ ì‹œ read/write throughput ì¦ê°€
- ì¶”ì²œ ëª¨ë¸ ì¶”ë¡ ì€ Python ì„œë²„ì—ì„œ ì „ë‹´

---

# 9. íŒ€(MCP)ë³„ ì•¡ì…˜ í¬ì¸íŠ¸

| íŒ€ | í•´ì•¼ í•  ì¼ |
| --- | --- |
| **Frontend** | GraphQL ìŠ¤í‚¤ë§ˆ ê¸°ë°˜ ë°ì´í„° ì†Œë¹„ / React Query ìºì‹± ì „ëµ |
| **API ë°±ì—”ë“œ** | Resolver â†’ Service â†’ Cache â†’ DB êµ¬ì¡° êµ¬ì¶• / gRPC í´ë¼ì´ì–¸íŠ¸ ì‘ì„± |
| **AI íŒ€** | pkl â†’ chunk stream ì„œë²„ êµ¬í˜„ / Embedding ìƒì„±Â·ì¶”ë¡  ëª¨ë¸ ê´€ë¦¬ |
| **Batch íŒ€** | Embedding stream ì†Œë¹„ ë° upsert / checkpoint ë° ì¬ì‹œì‘ ì²˜ë¦¬ |
| **Infra íŒ€** | Postgres(pgvector) + Redis + ì„œë¹„ìŠ¤ ë„¤íŠ¸ì›Œí¬ êµ¬ì„± / gRPC ì„¤ì • |

---