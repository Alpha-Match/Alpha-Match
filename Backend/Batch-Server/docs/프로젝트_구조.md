# ğŸ“‚ Batch Server í”„ë¡œì íŠ¸ êµ¬ì¡°

**ì‘ì„±ì¼:** 2025-12-10
**ì—…ë°ì´íŠ¸:** 2025-12-10

---

## ì „ì²´ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
Backend/Batch-Server/
â”œâ”€â”€ src/main/
â”‚   â”œâ”€â”€ java/com/alpha/backend/
â”‚   â”‚   â”œâ”€â”€ config/                    # ì„¤ì • í´ë˜ìŠ¤
â”‚   â”‚   â”‚   â”œâ”€â”€ BatchProperties.java   # ë°°ì¹˜ ì„¤ì • í”„ë¡œí¼í‹°
â”‚   â”‚   â”‚   â”œâ”€â”€ ExecutorConfig.java    # Virtual Thread Executor
â”‚   â”‚   â”‚   â””â”€â”€ GrpcClientConfig.java  # gRPC ì±„ë„ ì„¤ì •
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ grpc/                      # gRPC í†µì‹  ê³„ì¸µ
â”‚   â”‚   â”‚   â”œâ”€â”€ EmbeddingGrpcClient.java        # Python ì„œë²„ í´ë¼ì´ì–¸íŠ¸
â”‚   â”‚   â”‚   â””â”€â”€ CacheInvalidateGrpcClient.java  # API ì„œë²„ í´ë¼ì´ì–¸íŠ¸
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ domain/                    # ë„ë©”ì¸ ê³„ì¸µ
â”‚   â”‚   â”‚   â”œâ”€â”€ metadata/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MetadataEntity.java        # ë©”íƒ€ë°ì´í„° ì—”í‹°í‹°
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ MetadataRepository.java    # Upsert í¬í•¨
â”‚   â”‚   â”‚   â”œâ”€â”€ embedding/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EmbeddingEntity.java       # Vector ì—”í‹°í‹°
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ EmbeddingRepository.java   # pgvector ì²˜ë¦¬
â”‚   â”‚   â”‚   â””â”€â”€ dlq/
â”‚   â”‚   â”‚       â”œâ”€â”€ DlqEntity.java             # Dead Letter Queue
â”‚   â”‚   â”‚       â””â”€â”€ DlqRepository.java
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ infrastructure/            # ì¸í”„ë¼ ê³„ì¸µ
â”‚   â”‚   â”‚   â”œâ”€â”€ CheckpointEntity.java
â”‚   â”‚   â”‚   â””â”€â”€ CheckpointRepository.java      # ì²´í¬í¬ì¸íŠ¸ ê´€ë¦¬
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ application/               # ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤
â”‚   â”‚   â”‚   â”œâ”€â”€ StreamingService.java          # gRPC Stream ìˆ˜ì‹ 
â”‚   â”‚   â”‚   â”œâ”€â”€ ChunkProcessor.java            # Chunk ì²˜ë¦¬
â”‚   â”‚   â”‚   â””â”€â”€ CacheSyncService.java          # ìºì‹œ ë™ê¸°í™”
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ batch/                     # Spring Batch êµ¬ì„±
â”‚   â”‚   â”‚   â”œâ”€â”€ job/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ EmbeddingBatchJob.java
â”‚   â”‚   â”‚   â”œâ”€â”€ step/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ReceiveStep.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProcessStep.java
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ NotifyStep.java
â”‚   â”‚   â”‚   â””â”€â”€ listener/
â”‚   â”‚   â”‚       â”œâ”€â”€ JobListener.java
â”‚   â”‚   â”‚       â””â”€â”€ StepListener.java
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ scheduler/                 # ìŠ¤ì¼€ì¤„ëŸ¬
â”‚   â”‚   â”‚   â””â”€â”€ BatchScheduler.java
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ BatchApplication.java      # Main í´ë˜ìŠ¤
â”‚   â”‚
â”‚   â”œâ”€â”€ resources/
â”‚   â”‚   â”œâ”€â”€ application.yml            # ì„¤ì • íŒŒì¼
â”‚   â”‚   â”œâ”€â”€ db/migration/              # Flyway ë§ˆì´ê·¸ë ˆì´ì…˜
â”‚   â”‚   â”‚   â””â”€â”€ V1__init_schema.sql
â”‚   â”‚   â””â”€â”€ logback-spring.xml         # ë¡œê¹… ì„¤ì •
â”‚   â”‚
â”‚   â””â”€â”€ proto/                         # Proto íŒŒì¼
â”‚       â”œâ”€â”€ embedding_stream.proto
â”‚       â””â”€â”€ cache_service.proto
â”‚
â”œâ”€â”€ src/test/                          # í…ŒìŠ¤íŠ¸
â”‚   â””â”€â”€ java/com/alpha/backend/
â”‚
â”œâ”€â”€ docs/                              # ë¬¸ì„œ
â”‚   â”œâ”€â”€ Batchì„¤ê³„ì„œ.md                 # ì „ì²´ ì„¤ê³„ ë¬¸ì„œ
â”‚   â”œâ”€â”€ Entire_Structure.md            # í”„ë¡œì íŠ¸ ì „ì²´ êµ¬ì¡°
â”‚   â”œâ”€â”€ í”„ë¡œì íŠ¸_êµ¬ì¡°.md               # í˜„ì¬ ë¬¸ì„œ
â”‚   â”œâ”€â”€ DB_ìŠ¤í‚¤ë§ˆ.md
â”‚   â”œâ”€â”€ gRPC_í†µì‹ _ê°€ì´ë“œ.md
â”‚   â”œâ”€â”€ Reactive_Blocking_í˜¼í•©ì „ëµ.md
â”‚   â””â”€â”€ ë™ì‹œì„±_ì œì–´.md
â”‚
â”œâ”€â”€ build.gradle                       # ë¹Œë“œ ì„¤ì •
â”œâ”€â”€ settings.gradle
â””â”€â”€ CLAUDE.md                          # í”„ë¡œì íŠ¸ ê°€ì´ë“œ

```

---

## íŒ¨í‚¤ì§€ë³„ ìƒì„¸ ì„¤ëª…

### 1. config/ - ì„¤ì • í´ë˜ìŠ¤

#### BatchProperties.java
```java
@ConfigurationProperties(prefix = "batch.embedding")
```
- application.ymlì˜ ë°°ì¹˜ ì„¤ì • ë§¤í•‘
- chunk-size, vector-dimension, max-retry ë“± ê´€ë¦¬

#### ExecutorConfig.java
```java
@Bean(name = "virtualThreadExecutor")
```
- Virtual Thread Executor ìƒì„±
- JPA Scheduler (Blocking I/Oìš©)
- Bounded Elastic Scheduler (DB Connection Pool ê´€ë¦¬)

#### GrpcClientConfig.java
```java
@Bean(name = "pythonEmbeddingChannel")
@Bean(name = "apiCacheChannel")
```
- Python AI Server ì—°ê²°ìš© gRPC ì±„ë„
- API Server ì—°ê²°ìš© gRPC ì±„ë„

---

### 2. grpc/ - gRPC í†µì‹  ê³„ì¸µ

#### EmbeddingGrpcClient.java
- **ì—­í• :** Python AI Serverë¡œë¶€í„° Embedding Stream ìˆ˜ì‹ 
- **ì£¼ìš” ë©”ì„œë“œ:**
  - `streamEmbeddings(UUID lastProcessedUuid, int chunkSize)`: Flux<RowChunk> ë°˜í™˜
  - Reactive Sinkë¥¼ ì‚¬ìš©í•˜ì—¬ Backpressure ì§€ì›

#### CacheInvalidateGrpcClient.java
- **ì—­í• :** API Serverì— ìºì‹œ ë¬´íš¨í™” ìš”ì²­
- **ì£¼ìš” ë©”ì„œë“œ:**
  - `invalidateCache(String target)`: Mono<Boolean> ë°˜í™˜
  - `invalidateSafely(String target)`: ë™ì‹œì„± ì œì–´ í¬í•¨
- **íŠ¹ì§•:** AtomicBooleanìœ¼ë¡œ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€

---

### 3. domain/ - ë„ë©”ì¸ ê³„ì¸µ

#### metadata/
- **MetadataEntity:** recruit_metadata í…Œì´ë¸” ë§¤í•‘
- **MetadataRepository:** Upsert ì¿¼ë¦¬ í¬í•¨
  ```java
  @Query(value = "INSERT INTO recruit_metadata (...) ON CONFLICT (id) DO UPDATE ...")
  void upsert(@Param("entity") MetadataEntity entity);
  ```

#### embedding/
- **EmbeddingEntity:** recruit_embedding í…Œì´ë¸” ë§¤í•‘
  - PGvector íƒ€ì… ì‚¬ìš©
  - `fromFloatArray()`, `toFloatArray()` ë³€í™˜ ë©”ì„œë“œ
- **EmbeddingRepository:**
  - Upsert ì¿¼ë¦¬
  - Vector Similarity Search (L2 distance)

#### dlq/
- **DlqEntity:** ì‹¤íŒ¨í•œ ë ˆì½”ë“œ ì €ì¥
- **DlqRepository:** ì¬ì²˜ë¦¬ ëŒ€ìƒ ì¡°íšŒ

---

### 4. infrastructure/ - ì¸í”„ë¼ ê³„ì¸µ

#### CheckpointEntity / CheckpointRepository
- **ì—­í• :** ë§ˆì§€ë§‰ ì²˜ë¦¬ëœ UUID ê´€ë¦¬
- **ì£¼ìš” ë©”ì„œë“œ:**
  - `findLatest()`: ìµœì‹  ì²´í¬í¬ì¸íŠ¸ ì¡°íšŒ
  - `updateLatestCheckpoint(UUID uuid)`: ì²´í¬í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
  - `findLastProcessedUuid()`: ë§ˆì§€ë§‰ UUID ë°˜í™˜

---

### 5. application/ - ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤ (êµ¬í˜„ ì˜ˆì •)

#### StreamingService.java
- **ì—­í• :** gRPC Stream ìˆ˜ì‹  ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜
- **íë¦„:**
  1. Checkpoint ì¡°íšŒ
  2. EmbeddingGrpcClient í˜¸ì¶œ
  3. ChunkProcessorì—ê²Œ ìœ„ì„

#### ChunkProcessor.java
- **ì—­í• :** Chunk ë‹¨ìœ„ ë°ì´í„° ì²˜ë¦¬
- **ì‘ì—…:**
  1. RowChunk â†’ Metadata/Embedding ë¶„ë¦¬
  2. Repositoryë¥¼ í†µí•´ Upsert
  3. DLQ ì²˜ë¦¬ (ì‹¤íŒ¨ ì‹œ)
  4. Checkpoint ì—…ë°ì´íŠ¸

#### CacheSyncService.java
- **ì—­í• :** ìºì‹œ ë™ê¸°í™”
- **ì‘ì—…:**
  1. ëª¨ë“  Chunk ì²˜ë¦¬ ì™„ë£Œ í›„ í˜¸ì¶œ
  2. CacheInvalidateGrpcClient í˜¸ì¶œ
  3. ì¬ì‹œë„ ë¡œì§ í¬í•¨

---

### 6. batch/ - Spring Batch êµ¬ì„± (êµ¬í˜„ ì˜ˆì •)

#### job/EmbeddingBatchJob.java
- **Job ì •ì˜:** Embedding ì²˜ë¦¬ ì „ì²´ í”Œë¡œìš°
- **Step ìˆœì„œ:**
  1. ReceiveStep: Stream ìˆ˜ì‹ 
  2. ProcessStep: ë°ì´í„° ì²˜ë¦¬
  3. NotifyStep: ìºì‹œ ë¬´íš¨í™”

#### step/
ê° Stepì˜ êµ¬ì²´ì ì¸ êµ¬í˜„

#### listener/
- **JobListener:** Job ì‹œì‘/ì¢…ë£Œ ë¡œê¹…
- **StepListener:** Step ì‹œì‘/ì¢…ë£Œ, ì—ëŸ¬ ì²˜ë¦¬

---

### 7. scheduler/ - ìŠ¤ì¼€ì¤„ëŸ¬ (êµ¬í˜„ ì˜ˆì •)

#### BatchScheduler.java
```java
@Scheduled(cron = "${batch.scheduler.cron}")
```
- **ì—­í• :** ì£¼ê¸°ì  ë°°ì¹˜ ì‹¤í–‰
- **ê¸°ë³¸ ì„¤ì •:** ë§¤ì¼ ìƒˆë²½ 2ì‹œ
- **ì¶”ê°€ ê¸°ëŠ¥:** ìˆ˜ë™ ì‹¤í–‰ API

---

## íŒŒì¼ ìœ„ì¹˜ ì°¸ì¡°

### Proto íŒŒì¼
- **ìœ„ì¹˜:** `src/main/proto/`
- **ì»´íŒŒì¼ ê²°ê³¼:** `build/generated/source/proto/main/`

### DB Migration
- **ìœ„ì¹˜:** `src/main/resources/db/migration/`
- **Flyway ìë™ ì‹¤í–‰**

### ì„¤ì • íŒŒì¼
- **application.yml:** `src/main/resources/application.yml`
- **Logback:** `src/main/resources/logback-spring.xml`

---

## ì½”ë“œ ì»¨ë²¤ì…˜

### íŒ¨í‚¤ì§€ ë„¤ì´ë°
- `config`: ì„¤ì • í´ë˜ìŠ¤ (`@Configuration`, `@Bean`)
- `grpc`: gRPC í†µì‹  (`Client`, `Service`)
- `domain`: ë„ë©”ì¸ ëª¨ë¸ (`Entity`, `Repository`)
- `application`: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (`Service`)
- `batch`: Spring Batch êµ¬ì„±
- `scheduler`: ìŠ¤ì¼€ì¤„ ì‘ì—…

### í´ë˜ìŠ¤ ë„¤ì´ë°
- **Entity:** `~Entity` (ì˜ˆ: MetadataEntity)
- **Repository:** `~Repository`
- **Service:** `~Service`
- **Client:** `~GrpcClient`
- **Config:** `~Config`

### ë©”ì„œë“œ ë„¤ì´ë°
- **ì¡°íšŒ:** `find~`, `get~`
- **ì €ì¥:** `save~`, `upsert~`
- **ì—…ë°ì´íŠ¸:** `update~`
- **ì‚­ì œ:** `delete~`

---

## ê´€ë ¨ ë¬¸ì„œ
- [DB ìŠ¤í‚¤ë§ˆ](./DB_ìŠ¤í‚¤ë§ˆ.md)
- [gRPC í†µì‹  ê°€ì´ë“œ](./gRPC_í†µì‹ _ê°€ì´ë“œ.md)
- [Batch ì„¤ê³„ì„œ](./Batchì„¤ê³„ì„œ.md)
