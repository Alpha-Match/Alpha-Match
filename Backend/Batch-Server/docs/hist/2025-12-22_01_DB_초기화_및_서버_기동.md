# 2025-12-22: DB ì´ˆê¸°í™” ë° Batch Server ê¸°ë™

## ğŸ“‹ ì‘ì—… ê°œìš”

v2 ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ DB ì´ˆê¸°í™” ë° Batch Server ê¸°ë™ ì‘ì—… ìˆ˜í–‰

## ğŸ¯ ëª©í‘œ

- PostgreSQL DB ì´ˆê¸°í™” (alpha_match)
- Flyway V1, V2 ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- Batch Server ì„±ê³µì  ê¸°ë™
- Pattern 2 (Client Streaming) ì¤€ë¹„ ì™„ë£Œ

## ğŸ”§ ì‘ì—… ë‚´ìš©

### 1. DB ì—°ê²° ë° ì¸ì¦ ë¬¸ì œ í•´ê²°

**ë¬¸ì œ:**
- ì´ˆê¸° DB ì ‘ì† ì‹¤íŒ¨ (password authentication failed)

**í•´ê²°:**
- `application.yml`ì— ì •í™•í•œ ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (`season@heaven!2`)
- HikariCP ì—°ê²° í’€ ì •ìƒ ì‘ë™ í™•ì¸

### 2. DB ì´ˆê¸°í™” ë° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

**ë¬¸ì œ:**
- Flyway auto-migrationì´ Bean ì´ˆê¸°í™” ì „ì— ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
- `relation "checkpoint" does not exist` ì˜¤ë¥˜ ë°œìƒ

**í•´ê²°:**
- `reset_db.sql` ìƒì„±: DB drop/create + pgvector ì„¤ì¹˜
- `reset_db.bat` ìƒì„±: Windows í™˜ê²½ ìŠ¤í¬ë¦½íŠ¸
- `run_migrations.bat` ìƒì„±: V1, V2 ìˆ˜ë™ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- ì„±ê³µì ìœ¼ë¡œ ëª¨ë“  í…Œì´ë¸” ìƒì„± ì™„ë£Œ

**ìƒì„±ëœ íŒŒì¼:**
```batch
# reset_db.bat
@echo off
set PGPASSWORD=season@heaven!2
psql -h localhost -p 5433 -U postgres -d postgres -f reset_db.sql

# run_migrations.bat
@echo off
set PGPASSWORD=season@heaven!2
psql -h localhost -p 5433 -U postgres -d alpha_match -f src/main/resources/db/migration/V1__init_database_schema.sql
psql -h localhost -p 5433 -U postgres -d alpha_match -f src/main/resources/db/migration/V2__restructure_schema_to_v2.sql
```

### 3. Quartz Scheduler ì„¤ì • ë¬¸ì œ í•´ê²°

**ë¬¸ì œ:**
- `org.quartz.SchedulerConfigException: DataSource name not set`
- Spring Boot 4.0ì—ì„œ QuartzProperties, @QuartzDataSource ë¯¸ì§€ì›

**ì‹œë„í•œ í•´ê²° ë°©ë²•:**
1. âŒ Quartz DataSource ëª…ì‹œì  ì„¤ì • (org.quartz.dataSource.* í”„ë¡œí¼í‹°)
2. âŒ QuartzConfig.java ìƒì„± (SchedulerFactoryBean with DataSource)
3. âŒ Spring Boot auto-configuration í™œìš©

**ìµœì¢… í•´ê²°:**
- Pattern 1 (Server Streaming with Scheduler)ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìœ¼ë¯€ë¡œ Quartz ì „ì²´ ë¹„í™œì„±í™”
- `application.yml`ì—ì„œ `quartz.auto-startup: false` ì„¤ì •
- QuartzConfig.java ì‚­ì œ
- RAMJobStore ì‚¬ìš© (JDBC JobStore ëŒ€ì‹ )

**ë³€ê²½ ì‚¬í•­ (`application.yml`):**
```yaml
# ê¸°ì¡´ (ë³µì¡í•œ JDBC JobStore ì„¤ì •)
quartz:
  job-store-type: jdbc
  properties:
    org.quartz.jobStore.class: org.quartz.impl.jdbcjobstore.JobStoreTX
    org.quartz.jobStore.dataSource: quartzDataSource
    # ... ë§ì€ ì„¤ì •

# ë³€ê²½ í›„ (ê°„ì†Œí™”)
quartz:
  auto-startup: false  # Quartz ìë™ ì‹œì‘ ë¹„í™œì„±í™”
```

### 4. Batch Server ê¸°ë™ ì„±ê³µ

**ìµœì¢… ê²°ê³¼:**
```
2025-12-22T16:25:14.866+09:00  INFO 21664 --- [batch-service] [           main]
com.alpha.backend.BatchApplication : Started BatchApplication in 9.849 seconds
```

**í™•ì¸ ì‚¬í•­:**
- âœ… HikariPool-1 started (DB ì—°ê²° ì„±ê³µ)
- âœ… JPA EntityManagerFactory initialized
- âœ… 14 JPA repositories found
- âœ… DataProcessorFactory: 2 processors registered (candidate, recruit)
- âœ… gRPC Server: Port 9090 (IngestDataStream ìˆ˜ì‹  ëŒ€ê¸°)
- âœ… WebFlux Server: Port 8080
- âœ… Quartz Scheduler: Standby mode (jobs disabled)

## ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ

### ìƒì„±ëœ í…Œì´ë¸” (v2 ìŠ¤í‚¤ë§ˆ)

**Recruit ë„ë©”ì¸ (4 tables):**
- `recruit` (ë©”íƒ€ë°ì´í„°)
- `recruit_description` (ì„¤ëª… í…ìŠ¤íŠ¸)
- `recruit_skill` (ìŠ¤í‚¬ ë§¤í•‘)
- `recruit_skills_embedding` (384d ë²¡í„°)

**Candidate ë„ë©”ì¸ (4 tables):**
- `candidate` (ë©”íƒ€ë°ì´í„°)
- `candidate_description` (ì„¤ëª… í…ìŠ¤íŠ¸)
- `candidate_skill` (ìŠ¤í‚¬ ë§¤í•‘)
- `candidate_skills_embedding` (384d ë²¡í„°)

**Skill Dictionary (2 tables):**
- `skill_category_dic` (ì¹´í…Œê³ ë¦¬)
- `skill_embedding_dic` (ìŠ¤í‚¬ ì„ë² ë”©)

**ê³µí†µ (2 tables):**
- `checkpoint` (ì²´í¬í¬ì¸íŠ¸)
- `dlq` (Dead Letter Queue)

**Quartz (11 tables):**
- `qrtz_*` (ìŠ¤ì¼€ì¤„ëŸ¬ ë©”íƒ€ë°ì´í„°, í˜„ì¬ ë¯¸ì‚¬ìš©)

### ë²¡í„° ì¸ë±ìŠ¤

ivfflat ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ:
- `recruit_skills_embedding` (vector(384))
- `candidate_skills_embedding` (vector(384))
- `skill_embedding_dic` (vector(384))

## ğŸ”„ ì•„í‚¤í…ì²˜ ê²°ì • ì‚¬í•­

### Pattern 1 vs Pattern 2

**Pattern 1 (Server Streaming):**
- Batch Server â†’ Python Server ìš”ì²­
- Quartz Scheduler ê¸°ë°˜ ì •ê¸° ì‹¤í–‰
- **í˜„ì¬ ë¹„í™œì„±í™”** (`batch.scheduler.jobs.*.enabled: false`)

**Pattern 2 (Client Streaming):**
- Python Server â†’ Batch Server ì „ì†¡
- FastAPI ì—”ë“œí¬ì¸íŠ¸ íŠ¸ë¦¬ê±° ì‹œ ì¦‰ì‹œ ì‹¤í–‰
- **í˜„ì¬ í™œì„±í™”** (gRPC Server í¬íŠ¸ 9090 ëŒ€ê¸° ì¤‘)

### Quartz ë¹„í™œì„±í™” ì´ìœ 

1. Pattern 1ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆì–´ ìŠ¤ì¼€ì¤„ëŸ¬ ë¶ˆí•„ìš”
2. Pattern 2ë§Œ ì‚¬ìš©í•˜ëŠ” í˜„ì¬ ì „ëµì—ì„œëŠ” Quartz JDBC JobStore ì„¤ì • ë¶ˆí•„ìš”
3. Spring Boot 4.0 í˜¸í™˜ì„± ë¬¸ì œ í•´ê²°
4. ì‹œìŠ¤í…œ ë³µì¡ë„ ê°ì†Œ

## ğŸ“ ìƒì„±/ìˆ˜ì •ëœ íŒŒì¼

### ì‹ ê·œ ìƒì„±
1. `Backend/Batch-Server/reset_db.sql` - DB ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸
2. `Backend/Batch-Server/reset_db.bat` - DB ì´ˆê¸°í™” ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
3. `Backend/Batch-Server/run_migrations.bat` - ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
4. `Backend/Batch-Server/check_tables.sql` - í…Œì´ë¸” í™•ì¸ ìŠ¤í¬ë¦½íŠ¸

### ìˆ˜ì •ë¨
1. `Backend/Batch-Server/src/main/resources/application.yml`
   - DB ë¹„ë°€ë²ˆí˜¸ ìˆ˜ì • (`season@heaven!2`)
   - Quartz ì„¤ì • ê°„ì†Œí™” (`auto-startup: false`)

### ì‚­ì œë¨
1. `Backend/Batch-Server/src/main/java/com/alpha/backend/config/quartz/QuartzConfig.java`
   - Quartz ë¹„í™œì„±í™”ë¡œ ë¶ˆí•„ìš”

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

### ì¦‰ì‹œ ê°€ëŠ¥
1. âœ… Python Server ì‹¤í–‰ (Demo-Python/src/grpc_server.py)
2. âœ… FastAPI ì—”ë“œí¬ì¸íŠ¸ë¡œ ë°ì´í„° ì „ì†¡ íŠ¸ë¦¬ê±°
3. âœ… Batch Server gRPC ìˆ˜ì‹  â†’ DB ì €ì¥ í…ŒìŠ¤íŠ¸

### í–¥í›„ ì‘ì—…
1. â³ Batch Job v2 ë§ˆì´ê·¸ë ˆì´ì…˜ (Reader, Processor, Writer - 4-table êµ¬ì¡°)
2. â³ Proto íŒŒì¼ v2 ì—…ë°ì´íŠ¸
3. â³ í†µí•© í…ŒìŠ¤íŠ¸ ë° ì„±ëŠ¥ ì¸¡ì •

## ğŸ’¡ êµí›ˆ

### Flyway vs Manual Migration

**ë¬¸ì œ:**
- Spring Boot ì´ˆê¸°í™” ìˆœì„œ: Bean Factory â†’ Flyway Migration
- Bean ìƒì„± ì‹œ DB ì¡°íšŒ â†’ í…Œì´ë¸” ì—†ìŒ ì˜¤ë¥˜

**í•´ê²° ì˜µì…˜:**
1. `@DependsOn("flyway")` ì‚¬ìš© (ë³µì¡ë„ ì¦ê°€)
2. Lazy initialization (ì¼ë¶€ ê¸°ëŠ¥ë§Œ í•´ê²°)
3. **ìˆ˜ë™ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸** (ì„ íƒë¨ - ëª…í™•í•˜ê³  ì œì–´ ê°€ëŠ¥)

### Spring Boot 4.0 Quartz í†µí•©

- QuartzProperties, @QuartzDataSource ê°™ì€ í¸ì˜ ê¸°ëŠ¥ ì œê±°ë¨
- JDBC JobStore ì„¤ì • ì‹œ ìˆ˜ë™ DataSource ì—°ê²° í•„ìš”
- ë¶ˆí•„ìš”í•œ ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”í•˜ëŠ” ê²ƒì´ ìµœì„ 

## ğŸ“Š ì‹œìŠ¤í…œ í˜„í™©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL 15.15   â”‚  â† DB ì´ˆê¸°í™” ì™„ë£Œ, v2 ìŠ¤í‚¤ë§ˆ ì ìš©
â”‚  Port: 5433         â”‚
â”‚  DB: alpha_match    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†‘
          â”‚ JDBC (HikariCP)
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Batch Server       â”‚  â† ê¸°ë™ ì™„ë£Œ
â”‚  Port 8080 (HTTP)   â”‚
â”‚  Port 9090 (gRPC)   â”‚  â† Pattern 2 ëŒ€ê¸° ì¤‘
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†‘
          â”‚ gRPC Client Streaming
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Python Server      â”‚  â† ì¤€ë¹„ ì™„ë£Œ (ì‹¤í–‰ ëŒ€ê¸°)
â”‚  Port 50051         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… ê²€ì¦ ì™„ë£Œ

- [x] DB ì—°ê²° ì„±ê³µ
- [x] ëª¨ë“  í…Œì´ë¸” ìƒì„±
- [x] JPA Entity ë§¤í•‘ ì„±ê³µ
- [x] gRPC Server ì‹œì‘
- [x] DataProcessor ë“±ë¡
- [x] Batch Job ì„¤ì • ë¡œë“œ

---

**ì‘ì—… ì‹œê°„:** ì•½ 2ì‹œê°„
**ì£¼ìš” ì´ìŠˆ:** Quartz JDBC JobStore ì„¤ì • ë¬¸ì œ
**í•´ê²° ë°©ë²•:** Pattern 2 ì „ìš© êµ¬ì„±ìœ¼ë¡œ ì „í™˜, Quartz ë¹„í™œì„±í™”
