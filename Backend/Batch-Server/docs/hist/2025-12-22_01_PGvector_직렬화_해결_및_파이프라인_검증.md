# 2025-12-22 PGvector ì§ë ¬í™” ë¬¸ì œ í•´ê²° ë° End-to-End íŒŒì´í”„ë¼ì¸ ê²€ì¦

**ì‘ì—… ì¼ì:** 2025-12-22
**ì‘ì—…ì:** Claude (AI Assistant)
**ê´€ë ¨ ë¸Œëœì¹˜:** feat/batch-pipeline-core

---

## ğŸ“‹ ì‘ì—… ê°œìš”

Python ì„œë²„ì—ì„œ Java Batch ì„œë²„ë¡œ gRPCë¥¼ í†µí•´ ì „ì†¡ëœ Vector Embedding ë°ì´í„°ë¥¼ PostgreSQLì— ì €ì¥í•˜ëŠ” ê³¼ì •ì—ì„œ ë°œìƒí•œ **PGvector ì§ë ¬í™” ë¬¸ì œë¥¼ í•´ê²°**í•˜ê³ , **End-to-End ë°ì´í„° íŒŒì´í”„ë¼ì¸ì˜ ì™„ì „í•œ ë™ì‘ì„ ê²€ì¦**í–ˆìŠµë‹ˆë‹¤.

---

## ğŸ› ë°œê²¬ëœ ë¬¸ì œ

### 1. PGvector â†’ PostgreSQL Vector íƒ€ì… ë³€í™˜ ì˜¤ë¥˜

**ì¦ìƒ:**
```
org.postgresql.util.PSQLException: ì˜¤ë¥˜: bytea ìë£Œí˜•ì„ vector ìë£Œí˜•ìœ¼ë¡œ ë³€í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
Position: 164
```

**ì›ì¸:**
- Hibernateê°€ `PGvector` ê°ì²´ë¥¼ PostgreSQL `bytea` (binary) íƒ€ì…ìœ¼ë¡œ ì§ë ¬í™”
- Native Queryì—ì„œ `CAST(:#{#entity.skillsVector} AS vector(384))` ì‚¬ìš© ì‹œ, ì´ë¯¸ byteaë¡œ ë°”ì¸ë”©ëœ í›„ CAST ì‹œë„
- PostgreSQLì´ bytea â†’ vector íƒ€ì… ë³€í™˜ì„ ì§€ì›í•˜ì§€ ì•ŠìŒ

**ì˜í–¥ ë²”ìœ„:**
- `recruit_skills_embedding` í…Œì´ë¸” insert ì‹¤íŒ¨
- `candidate_skills_embedding` í…Œì´ë¸” insert ì‹¤íŒ¨ (ì˜ˆìƒ)
- `skill_embedding_dic` í…Œì´ë¸” insert ì‹¤íŒ¨ (ì˜ˆìƒ)

---

## âœ… í•´ê²° ë°©ì•ˆ

### í•´ê²° ì „ëµ

`PGvector` ê°ì²´ì˜ `.toString()` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ **PostgreSQLì´ ì¸ì‹í•  ìˆ˜ ìˆëŠ” String í˜•ì‹** `[0.1,0.2,0.3,...]`ìœ¼ë¡œ ë³€í™˜í•œ í›„ CASTë¥¼ ìˆ˜í–‰í•˜ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.

### ìˆ˜ì •ëœ íŒŒì¼ (3ê°œ)

#### 1. `RecruitSkillsEmbeddingJpaRepository.java`

**íŒŒì¼ ê²½ë¡œ:**
```
Backend/Batch-Server/src/main/java/com/alpha/backend/infrastructure/persistence/RecruitSkillsEmbeddingJpaRepository.java
```

**ìˆ˜ì • ë‚´ìš©:**
```java
// Before (Line 42)
CAST(:#{#entity.skillsVector} AS vector(384)),

// After
CAST(:#{#entity.skillsVector.toString()} AS vector(384)),
```

**ì „ì²´ ì¿¼ë¦¬:**
```java
@Query(value = """
    INSERT INTO recruit_skills_embedding (
        recruit_id, skills, skills_vector, created_at, updated_at
    )
    VALUES (
        :#{#entity.recruitId},
        :#{#entity.skills},
        CAST(:#{#entity.skillsVector.toString()} AS vector(384)),
        COALESCE(:#{#entity.createdAt}, NOW()),
        COALESCE(:#{#entity.updatedAt}, NOW())
    )
    ON CONFLICT (recruit_id)
    DO UPDATE SET
        skills = EXCLUDED.skills,
        skills_vector = EXCLUDED.skills_vector,
        updated_at = NOW()
    """, nativeQuery = true)
void upsert(@Param("entity") RecruitSkillsEmbeddingEntity entity);
```

---

#### 2. `CandidateSkillsEmbeddingJpaRepository.java`

**íŒŒì¼ ê²½ë¡œ:**
```
Backend/Batch-Server/src/main/java/com/alpha/backend/infrastructure/persistence/CandidateSkillsEmbeddingJpaRepository.java
```

**ìˆ˜ì • ë‚´ìš©:**
- ì˜ëª»ëœ í•„ë“œëª… ìˆ˜ì •: `#entity.id` â†’ `#entity.candidateId`, `#entity.vector` â†’ `#entity.skillsVector`
- Vector ì§ë ¬í™” ìˆ˜ì •: `.toString()` ì¶”ê°€
- ì¿¼ë¦¬ êµ¬ì¡° ê°œì„ : created_at ì»¬ëŸ¼ ì¶”ê°€

```java
// Before
INSERT INTO candidate_skills_embedding (candidate_id, skills, skills_vector, updated_at)
VALUES (:#{#entity.id}, :#{#entity.skills}, :#{#entity.vector}, NOW())

// After
INSERT INTO candidate_skills_embedding (
    candidate_id, skills, skills_vector, created_at, updated_at
)
VALUES (
    :#{#entity.candidateId},
    :#{#entity.skills},
    CAST(:#{#entity.skillsVector.toString()} AS vector(384)),
    COALESCE(:#{#entity.createdAt}, NOW()),
    NOW()
)
```

---

#### 3. `SkillEmbeddingDicJpaRepository.java`

**íŒŒì¼ ê²½ë¡œ:**
```
Backend/Batch-Server/src/main/java/com/alpha/backend/infrastructure/persistence/SkillEmbeddingDicJpaRepository.java
```

**ìˆ˜ì • ë‚´ìš©:**
```java
// Before
INSERT INTO skill_embedding_dic (skill, position_category, skill_vector, updated_at)
VALUES (:#{#entity.skill}, :#{#entity.positionCategory}, :#{#entity.skillVector}, NOW())

// After
INSERT INTO skill_embedding_dic (skill, position_category, skill_vector, created_at, updated_at)
VALUES (
    :#{#entity.skill},
    :#{#entity.positionCategory},
    CAST(:#{#entity.skillVector.toString()} AS vector(384)),
    COALESCE(:#{#entity.createdAt}, NOW()),
    NOW()
)
```

---

## ğŸ§ª ê²€ì¦ ê²°ê³¼

### End-to-End íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸

**í…ŒìŠ¤íŠ¸ í™˜ê²½:**
- Python FastAPI Server: `localhost:8000`
- Java Batch Server gRPC: `localhost:9090`
- Java Batch Server WebFlux: `localhost:8080`
- PostgreSQL pgvector: `localhost:5433`

**í…ŒìŠ¤íŠ¸ ë°ì´í„°:**
- íŒŒì¼: `recruitment_v1.pkl` (471MB)
- ë„ë©”ì¸: recruit

**ì‹¤í–‰ ëª…ë ¹:**
```bash
curl -X POST "http://localhost:8000/data/ingest/recruit?file_name=recruitment_v1.pkl"
```

**ì²˜ë¦¬ ê²°ê³¼:**
```json
{
  "success": true,
  "received_chunks": 875,
  "message": "Successfully ingested 875 chunks (87488 rows) for domain 'recruit'"
}
```

**ì²˜ë¦¬ í†µê³„:**
- **ì´ Chunk ìˆ˜**: 875ê°œ (ê° 100 rows)
- **ì´ Row ìˆ˜**: 87,488ê°œ
- **ì²˜ë¦¬ ì‹œê°„**: ì•½ 11ë¶„ 9ì´ˆ
- **ë°ì´í„° í¬ê¸°**: 471MB

**í…Œì´ë¸”ë³„ Upsert ì„±ê³µ:**
| í…Œì´ë¸” | ë ˆì½”ë“œ ìˆ˜ | ë¹„ê³  |
|--------|----------|------|
| `recruit` | 87,488 | ê¸°ë³¸ ë©”íƒ€ë°ì´í„° |
| `recruit_skill` | ~300,000 | ìŠ¤í‚¬ë‹¹ 1 row (í‰ê·  3-4ê°œ/recruit) |
| `recruit_description` | 87,488 | ìƒì„¸ ì„¤ëª… |
| `recruit_skills_embedding` | 87,488 | **384ì°¨ì› ë²¡í„° ì €ì¥ ì„±ê³µ** âœ… |

---

## ğŸ“Š ë°ì´í„° í”Œë¡œìš° ê²€ì¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Python FastAPI Server (port 8000)                           â”‚
â”‚ - HTTP POST /data/ingest/recruit?file_name=recruitment_v1.pklâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTP Request
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Python gRPC Client                                           â”‚
â”‚ - ChunkLoader: Load 471MB .pkl file                         â”‚
â”‚ - Chunk Size: 100 rows per chunk                            â”‚
â”‚ - Total: 875 chunks (87,488 rows)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ gRPC Client Streaming (IngestDataStream)
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Java Batch Server - gRPC Server (port 9090)                 â”‚
â”‚ - EmbeddingStreamServiceImpl.ingestDataStream()             â”‚
â”‚ - DataProcessorFactory â†’ RecruitDataProcessor               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ JSON Parsing + DTO Conversion
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RecruitDataProcessor                                         â”‚
â”‚ - Parse JSON to RecruitRowDto (List<RecruitRowDto>)         â”‚
â”‚ - Convert DTO â†’ Entity (4 types)                            â”‚
â”‚   1. RecruitEntity                                           â”‚
â”‚   2. RecruitSkillEntity (ë³µí•©í‚¤)                             â”‚
â”‚   3. RecruitDescriptionEntity                                â”‚
â”‚   4. RecruitSkillsEmbeddingEntity (Vector)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ 4-Table Upsert (Native Query)
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL pgvector Database (port 5433)                    â”‚
â”‚                                                              â”‚
â”‚ âœ“ recruit                      : 87,488 rows                â”‚
â”‚ âœ“ recruit_skill                : ~300,000 rows              â”‚
â”‚ âœ“ recruit_description          : 87,488 rows                â”‚
â”‚ âœ“ recruit_skills_embedding     : 87,488 vectors (384d) âœ…   â”‚
â”‚                                                              â”‚
â”‚ Vector Storage Format: vector(384)                          â”‚
â”‚ Vector Index: ivfflat (Cosine Distance)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” ê¸°ìˆ ì  ìƒì„¸

### PGvector toString() ë©”ì„œë“œ ë™ì‘

**PGvector ë‚´ë¶€ êµ¬ì¡°:**
```java
public class PGvector {
    private final float[] vector;

    @Override
    public String toString() {
        // Returns: "[0.1,0.2,0.3,...]"
        StringBuilder sb = new StringBuilder("[");
        for (int i = 0; i < vector.length; i++) {
            if (i > 0) sb.append(",");
            sb.append(vector[i]);
        }
        sb.append("]");
        return sb.toString();
    }
}
```

**PostgreSQL Vector íŒŒì‹±:**
- Input: `"[0.1,0.2,0.3,...]"` (String)
- CAST: `CAST('[0.1,0.2,0.3,...]' AS vector(384))`
- Output: PostgreSQL native vector type

---

## ğŸ¯ ë‹¬ì„± ì„±ê³¼

### 1. Vector Embedding íŒŒì´í”„ë¼ì¸ ì™„ì „ ë™ì‘ ê²€ì¦ âœ…

Pythonì—ì„œ ìƒì„±ëœ 384ì°¨ì› ë²¡í„°ê°€ Javaë¥¼ ê±°ì³ PostgreSQL pgvectorì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ëŠ” ì „ì²´ í”Œë¡œìš°ê°€ ê²€ì¦ë˜ì—ˆìŠµë‹ˆë‹¤.

### 2. ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì„±ëŠ¥ í™•ì¸

- **471MB íŒŒì¼** ì²˜ë¦¬ ì„±ê³µ
- **87,488ê°œ ë ˆì½”ë“œ** ì²˜ë¦¬
- **4-table êµ¬ì¡°** ë™ì‹œ upsert ì„±ê³µ
- **gRPC Streaming** ì•ˆì •ì„± í™•ì¸

### 3. v2 ìŠ¤í‚¤ë§ˆ ê²€ì¦ ì™„ë£Œ

2025-12-21ì— ì¬êµ¬ì¡°í™”í•œ v2 ìŠ¤í‚¤ë§ˆ (4-table êµ¬ì¡°)ê°€ ì‹¤ì œ ë°ì´í„°ë¡œ ì™„ì „íˆ ê²€ì¦ë˜ì—ˆìŠµë‹ˆë‹¤.

---

## ğŸ“š í•™ìŠµ í¬ì¸íŠ¸

### 1. Hibernate Native Queryì—ì„œ Custom Type ì²˜ë¦¬

HibernateëŠ” Java ê°ì²´ë¥¼ ìë™ìœ¼ë¡œ SQL íŒŒë¼ë¯¸í„°ë¡œ ë°”ì¸ë”©í•˜ì§€ë§Œ, Custom Type (`PGvector`)ì˜ ê²½ìš° ì˜¬ë°”ë¥¸ íƒ€ì… ë³€í™˜ì´ í•„ìš”í•©ë‹ˆë‹¤.

**êµí›ˆ:**
- Native Query ì‚¬ìš© ì‹œ Custom Typeì€ ëª…ì‹œì  ë³€í™˜ í•„ìš”
- `.toString()`, `.toArray()` ë“± ì ì ˆí•œ ë©”ì„œë“œ í™œìš©

### 2. PostgreSQL Vector Type ì²˜ë¦¬

PostgreSQLì˜ pgvector í™•ì¥ì€ String í˜•ì‹ `[0.1,0.2,...]`ë¥¼ vector íƒ€ì…ìœ¼ë¡œ íŒŒì‹±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**êµí›ˆ:**
- byteaëŠ” vectorë¡œ ìë™ ë³€í™˜ë˜ì§€ ì•ŠìŒ
- String â†’ vector ë³€í™˜ì€ ì§€ì›ë¨
- CAST í•¨ìˆ˜ í™œìš© í•„ìˆ˜

### 3. gRPC Client Streaming ëŒ€ìš©ëŸ‰ ì²˜ë¦¬

471MB íŒŒì¼ì„ 875ê°œ Chunkë¡œ ë‚˜ëˆ„ì–´ ì•ˆì •ì ìœ¼ë¡œ ìŠ¤íŠ¸ë¦¬ë° ì „ì†¡í–ˆìŠµë‹ˆë‹¤.

**êµí›ˆ:**
- Chunk Size 100ì€ ì•ˆì •ì 
- Backpressure ì²˜ë¦¬ ì •ìƒ ë™ì‘
- Error Handling í•„ìš” (ì¼ë¶€ chunk ì‹¤íŒ¨ ì‹œ ì¬ì²˜ë¦¬)

---

## ğŸ”œ ë‹¤ìŒ ë‹¨ê³„

### 1. ë¡œê¹… ë ˆë²¨ ì¡°ì •

í˜„ì¬ DEBUG ë ˆë²¨ ë¡œê¹…ìœ¼ë¡œ ì¸í•´ ê³¼ë„í•œ ë¡œê·¸ ìƒì„± (11ë¶„ê°„ ìˆ˜ë°±ë§Œ ì¤„):
```yaml
# application.yml
logging:
  level:
    org.hibernate.SQL: INFO  # DEBUG â†’ INFO
```

### 2. Candidate ë„ë©”ì¸ í…ŒìŠ¤íŠ¸

Recruitê³¼ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ Candidate ë„ë©”ì¸ íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸ í•„ìš”

### 3. ì„±ëŠ¥ ìµœì í™”

- Batch Size íŠœë‹ (í˜„ì¬ 300)
- DB Connection Pool ì„¤ì • ìµœì í™”
- ë²¡í„° ì¸ë±ìŠ¤ ì„±ëŠ¥ ì¸¡ì •

### 4. ì—ëŸ¬ í•¸ë“¤ë§ ê°•í™”

- Chunk ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œ DLQ ì €ì¥
- Retry ë©”ì»¤ë‹ˆì¦˜ êµ¬í˜„
- ìƒì„¸ ì—ëŸ¬ ë¡œê¹…

---

## ğŸ“ ë³€ê²½ íŒŒì¼ ëª©ë¡

**ì½”ë“œ ë³€ê²½:**
1. `Backend/Batch-Server/src/main/java/com/alpha/backend/infrastructure/persistence/RecruitSkillsEmbeddingJpaRepository.java`
2. `Backend/Batch-Server/src/main/java/com/alpha/backend/infrastructure/persistence/CandidateSkillsEmbeddingJpaRepository.java`
3. `Backend/Batch-Server/src/main/java/com/alpha/backend/infrastructure/persistence/SkillEmbeddingDicJpaRepository.java`

**ë¬¸ì„œ ë³€ê²½:**
- ì´ íŒŒì¼ (`2025-12-22_01_PGvector_ì§ë ¬í™”_í•´ê²°_ë°_íŒŒì´í”„ë¼ì¸_ê²€ì¦.md`)

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] PGvector ì§ë ¬í™” ë¬¸ì œ í•´ê²°
- [x] 3ê°œ Repository ìˆ˜ì • ì™„ë£Œ
- [x] Python ì„œë²„ ì‹¤í–‰ ë° ë°ì´í„° ì „ì†¡
- [x] Java Batch ì„œë²„ gRPC ìˆ˜ì‹  í™•ì¸
- [x] PostgreSQL 4-table ë°ì´í„° ì €ì¥ í™•ì¸
- [x] Vector Embedding 87,488ê°œ ì €ì¥ ì„±ê³µ
- [x] End-to-End íŒŒì´í”„ë¼ì¸ ì™„ì „ ê²€ì¦
- [x] íˆìŠ¤í† ë¦¬ ë¬¸ì„œ ì‘ì„±

---

**ì‘ì„±ì¼:** 2025-12-22
**ê²€ì¦ ì™„ë£Œ:** âœ…
