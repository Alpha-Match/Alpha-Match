# Batch Server - 문서 구조 전면 개선

**날짜:** 2025-12-17
**작업 범위:** 문서화 규칙 정립 및 obsolete 문서 정리

---

## 배경

### 문제 상황
- Batch Server 문서가 11개 파일, 5,000+ 줄로 비대화
- 2025-12-16~17 Spring Batch 6.0 마이그레이션으로 **73%의 문서가 obsolete**
- 문서 간 중복 내용 다수 (Batch설계서, gRPC_통신_가이드, 서비스_레이어_구현_가이드 등)
- 참조 관계가 복잡하고 일관성 없음

### Obsolete 된 패턴 (2025-12-11~12 작성)
1. **DataProcessor<T>** interface - parseChunk/saveToDatabase 메서드
2. **ChunkProcessorInterface** - Factory 패턴 자동 등록
3. **EmbeddingStreamingService** - Reactive 파이프라인 (Flux, Mono)
4. **StreamingService** - concatMap, publishOn 패턴
5. **GrpcTestRunner/GrpcStreamTestService** - (코드 삭제됨, 2025-12-16)

### 현재 구현 (2025-12-16~17)
1. **Spring Batch 6.0** ItemReader/Processor/Writer 패턴
2. **DomainItemReader<T>** - gRPC Stream → BlockingQueue
3. **DomainItemProcessor<I,M,E>** - Proto → Entity 변환
4. **DomainItemWriter<M,E>** - Generic Batch Upsert
5. **DomainJobFactory** - Factory Method 패턴
6. **BatchSchedulerConfig** - Quartz + Spring Batch 통합

---

## 구현 내용

### 1. 문서화 규칙 정립

#### 고정 문서 vs 히스토리 문서 개념
- **고정 문서 (3개):** 항상 최신 상태 유지, 코드 변경 시 즉시 업데이트
  1. Spring_Batch_개발_가이드.md - 아키텍처 및 개발 패턴
  2. 도메인_확장_가이드.md - 도메인 추가 절차
  3. 동시성_제어.md - 동시성 제어 전략
- **히스토리 문서 (`/docs/hist/`):** Read-Only, 날짜별 작업 이력

#### 작업 프로세스 정의
```
코드 작성 및 테스트
  ↓
히스토리 문서 작성 (/docs/hist/YYYY-MM-DD_NN_제목.md)
  ↓
고정 문서 업데이트 (필요 시)
  ↓
CLAUDE.md 업데이트 (구현 상태 반영)
  ↓
Commit
```

### 2. Obsolete 문서 9개 삭제

| 파일명 | 사유 |
|--------|------|
| Batch설계서.md | DataProcessor, ChunkProcessorInterface 패턴 (obsolete) |
| Entire_Structure.md | 루트 문서와 중복 |
| gRPC_클라이언트_구현.md | GrpcTestRunner 참조 (코드 삭제됨) |
| gRPC_통신_가이드.md | Reactive Streaming 패턴 (Spring Batch로 대체) |
| Reactive_Blocking_혼합전략.md | Reactive 파이프라인 예시 (실제 미사용) |
| 구현_요약_2025-12-12.md | DataProcessor 패턴 요약 (obsolete) |
| 도메인별_제네릭_구조_구현.md | DataProcessor 구현 가이드 (obsolete) |
| 서비스_레이어_구현_가이드.md | ChunkProcessor + EmbeddingStreamingService (obsolete) |
| 프로젝트_구조.md | application/ 패키지 구조 (batch/로 변경됨) |

**삭제 방법:**
```bash
cd Backend/Batch-Server/docs
rm -f "Batch설계서.md" "Entire_Structure.md" "Entire_Structure.md~" \
      "gRPC_클라이언트_구현.md" "gRPC_통신_가이드.md" \
      "Reactive_Blocking_혼합전략.md" "구현_요약_2025-12-12.md" \
      "도메인별_제네릭_구조_구현.md" "서비스_레이어_구현_가이드.md" \
      "프로젝트_구조.md"
```

### 3. 고정 문서 3개 작성/업데이트

#### Spring_Batch_개발_가이드.md (NEW - 616 lines)
**내용:**
- Spring Batch 6.0 아키텍처 전체 설명
- DomainItemReader/Processor/Writer 추상 클래스 패턴
- DomainJobFactory (Factory Method 패턴)
- Quartz Scheduler 통합 (Spring Batch 6.0 API)
  - JobRegistry로 Job 객체 획득
  - JobParametersBuilder로 타입 안전한 파라미터 생성
  - JobOperator.start(Job, JobParameters) 실행
- Proto 파일 정의 (3개 도메인: Recruit, Candidate, SkillEmbeddingDic)
- EmbeddingGrpcClient, CacheInvalidateGrpcClient
- Recruit 도메인 전체 구현 예시
- 성능 최적화 팁

#### 도메인_확장_가이드.md (UPDATED)
**주요 변경:**
- Section 5 전면 수정: ChunkProcessor → Spring Batch 컴포넌트
  - 5.1: ItemReader 구현 (extends DomainItemReader)
  - 5.2: ItemProcessor 구현 (extends DomainItemProcessor)
  - 5.3: ItemWriter 사용 (generic DomainItemWriter)
  - 5.4: DomainJobFactory에 Job 추가
  - 5.5: BatchJobConfig에 Job Bean 등록
  - 5.6: Quartz Scheduler 설정 (선택)
- Section 8.3 체크리스트 업데이트
- Section 8.6~8.8 추가 (Quartz, YAML 설정, 문서화)
- 참조 링크 업데이트 (Spring_Batch_개발_가이드.md로)

#### 동시성_제어.md (UPDATED)
**주요 변경:**
- Section 2: Checkpoint 업데이트 경쟁 방지
  - Reactive StreamingService → Spring Batch ItemReader/Writer
  - Spring Batch의 순차 처리 보장 설명
- Section 3: Upsert 순서 보장
  - ChunkProcessor → DomainItemWriter
  - Candidate 3-Table Split 예시 추가
- Section 5: DLQ 처리
  - ChunkProcessor → DomainItemWriter의 DLQ 로직
- Section 6: Python Stream 비정상 종료 대응
  - Reactive 재연결 → Spring Batch Checkpoint 자동 재시작
- Section 7: UUID 기반 병렬 처리
  - ChunkProcessor → RecruitItemProcessor/DomainItemWriter
  - Reactive parallel() 패턴 제거 (Spring Batch는 순차 처리)
- 참조 링크 업데이트 (obsolete 문서 제거)

### 4. CLAUDE.md 업데이트

#### 문서 계층 구조 섹션 확장
- Tier 2에 "Batch-Server 고정 문서" 서브섹션 추가
- 3개 고정 문서 각각의 목적과 내용 명시
- Tier 3 "히스토리 문서" 설명 추가

#### 문서화 규칙 섹션 추가
1. 고정 문서 vs 히스토리 문서 (특징 명시)
2. 작업 프로세스 (5단계 절차 + 예시)
3. 문서 참조 원칙 (Good/Bad 예시)
4. 히스토리 문서 작성 가이드 (파일명 규칙, 내용 구조)

#### 최근 업데이트 섹션
- "2025-12-17 - 문서 구조 전면 개선 완료" 추가
- 작업 결과 요약: 11개 (5,000+ 줄) → 3개 (~2,000 줄), 73% 중복 제거

---

## 기술 결정 사항

### 1. 고정 문서 3개로 제한
**이유:**
- 유지보수 부담 최소화
- 명확한 참조 구조
- 중복 제거

**근거:**
- 아키텍처 가이드: Spring_Batch_개발_가이드.md
- 도메인 확장: 도메인_확장_가이드.md (Step-by-Step)
- 동시성 제어: 동시성_제어.md (Race Condition 패턴)
- 3개 문서로 Batch Server의 모든 개발 시나리오 커버 가능

### 2. 히스토리 문서 Read-Only 정책
**이유:**
- 작업 이력 보존 (기술 결정 과정 추적)
- 고정 문서와 역할 분리
- Git 히스토리와 별도로 문서 레벨 히스토리 유지

**파일명 규칙:**
- `YYYY-MM-DD_NN_간략한_제목.md`
- 날짜순 정렬로 시간순 추적 용이

### 3. Obsolete 문서 삭제 (보관하지 않음)
**이유:**
- Git 히스토리로 복원 가능
- 문서 복잡도 증가 방지
- AI 에이전트 혼동 방지 (구버전 참조 위험)

**대안 고려:**
- `docs/archive/` 폴더 생성 → 기각 (Git으로 충분)
- 주석 처리 → 기각 (파일 크기 비대화)

---

## 문제 해결

### 문제 1: Spring Batch 패턴 전환 시 모든 예시 코드 변경 필요
**해결:**
1. 동시성_제어.md의 Section 2-7을 순차적으로 업데이트
2. ChunkProcessor, StreamingService 코드 → ItemReader/Processor/Writer로 교체
3. Reactive 패턴 (Flux, Mono) → Spring Batch Chunk 처리로 변경
4. `관련 문서` 섹션에서 obsolete 참조 제거

### 문제 2: 도메인_확장_가이드.md의 CompanyChunkProcessor 예시 (183줄)
**해결:**
- Section 5 전체를 ItemReader/Processor/Writer 패턴으로 재작성
- 기존 183줄 → 약 80줄 (3개 컴포넌트 분리)
- 각 컴포넌트의 책임 명확화 (SRP)

---

## 고정 문서 반영 사항

### Spring_Batch_개발_가이드.md
- 새로 작성 (616 lines)
- 모든 Spring Batch 6.0 패턴 정리

### 도메인_확장_가이드.md
- Section 5 전면 재작성 (ChunkProcessor → Spring Batch)
- Section 8 체크리스트 업데이트

### 동시성_제어.md
- Section 2-7 코드 예시 업데이트
- Reactive 패턴 → Spring Batch 패턴

### CLAUDE.md
- 문서 계층 구조 확장
- 문서화 규칙 섹션 추가
- 최근 업데이트 섹션 추가

---

## 결과

### 문서 수 감소
- **Before:** 11개 파일, 5,000+ 줄
- **After:** 3개 고정 문서, ~2,000 줄
- **감소율:** 문서 수 73%, 줄 수 60%

### 문서 품질 개선
- ✅ 모든 문서가 실제 코드 기준
- ✅ 중복 제거
- ✅ 참조 구조 단순화
- ✅ 유지보수 부담 감소

### 향후 작업
- 새 기능 구현 시 히스토리 문서 작성 → 고정 문서 업데이트 프로세스 준수
- Candidate Job 구현 시 고정 문서에 예시 추가
- SkillEmbeddingDic Job 구현 시 고정 문서에 예시 추가

---

**작업 완료일:** 2025-12-17
**커밋 예정:** docs(batch): 문서 구조 전면 개선 및 obsolete 문서 정리
