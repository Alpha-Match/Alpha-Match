# v2 ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ ì ê²€ ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2025-12-21
**ì ê²€ì**: AI Agent
**ì ê²€ ë²”ìœ„**: Flyway V2 ë§ˆì´ê·¸ë ˆì´ì…˜, ì—”í‹°í‹° v2, Repository ê³„ì¸µ

---

## ğŸ“‹ ì ê²€ ê°œìš”

### ì ê²€ ëŒ€ìƒ

1. âœ… Flyway V2 ë§ˆì´ê·¸ë ˆì´ì…˜ SQL íŒŒì¼
2. âœ… ì—”í‹°í‹° 11ê°œ (v2 ìŠ¤í‚¤ë§ˆ ê¸°ì¤€)
3. âœ… Repository ê³„ì¸µ (Domain + Infrastructure)
4. âœ… ë²¡í„° ì°¨ì› ì¼ê´€ì„±
5. âœ… FK ì œì•½ì¡°ê±´ ë° CASCADE ì„¤ì •
6. âœ… ë³µí•© PK êµ¬í˜„
7. âœ… UNIQUE ì œì•½ì¡°ê±´

### ì ê²€ ê²°ê³¼ ìš”ì•½

| í•­ëª© | ìƒíƒœ | ë¹„ê³  |
|------|------|------|
| Flyway V2 SQL ë¬¸ë²• | ğŸŸ¢ ì •ìƒ | ì¼ë¶€ ì¸ë±ìŠ¤ëª… í™•ì¸ í•„ìš” |
| ì—”í‹°í‹° 11ê°œ ìƒì„± | ğŸŸ¢ ì •ìƒ | - |
| ë²¡í„° ì°¨ì› ì¼ê´€ì„± | ğŸŸ¢ ì •ìƒ | ëª¨ë‘ 384d |
| ë³µí•© PK êµ¬í˜„ | ğŸŸ¢ ì •ìƒ | CandidateSkillId, RecruitSkillId |
| **Repository ëˆ„ë½** | ğŸ”´ **ì‹¬ê°** | **12ê°œ ëˆ„ë½** |
| UUID ìƒì„± ì „ëµ | ğŸŸ¡ ê²€í†  í•„ìš” | GenerationType.AUTO vs gen_random_uuid() |

---

## ğŸ”´ ì‹¬ê°í•œ ë¬¸ì œ (ì¦‰ì‹œ ìˆ˜ì • í•„ìš”)

### 1. Repository 12ê°œ ì™„ì „ ëˆ„ë½

ì—”í‹°í‹°ëŠ” ìƒì„±í–ˆì§€ë§Œ Repository ê³„ì¸µì´ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

#### 1.1 Recruit Domain (8ê°œ ëˆ„ë½)

**Domain Layer (Port - ì¸í„°í˜ì´ìŠ¤):**
```
âŒ src/main/java/com/alpha/backend/domain/recruit/repository/RecruitRepository.java
âŒ src/main/java/com/alpha/backend/domain/recruit/repository/RecruitDescriptionRepository.java
âŒ src/main/java/com/alpha/backend/domain/recruit/repository/RecruitSkillRepository.java
âŒ src/main/java/com/alpha/backend/domain/recruit/repository/RecruitSkillsEmbeddingRepository.java
```

**Infrastructure Layer (Adapter - JPA êµ¬í˜„ì²´):**
```
âŒ src/main/java/com/alpha/backend/infrastructure/persistence/RecruitJpaRepository.java
âŒ src/main/java/com/alpha/backend/infrastructure/persistence/RecruitDescriptionJpaRepository.java
âŒ src/main/java/com/alpha/backend/infrastructure/persistence/RecruitSkillJpaRepository.java
âŒ src/main/java/com/alpha/backend/infrastructure/persistence/RecruitSkillsEmbeddingJpaRepository.java
```

**ì˜í–¥:**
- Recruit ë„ë©”ì¸ ë°ì´í„°ë¥¼ DBì— ì €ì¥/ì¡°íšŒ ë¶ˆê°€
- Batch Jobì—ì„œ RecruitItemWriter êµ¬í˜„ ë¶ˆê°€
- gRPCë¡œ ë°›ì€ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŒ

**ìš°ì„ ìˆœìœ„:** ğŸ”¥ ìµœìš°ì„ 

---

#### 1.2 SkillCategoryDic Domain (2ê°œ ëˆ„ë½)

**Domain Layer:**
```
âŒ src/main/java/com/alpha/backend/domain/skilldic/repository/SkillCategoryDicRepository.java
```

**Infrastructure Layer:**
```
âŒ src/main/java/com/alpha/backend/infrastructure/persistence/SkillCategoryDicJpaRepository.java
```

**ì˜í–¥:**
- ê¸°ìˆ  ìŠ¤íƒ ì¹´í…Œê³ ë¦¬ ì •ë³´ ì €ì¥/ì¡°íšŒ ë¶ˆê°€
- skill_embedding_dicì˜ category_id FK ì°¸ì¡° ë¶ˆê°€

**ìš°ì„ ìˆœìœ„:** ğŸ”¥ ìµœìš°ì„ 

---

#### 1.3 CandidateDescription Domain (2ê°œ ëˆ„ë½)

**Domain Layer:**
```
âŒ src/main/java/com/alpha/backend/domain/candidate/repository/CandidateDescriptionRepository.java
```

**Infrastructure Layer:**
```
âŒ src/main/java/com/alpha/backend/infrastructure/persistence/CandidateDescriptionJpaRepository.java
```

**ì˜í–¥:**
- ì§€ì›ì ì´ë ¥ì„œ ì›ë¬¸(Markdown) ì €ì¥ ë¶ˆê°€
- API ì„œë²„ì—ì„œ ìƒì„¸ ì´ë ¥ì„œ ì¡°íšŒ ë¶ˆê°€

**ìš°ì„ ìˆœìœ„:** ğŸ”¥ ìµœìš°ì„ 

---

### 2. ê¸°ì¡´ v1 Repositoryì™€ì˜ ì¶©ëŒ ê°€ëŠ¥ì„±

**ë¬¸ì œ:**
í˜„ì¬ Infrastructure ê³„ì¸µì— v1ìš© Repositoryê°€ ë‚¨ì•„ìˆìŠµë‹ˆë‹¤:
- `RecruitMetadataJpaRepository.java` (v1 - recruit_metadata í…Œì´ë¸”ìš©)
- `RecruitEmbeddingJpaRepository.java` (v1 - recruit_embedding í…Œì´ë¸”ìš©)

v2ì—ì„œëŠ” ì´ í…Œì´ë¸”ë“¤ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ **ëŸ°íƒ€ì„ ì˜¤ë¥˜ ë°œìƒ ê°€ëŠ¥**.

**í•´ê²° ë°©ì•ˆ:**
1. v1 Repository ì‚­ì œ (ê¶Œì¥)
2. ë˜ëŠ” `@Profile("v1")` ë“±ìœ¼ë¡œ ë¹„í™œì„±í™”

**ìš°ì„ ìˆœìœ„:** ğŸ”¥ ë†’ìŒ

---

## ğŸŸ¡ ì¤‘ìš”í•œ ë¬¸ì œ (ê²€í†  í•„ìš”)

### 3. UUID ìƒì„± ì „ëµ ë¶ˆì¼ì¹˜

**ë¬¸ì œ:**

**SkillCategoryDicEntity.java (Line 30-32):**
```java
@Id
@GeneratedValue(strategy = GenerationType.AUTO)
@Column(name = "category_id", updatable = false, nullable = false)
private UUID categoryId;
```

**Flyway V2 SQL (Line 38-39):**
```sql
CREATE TABLE skill_category_dic (
    category_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
```

**ë¶ˆì¼ì¹˜ ë‚´ìš©:**
- JPA: `GenerationType.AUTO` â†’ Hibernateì˜ UUID ìƒì„± ì „ëµ ì‚¬ìš©
- SQL: `DEFAULT gen_random_uuid()` â†’ PostgreSQL í•¨ìˆ˜ ì‚¬ìš©

**ì ì¬ì  ë¬¸ì œ:**
- Hibernateê°€ SQLì˜ DEFAULTë¥¼ ë¬´ì‹œí•˜ê³  ìì²´ UUID ìƒì„± ê°€ëŠ¥
- ë˜ëŠ” INSERT ì‹œ NULLì´ ë“¤ì–´ê°€ì„œ PostgreSQLì´ gen_random_uuid() í˜¸ì¶œ
- ì¼ê´€ì„± ë¬¸ì œ ë°œìƒ ê°€ëŠ¥

**ê¶Œì¥ ìˆ˜ì •:**

**ë°©ë²• 1: JPA ë°©ì‹ í†µì¼ (ê¶Œì¥)**
```java
@Id
@GeneratedValue(generator = "UUID")
@GenericGenerator(
    name = "UUID",
    strategy = "org.hibernate.id.UUIDGenerator"
)
@Column(name = "category_id")
private UUID categoryId;
```

```sql
-- SQLì—ì„œ DEFAULT ì œê±°
category_id UUID PRIMARY KEY,
```

**ë°©ë²• 2: SQL DEFAULT í™œìš©**
```java
@Id
@Column(name = "category_id")
private UUID categoryId;
// @GeneratedValue ì œê±°, INSERT ì „ ìˆ˜ë™ ì„¤ì • ë˜ëŠ” DB DEFAULT í™œìš©
```

**ì˜í–¥ ë²”ìœ„:**
- `SkillCategoryDicEntity.java`
- `SkillEmbeddingDicEntity.java`

**ìš°ì„ ìˆœìœ„:** ğŸŸ¡ ì¤‘ê°„ (í…ŒìŠ¤íŠ¸ ì‹œ í™•ì¸ í•„ìš”)

---

### 4. Flyway V2 ì¸ë±ìŠ¤ DROP ê²€ì¦ í•„ìš”

**ë¬¸ì œ:**

**V2__restructure_schema_to_v2.sql (Line 14-20):**
```sql
-- Drop Indexes
DROP INDEX IF EXISTS idx_candidate_skills_vector;
DROP INDEX IF EXISTS idx_skill_vector;
DROP INDEX IF EXISTS idx_recruit_vector;  -- âš ï¸ ì¸ë±ìŠ¤ëª… ë¶ˆì¼ì¹˜ ê°€ëŠ¥
DROP INDEX IF EXISTS idx_candidate_position_category;
DROP INDEX IF EXISTS idx_candidate_experience_years;
DROP INDEX IF EXISTS idx_recruit_primary_keyword;
DROP INDEX IF EXISTS idx_recruit_exp_years;
```

**V1 íŒŒì¼ì—ì„œ ì‹¤ì œ ìƒì„±ëœ ì¸ë±ìŠ¤ëª… í™•ì¸ í•„ìš”:**
- `idx_recruit_vector` â†’ ì‹¤ì œë¡œëŠ” `idx_recruit_embedding_vector`ì¼ ê°€ëŠ¥ì„±
- `idx_recruit_exp_years` â†’ ì‹¤ì œë¡œëŠ” `idx_recruit_metadata_exp_years`ì¼ ê°€ëŠ¥ì„±

**í™•ì¸ ë°©ë²•:**
```bash
# V1 íŒŒì¼ í™•ì¸
grep "CREATE INDEX" Backend/Batch-Server/src/main/resources/db/migration/V1__init_schema.sql
```

**ì˜í–¥:**
- ì¸ë±ìŠ¤ëª… ë¶ˆì¼ì¹˜ ì‹œ DROP ì‹¤íŒ¨ (í•˜ì§€ë§Œ `IF EXISTS` ì‚¬ìš©ìœ¼ë¡œ ì˜¤ë¥˜ëŠ” ì•ˆë‚¨)
- ê¸°ì¡´ ì¸ë±ìŠ¤ê°€ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìŒ (ì„±ëŠ¥ ì˜í–¥ ë¯¸ë¯¸)

**ìš°ì„ ìˆœìœ„:** ğŸŸ¡ ë‚®ìŒ (ê¸°ëŠ¥ì  ë¬¸ì œ ì—†ìŒ)

---

## ğŸŸ¢ ì •ìƒ í™•ì¸ëœ ì‚¬í•­

### 1. ë²¡í„° ì°¨ì› ì¼ê´€ì„± âœ…

**í™•ì¸ í•­ëª©:**
- ëª¨ë“  ì—”í‹°í‹°: `VECTOR_DIMENSION = 384`
- ëª¨ë“  SQL: `VECTOR(384)`

**í™•ì¸ ê²°ê³¼:**

| íŒŒì¼ | ë¼ì¸ | ë‚´ìš© | ìƒíƒœ |
|------|------|------|------|
| CandidateSkillsEmbeddingEntity.java | 31 | `VECTOR_DIMENSION = 384` | âœ… |
| RecruitSkillsEmbeddingEntity.java | 31 | `VECTOR_DIMENSION = 384` | âœ… |
| SkillEmbeddingDicEntity.java | 32 | `VECTOR_DIMENSION = 384` | âœ… |
| V2 SQL | 53, 129, 143, 211, 224 | `VECTOR(384)` | âœ… |

**ê²°ë¡ :** ëª¨ë“  ë²¡í„° ì°¨ì›ì´ 384ë¡œ í†µì¼ë¨. ë¬¸ì œ ì—†ìŒ.

---

### 2. ë³µí•© PK êµ¬í˜„ âœ…

**CandidateSkillId.java:**
```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@EqualsAndHashCode
public class CandidateSkillId implements Serializable {
    private static final long serialVersionUID = 1L;

    private UUID candidateId;
    private String skill;
}
```

**CandidateSkillEntity.java:**
```java
@Entity
@Table(name = "candidate_skill")
@IdClass(CandidateSkillId.class)
public class CandidateSkillEntity {
    @Id
    @Column(name = "candidate_id")
    private UUID candidateId;

    @Id
    @Column(name = "skill")
    private String skill;
}
```

**RecruitSkillId.java, RecruitSkillEntity.java:**
- ë™ì¼í•œ íŒ¨í„´ìœ¼ë¡œ ì •ìƒ êµ¬í˜„ë¨

**SQL:**
```sql
PRIMARY KEY (candidate_id, skill)
PRIMARY KEY (recruit_id, skill)
```

**ê²°ë¡ :** ë³µí•© PK êµ¬í˜„ ì •ìƒ. JPA `@IdClass` íŒ¨í„´ ì˜¬ë°”ë¦„.

---

### 3. UNIQUE ì œì•½ì¡°ê±´ âœ…

**SkillCategoryDicEntity.java (Line 34):**
```java
@Column(name = "category", nullable = false, unique = true, columnDefinition = "TEXT")
private String category;
```

**SkillEmbeddingDicEntity.java (Line 42):**
```java
@Column(name = "skill", nullable = false, unique = true, columnDefinition = "TEXT")
private String skill;
```

**SQL (Line 39, 52):**
```sql
category TEXT NOT NULL UNIQUE,
skill TEXT NOT NULL UNIQUE,
```

**ê²°ë¡ :** UNIQUE ì œì•½ì¡°ê±´ ì •ìƒ. Entityì™€ SQL ì¼ì¹˜.

---

### 4. íƒ€ì„ìŠ¤íƒ¬í”„ íƒ€ì… ë§¤í•‘ âœ…

**SQL:** `TIMESTAMPTZ` (PostgreSQLì˜ timezone-aware timestamp)
**Entity:** `OffsetDateTime` (Javaì˜ timezone-aware timestamp)

**ì˜ˆì‹œ:**
```java
@CreationTimestamp
@Column(name = "created_at", updatable = false, nullable = false)
private OffsetDateTime createdAt;

@UpdateTimestamp
@Column(name = "updated_at", nullable = false)
private OffsetDateTime updatedAt;
```

**ë§¤í•‘ í…Œì´ë¸”:**

| PostgreSQL | Java | Hibernate ë§¤í•‘ |
|------------|------|----------------|
| TIMESTAMPTZ | OffsetDateTime | âœ… ì •ìƒ |
| TIMESTAMP | LocalDateTime | - |

**ê²°ë¡ :** íƒ€ì„ìŠ¤íƒ¬í”„ ë§¤í•‘ ì •ìƒ. `@CreationTimestamp`, `@UpdateTimestamp` ì‚¬ìš©ìœ¼ë¡œ ìë™ ê´€ë¦¬.

---

### 5. FK ì œì•½ì¡°ê±´ (ë‹¨ë°©í–¥ ID ì°¸ì¡° íŒ¨í„´) âœ…

**í˜„ì¬ íŒ¨í„´:**
- Entityì—ëŠ” UUIDë§Œ ì €ì¥ (ì˜ˆ: `private UUID recruitId;`)
- JPA ê´€ê³„ ë§¤í•‘ ì—†ìŒ (`@OneToOne`, `@ManyToOne` ë¯¸ì‚¬ìš©)
- SQLì—ë§Œ FK ì œì•½ì¡°ê±´ ì¡´ì¬

**ì˜ˆì‹œ:**

**RecruitDescriptionEntity.java:**
```java
@Id
@Column(name = "recruit_id")
private UUID recruitId;
// âŒ @OneToOne ê´€ê³„ ì—†ìŒ (ì˜ë„ëœ ì„¤ê³„)
```

**SQL:**
```sql
CONSTRAINT fk_recruit_description
    FOREIGN KEY (recruit_id)
    REFERENCES recruit(recruit_id)
    ON DELETE CASCADE
```

**ì„¤ê³„ ì˜ë„:**
- ë‹¨ë°©í–¥ ID ì°¸ì¡°ë¡œ ë³µì¡ë„ ê°ì†Œ
- N+1 ë¬¸ì œ ë°©ì§€
- FK ì œì•½ì¡°ê±´ì€ DB ë ˆë²¨ì—ì„œë§Œ ê´€ë¦¬

**ê²°ë¡ :** ì´ê²ƒì€ **ì˜ë„ëœ ì„¤ê³„ íŒ¨í„´**. ë¬¸ì œ ì—†ìŒ.

---

### 6. CASCADE DELETE ì„¤ì • âœ…

**SQLì—ì„œ CASCADE DELETE í™•ì¸:**

```sql
-- candidate â†’ candidate_description (Line 93)
CONSTRAINT fk_candidate_description
    FOREIGN KEY (candidate_id)
    REFERENCES candidate(candidate_id)
    ON DELETE CASCADE

-- candidate â†’ candidate_skill (Line 124)
CONSTRAINT fk_candidate_skill_candidate
    FOREIGN KEY (candidate_id)
    REFERENCES candidate(candidate_id)
    ON DELETE CASCADE

-- candidate â†’ candidate_skills_embedding (Line 146)
CONSTRAINT fk_candidate_skills_embedding
    FOREIGN KEY (candidate_id)
    REFERENCES candidate(candidate_id)
    ON DELETE CASCADE

-- recruit â†’ recruit_description (Line 179)
CONSTRAINT fk_recruit_description
    FOREIGN KEY (recruit_id)
    REFERENCES recruit(recruit_id)
    ON DELETE CASCADE

-- recruit â†’ recruit_skill (Line 202)
CONSTRAINT fk_recruit_skill_recruit
    FOREIGN KEY (recruit_id)
    REFERENCES recruit(recruit_id)
    ON DELETE CASCADE

-- recruit â†’ recruit_skills_embedding (Line 225)
CONSTRAINT fk_recruit_skills_embedding
    FOREIGN KEY (recruit_id)
    REFERENCES recruit(recruit_id)
    ON DELETE CASCADE
```

**DDD Aggregate íŒ¨í„´:**
- `candidate` (Aggregate Root) â†’ í•˜ìœ„ 3ê°œ í…Œì´ë¸” CASCADE DELETE âœ…
- `recruit` (Aggregate Root) â†’ í•˜ìœ„ 3ê°œ í…Œì´ë¸” CASCADE DELETE âœ…

**ê²°ë¡ :** CASCADE DELETE ì„¤ì • ì •ìƒ. DDD Aggregate íŒ¨í„´ ì¤€ìˆ˜.

---

### 7. CHECK ì œì•½ì¡°ê±´ âœ…

**SQL:**
```sql
-- candidate (Line 76)
experience_years INTEGER CHECK (experience_years > 0),

-- recruit (Line 153)
experience_years INTEGER CHECK (experience_years > 0),
```

**ì˜ë¯¸:**
- NULL í—ˆìš© (ì‹ ì…/ê²½ë ¥ë¬´ê´€)
- ê°’ì´ ìˆì„ ê²½ìš° ë°˜ë“œì‹œ 1 ì´ìƒ

**Entity ê²€ì¦:**
```java
@Column(name = "experience_years")
private Integer experienceYears; // NULL ê°€ëŠ¥
```

**ê²°ë¡ :** CHECK ì œì•½ì¡°ê±´ ì •ìƒ. NULL í—ˆìš© ì •ì±… ì¼ì¹˜.

---

## ğŸ“Š í†µê³„

### íŒŒì¼ ìƒì„± í˜„í™©

| êµ¬ë¶„ | ìƒì„±ë¨ | ëˆ„ë½ë¨ | í•©ê³„ |
|------|--------|--------|------|
| ì—”í‹°í‹° | 11 | 0 | 11 |
| Domain Repository | 7 | 5 | 12 |
| JPA Repository | 5 | 7 | 12 |
| **ì´ê³„** | **23** | **12** | **35** |

### ë„ë©”ì¸ë³„ Repository í˜„í™©

| ë„ë©”ì¸ | ì—”í‹°í‹° | Domain Repo | JPA Repo | ìƒíƒœ |
|--------|--------|-------------|----------|------|
| Recruit | 5 | 1 (v1) | 2 (v1) | ğŸ”´ v2 ë¯¸êµ¬í˜„ |
| Candidate | 5 | 4 | 4 | ğŸŸ¡ 1ê°œ ëˆ„ë½ |
| SkillDic | 2 | 1 | 1 | ğŸŸ¡ 1ê°œ ëˆ„ë½ |
| Checkpoint | 1 | 1 | 1 | âœ… ì™„ë£Œ |
| DLQ | 1 | 1 | 1 | âœ… ì™„ë£Œ |

---

## ğŸ”§ ìˆ˜ì • í•„ìš” ì‚¬í•­ (ìš°ì„ ìˆœìœ„ë³„)

### ğŸ”¥ ìµœìš°ì„  (ì¦‰ì‹œ ìˆ˜ì •)

#### 1. Recruit Domain v2 Repository 8ê°œ ìƒì„±

**ì‘ì—… ëª©ë¡:**

**Domain Layer:**
1. `RecruitRepository.java`
   - `void upsert(RecruitEntity entity);`
   - `void upsertAll(List<RecruitEntity> entities);`

2. `RecruitDescriptionRepository.java`
   - `void upsert(RecruitDescriptionEntity entity);`
   - `void upsertAll(List<RecruitDescriptionEntity> entities);`

3. `RecruitSkillRepository.java`
   - `void upsert(RecruitSkillEntity entity);`
   - `void upsertAll(List<RecruitSkillEntity> entities);`

4. `RecruitSkillsEmbeddingRepository.java`
   - `void upsert(RecruitSkillsEmbeddingEntity entity);`
   - `void upsertAll(List<RecruitSkillsEmbeddingEntity> entities);`

**Infrastructure Layer:**
1. `RecruitJpaRepository.java`
   - Native Query Upsert êµ¬í˜„

2. `RecruitDescriptionJpaRepository.java`
   - Native Query Upsert êµ¬í˜„

3. `RecruitSkillJpaRepository.java`
   - Native Query Upsert êµ¬í˜„ (ë³µí•© PK)

4. `RecruitSkillsEmbeddingJpaRepository.java`
   - Native Query Upsert êµ¬í˜„

**ì˜ˆì‹œ ì½”ë“œ (RecruitJpaRepository):**
```java
@Repository
public interface RecruitJpaRepository
        extends JpaRepository<RecruitEntity, UUID>, RecruitRepository {

    @Override
    @Modifying
    @Query(value = """
        INSERT INTO recruit (
            recruit_id, position, company_name, experience_years,
            primary_keyword, english_level, published_at, updated_at
        )
        VALUES (
            :#{#entity.recruitId}, :#{#entity.position}, :#{#entity.companyName},
            :#{#entity.experienceYears}, :#{#entity.primaryKeyword},
            :#{#entity.englishLevel}, :#{#entity.publishedAt}, NOW()
        )
        ON CONFLICT (recruit_id)
        DO UPDATE SET
            position = EXCLUDED.position,
            company_name = EXCLUDED.company_name,
            experience_years = EXCLUDED.experience_years,
            primary_keyword = EXCLUDED.primary_keyword,
            english_level = EXCLUDED.english_level,
            published_at = EXCLUDED.published_at,
            updated_at = NOW()
        """, nativeQuery = true)
    void upsert(@Param("entity") RecruitEntity entity);

    @Override
    default void upsertAll(List<RecruitEntity> entities) {
        entities.forEach(this::upsert);
    }
}
```

---

#### 2. SkillCategoryDic Repository 2ê°œ ìƒì„±

**ì‘ì—… ëª©ë¡:**

**Domain Layer:**
```java
// SkillCategoryDicRepository.java
public interface SkillCategoryDicRepository {
    Optional<SkillCategoryDicEntity> findByCategory(String category);
    void upsert(SkillCategoryDicEntity entity);
    void upsertAll(List<SkillCategoryDicEntity> entities);
}
```

**Infrastructure Layer:**
```java
// SkillCategoryDicJpaRepository.java
@Repository
public interface SkillCategoryDicJpaRepository
        extends JpaRepository<SkillCategoryDicEntity, UUID>,
                SkillCategoryDicRepository {

    @Override
    Optional<SkillCategoryDicEntity> findByCategory(String category);

    @Override
    @Modifying
    @Query(value = """
        INSERT INTO skill_category_dic (category, updated_at)
        VALUES (:#{#entity.category}, NOW())
        ON CONFLICT (category)
        DO UPDATE SET
            updated_at = NOW()
        RETURNING category_id
        """, nativeQuery = true)
    void upsert(@Param("entity") SkillCategoryDicEntity entity);

    @Override
    default void upsertAll(List<SkillCategoryDicEntity> entities) {
        entities.forEach(this::upsert);
    }
}
```

**ì£¼ì˜ì‚¬í•­:**
- `category_id`ëŠ” ìë™ ìƒì„±ë˜ë¯€ë¡œ INSERT ì‹œ ì œì™¸
- `RETURNING category_id`ë¡œ ìƒì„±ëœ IDë¥¼ Entityì— ë°˜ì˜í• ì§€ ê²€í†  í•„ìš”

---

#### 3. CandidateDescription Repository 2ê°œ ìƒì„±

**ì‘ì—… ëª©ë¡:**

**Domain Layer:**
```java
// CandidateDescriptionRepository.java
public interface CandidateDescriptionRepository {
    void upsert(CandidateDescriptionEntity entity);
    void upsertAll(List<CandidateDescriptionEntity> entities);
}
```

**Infrastructure Layer:**
```java
// CandidateDescriptionJpaRepository.java
@Repository
public interface CandidateDescriptionJpaRepository
        extends JpaRepository<CandidateDescriptionEntity, UUID>,
                CandidateDescriptionRepository {

    @Override
    @Modifying
    @Query(value = """
        INSERT INTO candidate_description (
            candidate_id, original_resume, resume_lang, updated_at
        )
        VALUES (
            :#{#entity.candidateId}, :#{#entity.originalResume},
            :#{#entity.resumeLang}, NOW()
        )
        ON CONFLICT (candidate_id)
        DO UPDATE SET
            original_resume = EXCLUDED.original_resume,
            resume_lang = EXCLUDED.resume_lang,
            updated_at = NOW()
        """, nativeQuery = true)
    void upsert(@Param("entity") CandidateDescriptionEntity entity);

    @Override
    default void upsertAll(List<CandidateDescriptionEntity> entities) {
        entities.forEach(this::upsert);
    }
}
```

---

#### 4. v1 Repository ì‚­ì œ ë˜ëŠ” ë¹„í™œì„±í™”

**ì‚­ì œ ëŒ€ìƒ:**
- `RecruitMetadataRepository.java` (Domain)
- `RecruitEmbeddingRepository.java` (Domain)
- `RecruitMetadataJpaRepository.java` (Infrastructure)
- `RecruitEmbeddingJpaRepository.java` (Infrastructure)

**ë°©ë²• 1: ì‚­ì œ (ê¶Œì¥)**
```bash
rm Backend/Batch-Server/src/main/java/com/alpha/backend/domain/recruit/repository/RecruitMetadataRepository.java
rm Backend/Batch-Server/src/main/java/com/alpha/backend/domain/recruit/repository/RecruitEmbeddingRepository.java
rm Backend/Batch-Server/src/main/java/com/alpha/backend/infrastructure/persistence/RecruitMetadataJpaRepository.java
rm Backend/Batch-Server/src/main/java/com/alpha/backend/infrastructure/persistence/RecruitEmbeddingJpaRepository.java
```

**ë°©ë²• 2: ë¹„í™œì„±í™” (v1 ë¡¤ë°± ëŒ€ë¹„)**
```java
@Repository
@Profile("v1") // v1 í”„ë¡œíŒŒì¼ì—ì„œë§Œ í™œì„±í™”
public interface RecruitMetadataJpaRepository ... {
}
```

---

### ğŸŸ¡ ì¤‘ê°„ ìš°ì„ ìˆœìœ„

#### 5. UUID ìƒì„± ì „ëµ í†µì¼

**ëŒ€ìƒ:**
- `SkillCategoryDicEntity.java`
- `SkillEmbeddingDicEntity.java`

**ìˆ˜ì • ë°©ë²• 1: Hibernate UUID Generator ì‚¬ìš© (ê¶Œì¥)**

```java
import org.hibernate.annotations.GenericGenerator;

@Entity
@Table(name = "skill_category_dic")
public class SkillCategoryDicEntity {

    @Id
    @GeneratedValue(generator = "UUID")
    @GenericGenerator(
        name = "UUID",
        strategy = "org.hibernate.id.UUIDGenerator"
    )
    @Column(name = "category_id", updatable = false, nullable = false)
    private UUID categoryId;

    // ...
}
```

**Flyway V2 SQL ìˆ˜ì •:**
```sql
CREATE TABLE skill_category_dic (
    category_id UUID PRIMARY KEY,  -- DEFAULT ì œê±°
    category TEXT NOT NULL UNIQUE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**ìˆ˜ì • ë°©ë²• 2: SQL DEFAULT í™œìš©**

```java
@Entity
@Table(name = "skill_category_dic")
public class SkillCategoryDicEntity {

    @Id
    @Column(name = "category_id", updatable = false, nullable = false)
    private UUID categoryId;
    // @GeneratedValue ì œê±°

    // ...
}
```

SQLì€ ê·¸ëŒ€ë¡œ ìœ ì§€:
```sql
category_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
```

**ê¶Œì¥:** ë°©ë²• 1 (Hibernate í†µí•© ê´€ë¦¬)

---

#### 6. Flyway V1 ì¸ë±ìŠ¤ëª… í™•ì¸ ë° V2 ìˆ˜ì •

**ì‘ì—…:**
1. V1 íŒŒì¼ì—ì„œ ì‹¤ì œ ì¸ë±ìŠ¤ëª… í™•ì¸
2. V2 DROP INDEX êµ¬ë¬¸ ìˆ˜ì •

**í™•ì¸ ëª…ë ¹:**
```bash
grep "CREATE INDEX" Backend/Batch-Server/src/main/resources/db/migration/V1__init_schema.sql
```

**ì˜ˆìƒ ìˆ˜ì •:**
```sql
-- V2 íŒŒì¼ ìˆ˜ì •
DROP INDEX IF EXISTS idx_recruit_embedding_vector;  -- ìˆ˜ì •ë¨
DROP INDEX IF EXISTS idx_recruit_metadata_exp_years;  -- ìˆ˜ì •ë¨
```

---

## ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„ ê¶Œì¥ì‚¬í•­

### Phase 1: Repository ìƒì„± (í•„ìˆ˜)

1. **Recruit Domain Repository 8ê°œ** (1-2ì‹œê°„)
   - Domain ì¸í„°í˜ì´ìŠ¤ 4ê°œ
   - JPA êµ¬í˜„ì²´ 4ê°œ (Native Query Upsert)

2. **SkillCategoryDic Repository 2ê°œ** (30ë¶„)
   - Domain ì¸í„°í˜ì´ìŠ¤ 1ê°œ
   - JPA êµ¬í˜„ì²´ 1ê°œ

3. **CandidateDescription Repository 2ê°œ** (30ë¶„)
   - Domain ì¸í„°í˜ì´ìŠ¤ 1ê°œ
   - JPA êµ¬í˜„ì²´ 1ê°œ

4. **v1 Repository ì‚­ì œ** (10ë¶„)
   - 4ê°œ íŒŒì¼ ì‚­ì œ ë˜ëŠ” ë¹„í™œì„±í™”

**ì˜ˆìƒ ì†Œìš” ì‹œê°„:** 3-4ì‹œê°„

---

### Phase 2: UUID ìƒì„± ì „ëµ í†µì¼ (ì„ íƒ)

1. **Entity ìˆ˜ì •** (30ë¶„)
   - SkillCategoryDicEntity
   - SkillEmbeddingDicEntity

2. **Flyway V2 ìˆ˜ì •** (10ë¶„)
   - DEFAULT ì œê±°

**ì˜ˆìƒ ì†Œìš” ì‹œê°„:** 40ë¶„

---

### Phase 3: Flyway V1 ê²€ì¦ ë° V2 ìˆ˜ì • (ì„ íƒ)

1. **V1 ì¸ë±ìŠ¤ëª… í™•ì¸** (10ë¶„)
2. **V2 DROP INDEX ìˆ˜ì •** (10ë¶„)

**ì˜ˆìƒ ì†Œìš” ì‹œê°„:** 20ë¶„

---

### Phase 4: í†µí•© í…ŒìŠ¤íŠ¸

1. **Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸**
   ```bash
   ./gradlew flywayClean
   ./gradlew flywayMigrate
   ```

2. **ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ í…ŒìŠ¤íŠ¸**
   ```bash
   ./gradlew bootRun
   ```

3. **Repository ë™ì‘ í™•ì¸**
   - Upsert í…ŒìŠ¤íŠ¸
   - FK ì œì•½ì¡°ê±´ ê²€ì¦
   - CASCADE DELETE ê²€ì¦

**ì˜ˆìƒ ì†Œìš” ì‹œê°„:** 1-2ì‹œê°„

---

## ğŸ“Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì¦‰ì‹œ ìˆ˜ì • í•„ìš” (Phase 1)

- [ ] RecruitRepository ìƒì„± (Domain)
- [ ] RecruitDescriptionRepository ìƒì„± (Domain)
- [ ] RecruitSkillRepository ìƒì„± (Domain)
- [ ] RecruitSkillsEmbeddingRepository ìƒì„± (Domain)
- [ ] RecruitJpaRepository ìƒì„± (Infrastructure)
- [ ] RecruitDescriptionJpaRepository ìƒì„± (Infrastructure)
- [ ] RecruitSkillJpaRepository ìƒì„± (Infrastructure)
- [ ] RecruitSkillsEmbeddingJpaRepository ìƒì„± (Infrastructure)
- [ ] SkillCategoryDicRepository ìƒì„± (Domain)
- [ ] SkillCategoryDicJpaRepository ìƒì„± (Infrastructure)
- [ ] CandidateDescriptionRepository ìƒì„± (Domain)
- [ ] CandidateDescriptionJpaRepository ìƒì„± (Infrastructure)
- [ ] v1 Repository ì‚­ì œ/ë¹„í™œì„±í™” (4ê°œ)

### ê²€í†  í•„ìš” (Phase 2-3)

- [ ] UUID ìƒì„± ì „ëµ í†µì¼ (SkillCategoryDicEntity, SkillEmbeddingDicEntity)
- [ ] Flyway V1 ì¸ë±ìŠ¤ëª… í™•ì¸
- [ ] Flyway V2 DROP INDEX ìˆ˜ì •

### í…ŒìŠ¤íŠ¸ (Phase 4)

- [ ] Flyway Clean & Migrate ì„±ê³µ
- [ ] ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì„±ê³µ
- [ ] Repository Upsert ë™ì‘ í™•ì¸
- [ ] FK ì œì•½ì¡°ê±´ ê²€ì¦
- [ ] CASCADE DELETE ë™ì‘ í™•ì¸

---

## ğŸ“ ì°¸ê³  ë¬¸ì„œ

- **í…Œì´ë¸” ëª…ì„¸ì„œ**: `/Backend/docs/table_specification.md`
- **DB ìŠ¤í‚¤ë§ˆ ê°€ì´ë“œ**: `/Backend/docs/DB_ìŠ¤í‚¤ë§ˆ_ê°€ì´ë“œ.md`
- **ë„ë©”ì¸ í™•ì¥ ê°€ì´ë“œ**: `/Backend/Batch-Server/docs/ë„ë©”ì¸_í™•ì¥_ê°€ì´ë“œ.md`
- **Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ**: `/Backend/docs/Flyway_ë§ˆì´ê·¸ë ˆì´ì…˜_ê°€ì´ë“œ.md`
- **v2 í…ŒìŠ¤íŠ¸ ì„¸íŒ… ê°€ì´ë“œ**: `/docs/v2_í…ŒìŠ¤íŠ¸_ì„¸íŒ…_ê°€ì´ë“œ.md`

---

**ì ê²€ ì™„ë£Œì¼**: 2025-12-21
**ë‹¤ìŒ ê²€í†  ì˜ˆì •**: Repository 12ê°œ ìƒì„± ì™„ë£Œ í›„
