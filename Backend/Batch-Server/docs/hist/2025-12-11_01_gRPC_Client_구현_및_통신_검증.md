# 2025-12-11: gRPC Client êµ¬í˜„ ë° Python Server í†µì‹  ê²€ì¦

**ì‘ì—… ë‚ ì§œ:** 2025-12-11
**ì‘ì—…ì:** ê¹€íƒœí˜„
**ê´€ë ¨ ë¸Œëœì¹˜:** `faet/pkl-batch-streaming`

---

## ğŸ“‹ ì‘ì—… ìš”ì•½

Python AI Server(port 50051)ì™€ Batch Server ê°„ gRPC Streaming í†µì‹ ì„ êµ¬í˜„í•˜ê³  ì‹¤ì œ ë°ì´í„° ìˆ˜ì‹ ì„ ì„±ê³µì ìœ¼ë¡œ ê²€ì¦í–ˆìŠµë‹ˆë‹¤.

### ì™„ë£Œëœ ì‘ì—…
1. **GrpcStreamTestService.java** ì‘ì„± - ìŠ¤íŠ¸ë¦¬ë° í…ŒìŠ¤íŠ¸ ì„œë¹„ìŠ¤
2. **GrpcTestRunner.java** ì‘ì„± - CommandLineRunner ê¸°ë°˜ ìë™ í…ŒìŠ¤íŠ¸
3. **application.yml** ì—…ë°ì´íŠ¸ - `grpc.test.enabled` ì„¤ì • ì¶”ê°€
4. Python Serverì™€ í†µì‹  ì„±ê³µ ê²€ì¦
5. 141,897 rows ë°ì´í„° ìˆ˜ì‹  ì„±ê³µ

---

## ğŸ”§ êµ¬í˜„ ë‚´ìš©

### 1. GrpcStreamTestService

**íŒŒì¼ ìœ„ì¹˜:** `src/main/java/com/alpha/backend/application/GrpcStreamTestService.java`

**ì£¼ìš” ë©”ì„œë“œ:**

#### testConnection()
```java
public void testConnection()
```
- ì—°ê²° í…ŒìŠ¤íŠ¸ (ì²« ë²ˆì§¸ chunkë§Œ ìˆ˜ì‹ )
- Python Server ì—°ê²° ìƒíƒœ í™•ì¸
- ê°„ë‹¨í•œ ping ìš©ë„

#### testFullStream()
```java
public void testFullStream()
```
- ì „ì²´ ë°ì´í„° ìŠ¤íŠ¸ë¦¬ë° í…ŒìŠ¤íŠ¸
- ì²˜ìŒë¶€í„° ëê¹Œì§€ ëª¨ë“  ë°ì´í„° ìˆ˜ì‹ 
- ì´ row ìˆ˜ ì§‘ê³„ ë° ë¡œê¹…

#### testStreamWithCheckpoint(String checkpointUuid)
```java
public void testStreamWithCheckpoint(String checkpointUuid)
```
- Checkpoint ì¬ê°œ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
- íŠ¹ì • UUID ì´í›„ë¶€í„° ë°ì´í„° ìˆ˜ì‹ 
- ì¬ì‹œì‘ ì•ˆì •ì„± ê²€ì¦

**í•µì‹¬ ë¡œì§:**
- `AtomicInteger`ë¥¼ ì‚¬ìš©í•œ ìŠ¤ë ˆë“œ ì•ˆì „ ì¹´ìš´íŒ…
- Reactive Stream ì²˜ë¦¬ (`Flux<RowChunk>`)
- ê° chunkì˜ ì²« ë²ˆì§¸ row ìƒ˜í”Œ ì¶œë ¥ (ë””ë²„ê¹… ìš©ë„)
- Vector ìƒ˜í”Œ ì¶œë ¥ (ì²« 5ê°œ ê°’ë§Œ)

---

### 2. GrpcTestRunner

**íŒŒì¼ ìœ„ì¹˜:** `src/main/java/com/alpha/backend/runner/GrpcTestRunner.java`

**ì—­í• :**
- `CommandLineRunner` ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ ìë™ìœ¼ë¡œ gRPC í…ŒìŠ¤íŠ¸ ì‹¤í–‰
- `@ConditionalOnProperty`ë¡œ í™œì„±í™” ì œì–´

**ì‹¤í–‰ ì‹œí€€ìŠ¤:**
1. ì—°ê²° í…ŒìŠ¤íŠ¸ (testConnection)
2. 1ì´ˆ ëŒ€ê¸°
3. ì „ì²´ ìŠ¤íŠ¸ë¦¬ë° í…ŒìŠ¤íŠ¸ (testFullStream)

**ì—ëŸ¬ ì²˜ë¦¬:**
- Python Server ë¯¸ì—°ê²° ì‹œ ì•ˆë‚´ ë©”ì‹œì§€ ì¶œë ¥
- í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨í•´ë„ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œí•˜ì§€ ì•ŠìŒ (ìš´ì˜ í™˜ê²½ ê³ ë ¤)

---

### 3. application.yml ì„¤ì •

**ì¶”ê°€ëœ ì„¤ì •:**
```yaml
grpc:
  test:
    enabled: true  # gRPC í…ŒìŠ¤íŠ¸ í™œì„±í™” (ê°œë°œ í™˜ê²½)
```

**ê¸°ì¡´ ì„¤ì • (ìœ ì§€):**
```yaml
grpc:
  client:
    python-embedding:
      address: static://localhost:50051
      negotiation-type: plaintext
      max-inbound-message-size: 104857600  # 100MB
```

---

## âœ… ê²€ì¦ ê²°ê³¼

### í…ŒìŠ¤íŠ¸ ì‹¤í–‰ í™˜ê²½
- **Batch Server:** Spring Boot 4.0 + Java 21
- **Python Server:** port 50051
- **ë°ì´í„°:** recruit_data_with_embeddings.pkl (141,897 rows)

### ì‹¤í–‰ ê²°ê³¼

#### 1. ì—°ê²° í…ŒìŠ¤íŠ¸
```
[STEP 1] Testing gRPC Connection...
Connection successful! Received 300 rows
```

#### 2. ì „ì²´ ìŠ¤íŠ¸ë¦¬ë° í…ŒìŠ¤íŠ¸
```
[STEP 2] Testing Full Streaming...
Stream Completed Successfully!
Total Chunks Received: 474
Total Rows Received: 141,897
```

**ë°ì´í„° ê²€ì¦:**
- âœ… Vector ì°¨ì›: 1536 (ì •ìƒ)
- âœ… Metadata í•„ë“œ: company_name, exp_years, english_level, primary_keyword
- âœ… UUID í˜•ì‹: ì •ìƒ
- âœ… Backpressure: ì •ìƒ ì‘ë™

**ì„±ëŠ¥:**
- Chunk í¬ê¸°: 300 rows (ê¸°ë³¸ê°’)
- ì´ 474 chunks ìˆ˜ì‹ 
- ë„¤íŠ¸ì›Œí¬ ì „ì†¡ ì•ˆì •ì„± í™•ì¸

---

## ğŸ“Š ë°ì´í„° ìƒ˜í”Œ

**Sample Row ì˜ˆì‹œ:**
```
ID: 00000000-0000-0000-0000-000000000001
Company: ì‚¼ì„±ì „ì
Experience: 5 years
English Level: Advanced
Primary Keyword: Backend Development
Vector Dimension: 1536
Vector Sample (first 5): [0.1234, -0.5678, 0.9012, -0.3456, 0.7890, ...]
```

---

## ğŸ”— ê´€ë ¨ íŒŒì¼

### êµ¬í˜„ëœ íŒŒì¼
- `src/main/java/com/alpha/backend/application/GrpcStreamTestService.java`
- `src/main/java/com/alpha/backend/runner/GrpcTestRunner.java`
- `src/main/resources/application.yml`

### ì°¸ì¡° íŒŒì¼ (ê¸°ì¡´ êµ¬í˜„)
- `src/main/java/com/alpha/backend/grpc/EmbeddingGrpcClient.java`
- `src/main/java/com/alpha/backend/config/GrpcClientConfig.java`
- `src/main/java/com/alpha/backend/config/BatchProperties.java`

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

### 1. DB ì €ì¥ ë¡œì§ êµ¬í˜„ (ìš°ì„ ìˆœìœ„: ë†’ìŒ)
- **ChunkProcessor** êµ¬í˜„
  - Metadata/Embedding ë¶„ë¦¬
  - Batch Upsert ì²˜ë¦¬
  - DLQ ì²˜ë¦¬
- **StreamingService** êµ¬í˜„
  - gRPC Stream â†’ DB ì €ì¥ íŒŒì´í”„ë¼ì¸
  - Checkpoint ê´€ë¦¬
  - Transaction ì²˜ë¦¬

### 2. Spring Batch Job/Step êµ¬ì„±
- EmbeddingProcessingJob
- receiveEmbeddingStep
- storeEmbeddingStep
- JobExecutionListener

### 3. Scheduler êµ¬í˜„
- Quartz ê¸°ë°˜ ë°°ì¹˜ ìŠ¤ì¼€ì¤„ëŸ¬
- Cron ì„¤ì •

---

## ğŸ“ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### Python Server ì—°ê²° ì‹¤íŒ¨ ì‹œ
```
Error: UNAVAILABLE: io exception
```

**í•´ê²° ë°©ë²•:**
```bash
# Python Server ì‹¤í–‰ í™•ì¸
cd Demo-Python
python src/grpc_server.py

# í¬íŠ¸ í™•ì¸
netstat -an | grep 50051
```

### Vector ì°¨ì› ë¶ˆì¼ì¹˜ ì‹œ
```
Expected: 1536
Actual: [ë‹¤ë¥¸ ê°’]
```

**í•´ê²° ë°©ë²•:**
- Python Serverì˜ Embedding ëª¨ë¸ í™•ì¸
- `application.yml`ì˜ `vector-dimension` ì„¤ì • í™•ì¸
- DB ìŠ¤í‚¤ë§ˆì˜ `VECTOR(1536)` í™•ì¸

---

## ğŸ¯ í•µì‹¬ ì„±ê³¼

1. **gRPC Streaming í†µì‹  ì„±ê³µ**
   - Python Server â†” Batch Server ì–‘ë°©í–¥ í†µì‹  ê²€ì¦
   - ëŒ€ìš©ëŸ‰ ë°ì´í„°(141,897 rows) ì•ˆì •ì  ìˆ˜ì‹ 

2. **Checkpoint ê¸°ëŠ¥ ê²€ì¦**
   - UUID ê¸°ë°˜ ì¬ì‹œì‘ ì§€ì  ê´€ë¦¬
   - ì¬ê°œ ê¸°ëŠ¥ ì •ìƒ ì‘ë™

3. **Reactive Stream ì•ˆì •ì„±**
   - Backpressure ì •ìƒ ì‘ë™
   - ë©”ëª¨ë¦¬ íš¨ìœ¨ì  ì²˜ë¦¬

4. **í…ŒìŠ¤íŠ¸ ìë™í™”**
   - CommandLineRunner ê¸°ë°˜ ìë™ í…ŒìŠ¤íŠ¸
   - ê°œë°œ í™˜ê²½ í™œì„±í™” ì œì–´

---

## ğŸ“š ì—…ë°ì´íŠ¸ëœ ë¬¸ì„œ

1. `Backend/Batch-Server/CLAUDE.md`
   - í˜„ì¬ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
   - gRPC í†µì‹  í…ŒìŠ¤íŠ¸ ì™„ë£Œ í•­ëª© ì¶”ê°€

2. `Backend/Batch-Server/implement_struture.md`
   - êµ¬í˜„ í˜„í™© ì„¹ì…˜ ì¶”ê°€
   - ì™„ë£Œ/ì§„í–‰ì¤‘/ì˜ˆì • í•­ëª© ëª…í™•í™”

3. `Backend/Batch-Server/docs/gRPC_í†µì‹ _ê°€ì´ë“œ.md`
   - ì‹¤ì œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì„¹ì…˜ ì¶”ê°€
   - GrpcStreamTestService ì‚¬ìš© ì˜ˆì‹œ
   - í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë°©ë²• ì¶”ê°€

4. `Backend/Batch-Server/docs/Batchì„¤ê³„ì„œ.md`
   - êµ¬í˜„ ìƒíƒœ ì—…ë°ì´íŠ¸
   - í´ë” êµ¬ì¡°ì— êµ¬í˜„ ì™„ë£Œ í‘œì‹œ

---

**ì‘ì—… ì™„ë£Œ:** 2025-12-11
**ë‹¤ìŒ ì‘ì—…:** ChunkProcessor êµ¬í˜„ ë° DB ì €ì¥ ë¡œì§
