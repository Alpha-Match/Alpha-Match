# ë„ë©”ì¸ë³„ DB ìŠ¤í‚¤ë§ˆ ì„¤ê³„ ë° Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ì •ì±… ìˆ˜ë¦½

**ì‘ì„±ì¼**: 2025-12-12
**ì‘ì—…ì**: Claude (AI Assistant)
**ì¹´í…Œê³ ë¦¬**: DB ì„¤ê³„, Flyway ë§ˆì´ê·¸ë ˆì´ì…˜

---

## ğŸ“‹ ì‘ì—… ê°œìš”

### ëª©ì 
- ë„ë©”ì¸ í™•ì¥ ê°€ëŠ¥í•œ DB ìŠ¤í‚¤ë§ˆ ì„¤ê³„ (recruit â†’ recruit + candidate)
- Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ì •ì±… ë° ë²„ì „ ê´€ë¦¬ ì²´ê³„ ìˆ˜ë¦½
- Backend íŒ€ ê°„ ê³µìœ  ê°€ëŠ¥í•œ ë¬¸ì„œ ì‘ì„±

### ë°°ê²½
- í˜„ì¬ recruit ë„ë©”ì¸ë§Œ êµ¬í˜„ë˜ì–´ ìˆìŒ
- í–¥í›„ candidate, company ë“± ë‹¤ì–‘í•œ ë„ë©”ì¸ ì¶”ê°€ ì˜ˆì •
- ì¼ê´€ëœ ë§ˆì´ê·¸ë ˆì´ì…˜ ì •ì±… í•„ìš”
- API Serverì™€ DB ìŠ¤í‚¤ë§ˆ ê³µìœ  í•„ìš”

---

## ğŸ” ë¬¸ì œ ë¶„ì„

### 1. í˜„ì¬ ìŠ¤í‚¤ë§ˆ ë¬¸ì œì 

**V1__init_schema.sql ë¶„ì„:**
```
ë¬¸ì œì :
1. í…Œì´ë¸” ë„¤ì´ë° ë¶ˆì¼ì¹˜
   - recruit_metadata (ë„ë©”ì¸ í¬í•¨)
   - recruit_embedding_dlq (ë„ë©”ì¸ í¬í•¨)
   - embedding_batch_checkpoint (ë„ë©”ì¸ ë¯¸í¬í•¨)

2. ë„ë©”ì¸ êµ¬ë¶„ ì—†ìŒ
   - DLQ, Checkpointê°€ recruit ì „ìš©ìœ¼ë¡œ ê³ ì •
   - ìƒˆ ë„ë©”ì¸ ì¶”ê°€ ì‹œ í…Œì´ë¸” ì¦ì‹ í•„ìš”

3. ê°ì‚¬ ì»¬ëŸ¼ ëˆ„ë½
   - recruit_metadataì— created_at ì—†ìŒ
   - ìƒì„± ì‹œê°„ ì¶”ì  ë¶ˆê°€

4. FK ì œì•½ ë¶ˆëª…í™•
   - embeddingì´ metadataë¥¼ ì°¸ì¡°í•˜ë‚˜ ëª…í™•í•œ ê·œì¹™ ì—†ìŒ
```

### 2. ë„ë©”ì¸ í™•ì¥ ìš”êµ¬ì‚¬í•­

**ëª©í‘œ êµ¬ì¡°:**
```
Domain: recruit (384ì°¨ì›)
  - recruit_metadata
  - recruit_embedding

Domain: candidate (768ì°¨ì›)
  - candidate_metadata
  - candidate_embedding

Common:
  - dlq (ë„ë©”ì¸ ì»¬ëŸ¼ ì¶”ê°€)
  - checkpoint (ë„ë©”ì¸ PK)
```

---

## ğŸ› ï¸ êµ¬í˜„ ë‚´ìš©

### 1. Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ì‘ì„±

#### V2__add_candidate_schema.sql
- candidate_metadata í…Œì´ë¸” ìƒì„±
- candidate_embedding í…Œì´ë¸” ìƒì„± (768ì°¨ì›)
- ì¸ë±ìŠ¤ ìƒì„± (updated_at, name, GIN for skills)
- íŠ¸ë¦¬ê±° ìƒì„± (updated_at ìë™ ê°±ì‹ )

**í•µì‹¬ ë³€ê²½:**
```sql
-- skills ë°°ì—´ íƒ€ì… (PostgreSQL)
skills TEXT[]

-- 768ì°¨ì› ë²¡í„°
vector VECTOR(768)

-- GIN ì¸ë±ìŠ¤ (ë°°ì—´ ê²€ìƒ‰)
CREATE INDEX idx_candidate_metadata_skills_gin
ON candidate_metadata USING GIN(skills);
```

#### V3__add_domain_to_common_tables.sql
- DLQ í…Œì´ë¸” í†µí•© (recruit_embedding_dlq â†’ dlq)
- domain ì»¬ëŸ¼ ì¶”ê°€ (recruit, candidate)
- Checkpoint í…Œì´ë¸” ì¬êµ¬ì„± (PK: domain)
- recruit_metadataì— created_at ì¶”ê°€

**í•µì‹¬ ë³€ê²½:**
```sql
-- DLQ ë²”ìš©í™”
ALTER TABLE recruit_embedding_dlq RENAME TO dlq;
ALTER TABLE dlq ADD COLUMN domain VARCHAR(50) NOT NULL DEFAULT 'recruit';
ALTER TABLE dlq RENAME COLUMN recruit_id TO entity_id;

-- Checkpoint PK ë³€ê²½
ALTER TABLE checkpoint DROP CONSTRAINT IF EXISTS embedding_batch_checkpoint_pkey;
ALTER TABLE checkpoint ADD PRIMARY KEY (domain);
```

#### V4__add_performance_indexes.sql
- ë³µí•© ì¸ë±ìŠ¤ ì¶”ê°€ (company_name + exp_years)
- Partial ì¸ë±ìŠ¤ ì¶”ê°€ (ìµœê·¼ 7ì¼)
- GIN ì¸ë±ìŠ¤ ì¶”ê°€ (skills ë°°ì—´)
- HNSW ì¸ë±ìŠ¤ ì˜µì…˜ (ì£¼ì„ ì²˜ë¦¬)

**í•µì‹¬ ë³€ê²½:**
```sql
-- Partial ì¸ë±ìŠ¤ (ìµœê·¼ 7ì¼ ë°ì´í„°)
CREATE INDEX idx_recruit_metadata_recent_updates
ON recruit_metadata(updated_at DESC)
WHERE updated_at > NOW() - INTERVAL '7 days';

-- GIN ì¸ë±ìŠ¤ (ë°°ì—´ ê²€ìƒ‰)
CREATE INDEX idx_candidate_metadata_skills_gin
ON candidate_metadata USING GIN(skills);
```

#### V5__add_constraints_and_functions.sql
- CHECK ì œì•½ì¡°ê±´ ì¶”ê°€ (exp_years >= 0, salary > 0)
- íŠ¸ë¦¬ê±° í•¨ìˆ˜ ìƒì„± (update_updated_at_column)
- í—¬í¼ í•¨ìˆ˜ ìƒì„± (cosine_similarity, get_domain_stats)
- í†µê³„ ë·° ìƒì„± (v_all_domain_stats)

**í•µì‹¬ ë³€ê²½:**
```sql
-- CHECK ì œì•½ì¡°ê±´
ALTER TABLE recruit_metadata
ADD CONSTRAINT chk_recruit_exp_years_positive
CHECK (exp_years >= 0);

-- íŠ¸ë¦¬ê±° í•¨ìˆ˜ (updated_at ìë™ ê°±ì‹ )
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- í—¬í¼ í•¨ìˆ˜ (ë„ë©”ì¸ë³„ í†µê³„)
CREATE OR REPLACE FUNCTION get_domain_stats(domain_name VARCHAR)
RETURNS TABLE(...) AS $$ ... $$;
```

### 2. Entity í´ë˜ìŠ¤ ì„¤ê³„

#### Base Entity
```java
// BaseMetadataEntity.java
@MappedSuperclass
public abstract class BaseMetadataEntity {
    @Id private UUID id;
    @CreationTimestamp private LocalDateTime createdAt;
    @UpdateTimestamp private LocalDateTime updatedAt;

    public abstract String getDomainType();
}

// BaseEmbeddingEntity.java
@MappedSuperclass
public abstract class BaseEmbeddingEntity {
    @Id private UUID id;
    private PGvector vector;
    @UpdateTimestamp private LocalDateTime updatedAt;

    public abstract String getDomainType();
    public abstract int getVectorDimension();
}
```

#### ë„ë©”ì¸ë³„ Entity
```java
// RecruitMetadataEntity.java
@Entity
@Table(name = "recruit_metadata")
public class RecruitMetadataEntity extends BaseMetadataEntity {
    private String companyName;
    private Integer expYears;
    // ...

    @Override
    public String getDomainType() { return "recruit"; }
}

// CandidateMetadataEntity.java
@Entity
@Table(name = "candidate_metadata")
public class CandidateMetadataEntity extends BaseMetadataEntity {
    private String name;
    private String[] skills;  // PostgreSQL ë°°ì—´
    // ...

    @Override
    public String getDomainType() { return "candidate"; }
}
```

#### ê³µí†µ Entity ë²”ìš©í™”
```java
// DlqEntity.java
@Entity
@Table(name = "dlq")
public class DlqEntity {
    @Id @GeneratedValue private Long id;
    private String domain;  // 'recruit', 'candidate', etc.
    private UUID entityId;
    // ...

    public static DlqEntity forRecruit(UUID id, String error, String payload) { ... }
    public static DlqEntity forCandidate(UUID id, String error, String payload) { ... }
}

// CheckpointEntity.java
@Entity
@Table(name = "checkpoint")
public class CheckpointEntity {
    @Id private String domain;  // PK
    private UUID lastProcessedUuid;
    // ...

    public static CheckpointEntity forRecruit() { ... }
    public static CheckpointEntity forCandidate() { ... }
}
```

### 3. ê³µí†µ ë¬¸ì„œ ì‘ì„±

#### Backend ê³µí†µ ë¬¸ì„œ (Backend/docs/)
1. **DB_ìŠ¤í‚¤ë§ˆ_ê°€ì´ë“œ.md**
   - ë„ë©”ì¸ë³„ í…Œì´ë¸” êµ¬ì¡° ìƒì„¸
   - ERD ë‹¤ì´ì–´ê·¸ë¨
   - ì¸ë±ìŠ¤ ì „ëµ
   - í—¬í¼ í•¨ìˆ˜ ë° ë·°
   - ìƒˆ ë„ë©”ì¸ ì¶”ê°€ ë°©ë²•
   - íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

2. **Flyway_ë§ˆì´ê·¸ë ˆì´ì…˜_ê°€ì´ë“œ.md**
   - Flyway ê°œë… ë° ì›ì¹™
   - ë„¤ì´ë° ê·œì¹™
   - ë²„ì „ ê´€ë¦¬ ì •ì±…
   - ë§ˆì´ê·¸ë ˆì´ì…˜ ì‘ì„± ê°€ì´ë“œ
   - ë¡¤ë°± ë° ë³µêµ¬
   - íŒ€ í˜‘ì—… ì „ëµ

3. **ERD_ë‹¤ì´ì–´ê·¸ë¨.md**
   - ì „ì²´ ERD (í…ìŠ¤íŠ¸ ê¸°ë°˜)
   - ë„ë©”ì¸ë³„ ìƒì„¸ ERD
   - í…Œì´ë¸” ê´€ê³„
   - ë°ì´í„° í”Œë¡œìš°
   - ë²¡í„° ê²€ìƒ‰ í”Œë¡œìš°
   - í†µê³„ ì¡°íšŒ

#### Batch-Server ë¬¸ì„œ
4. **ë„ë©”ì¸_í™•ì¥_ê°€ì´ë“œ.md**
   - ìƒˆ ë„ë©”ì¸ ì¶”ê°€ ì²´í¬ë¦¬ìŠ¤íŠ¸
   - Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ í…œí”Œë¦¿
   - Entity ë° Repository í…œí”Œë¦¿
   - ì„œë¹„ìŠ¤ ë ˆì´ì–´ í™•ì¥
   - gRPC Proto ì—…ë°ì´íŠ¸
   - í…ŒìŠ¤íŠ¸ ì‘ì„±

---

## ğŸ“Š ê²°ê³¼

### 1. íŒŒì¼ êµ¬ì¡°
```
Backend/
â”œâ”€â”€ docs/  (ì‹ ê·œ ë””ë ‰í† ë¦¬)
â”‚   â”œâ”€â”€ DB_ìŠ¤í‚¤ë§ˆ_ê°€ì´ë“œ.md
â”‚   â”œâ”€â”€ Flyway_ë§ˆì´ê·¸ë ˆì´ì…˜_ê°€ì´ë“œ.md
â”‚   â””â”€â”€ ERD_ë‹¤ì´ì–´ê·¸ë¨.md
â”‚
â””â”€â”€ Batch-Server/
    â”œâ”€â”€ src/main/resources/db/migration/
    â”‚   â”œâ”€â”€ V1__init_schema.sql  (ê¸°ì¡´)
    â”‚   â”œâ”€â”€ V2__add_candidate_schema.sql  (ì‹ ê·œ)
    â”‚   â”œâ”€â”€ V3__add_domain_to_common_tables.sql  (ì‹ ê·œ)
    â”‚   â”œâ”€â”€ V4__add_performance_indexes.sql  (ì‹ ê·œ)
    â”‚   â””â”€â”€ V5__add_constraints_and_functions.sql  (ì‹ ê·œ)
    â”‚
    â”œâ”€â”€ src/main/java/com/alpha/backend/domain/
    â”‚   â”œâ”€â”€ common/  (ì‹ ê·œ)
    â”‚   â”‚   â”œâ”€â”€ BaseMetadataEntity.java
    â”‚   â”‚   â””â”€â”€ BaseEmbeddingEntity.java
    â”‚   â”œâ”€â”€ recruit/  (ì‹ ê·œ)
    â”‚   â”‚   â”œâ”€â”€ RecruitMetadataEntity.java
    â”‚   â”‚   â””â”€â”€ RecruitEmbeddingEntity.java
    â”‚   â”œâ”€â”€ candidate/  (ì‹ ê·œ)
    â”‚   â”‚   â”œâ”€â”€ CandidateMetadataEntity.java
    â”‚   â”‚   â””â”€â”€ CandidateEmbeddingEntity.java
    â”‚   â”œâ”€â”€ dlq/
    â”‚   â”‚   â””â”€â”€ DlqEntity.java  (ìˆ˜ì •: ë„ë©”ì¸ ë²”ìš©í™”)
    â”‚   â””â”€â”€ infrastructure/
    â”‚       â””â”€â”€ CheckpointEntity.java  (ìˆ˜ì •: ë„ë©”ì¸ PK)
    â”‚
    â””â”€â”€ docs/
        â”œâ”€â”€ ë„ë©”ì¸_í™•ì¥_ê°€ì´ë“œ.md  (ì‹ ê·œ)
        â””â”€â”€ hist/
            â””â”€â”€ 2025-12-12_01_ë„ë©”ì¸ë³„_ìŠ¤í‚¤ë§ˆ_ì„¤ê³„_ë°_Flyway_ì •ì±….md  (í˜„ì¬ ë¬¸ì„œ)
```

### 2. ë§ˆì´ê·¸ë ˆì´ì…˜ ë²„ì „ íˆìŠ¤í† ë¦¬
| ë²„ì „ | íŒŒì¼ëª… | ì„¤ëª… | ì£¼ìš” ë³€ê²½ |
|------|--------|------|----------|
| V1 | init_schema.sql | ì´ˆê¸° ìŠ¤í‚¤ë§ˆ (recruit) | recruit_metadata, recruit_embedding, dlq, checkpoint |
| V2 | add_candidate_schema.sql | candidate ë„ë©”ì¸ ì¶”ê°€ | candidate_metadata, candidate_embedding (768ì°¨ì›) |
| V3 | add_domain_to_common_tables.sql | ê³µí†µ í…Œì´ë¸” ë„ë©”ì¸ í™•ì¥ | dlq, checkpoint ë²”ìš©í™” |
| V4 | add_performance_indexes.sql | ì„±ëŠ¥ ì¸ë±ìŠ¤ ì¶”ê°€ | ë³µí•© ì¸ë±ìŠ¤, Partial ì¸ë±ìŠ¤, GIN ì¸ë±ìŠ¤ |
| V5 | add_constraints_and_functions.sql | ì œì•½ì¡°ê±´ ë° í•¨ìˆ˜ | CHECK ì œì•½, íŠ¸ë¦¬ê±°, í—¬í¼ í•¨ìˆ˜, ë·° |

### 3. ë„ë©”ì¸ êµ¬ì¡° ë¹„êµ

**Before (V1):**
```
recruit_metadata (384ì°¨ì›)
recruit_embedding
recruit_embedding_dlq (recruit ì „ìš©)
embedding_batch_checkpoint (í†µí•©)
```

**After (V5):**
```
recruit_metadata (384ì°¨ì›)
recruit_embedding
candidate_metadata (768ì°¨ì›)
candidate_embedding
dlq (ë„ë©”ì¸ë³„ êµ¬ë¶„)
checkpoint (ë„ë©”ì¸ë³„ PK)
```

---

## ğŸ¯ í•µì‹¬ ì„¤ê³„ ê²°ì •

### 1. DLQ/Checkpoint ë„ë©”ì¸ ë²”ìš©í™”
**ê²°ì •**: í…Œì´ë¸” í†µí•© + domain ì»¬ëŸ¼ ì¶”ê°€

**ì¥ì :**
- í…Œì´ë¸” ì¦ì‹ ë°©ì§€
- ë„ë©”ì¸ë³„ í†µê³„ ì¡°íšŒ ìš©ì´
- ì¼ê´€ëœ ì—ëŸ¬ ì²˜ë¦¬

**ë‹¨ì :**
- ì¿¼ë¦¬ ì‹œ domain í•„í„° í•„ìš”
- íŒŒí‹°ì…”ë‹ ê³ ë ¤ í•„ìš” (ëŒ€ê·œëª¨ ì‹œ)

### 2. Vector ì°¨ì› ë„ë©”ì¸ë³„ ë¶„ë¦¬
**ê²°ì •**: recruit(384) vs candidate(768)

**ì´ìœ :**
- ë„ë©”ì¸ íŠ¹ì„±ì— ë§ëŠ” ëª¨ë¸ ì‚¬ìš©
- í•˜ë‚˜ì˜ í…Œì´ë¸”ì— ê°€ë³€ ì°¨ì› ì €ì¥ ì‹œ ë³µì¡ë„ ì¦ê°€
- ë²¡í„° ì¸ë±ìŠ¤ ìµœì í™” ë…ë¦½ì  ìˆ˜í–‰

### 3. Base Entity íŒ¨í„´
**ê²°ì •**: @MappedSuperclass + abstract method

**ì¥ì :**
- ì½”ë“œ ì¤‘ë³µ ì œê±°
- ì¼ê´€ëœ ê°ì‚¬ ì»¬ëŸ¼ (created_at, updated_at)
- ë„ë©”ì¸ë³„ êµ¬í˜„ ê°•ì œ (getDomainType)

### 4. Flyway ì •ìˆ˜ ë²„ì „ ì‚¬ìš©
**ê²°ì •**: V1, V2, V3 (ì‹œë§¨í‹± ë²„ì „ ë¹„ì‚¬ìš©)

**ì´ìœ :**
- ê°„ë‹¨í•œ ë²„ì „ ê´€ë¦¬
- íŒ€ í˜‘ì—… ì‹œ ì¶©ëŒ ìµœì†Œí™”
- ìˆœì°¨ì  ì ìš© ëª…í™•

---

## ğŸš¨ ì£¼ì˜ì‚¬í•­

### 1. Flyway ë§ˆì´ê·¸ë ˆì´ì…˜
- **ì ˆëŒ€ ìˆ˜ì • ê¸ˆì§€**: ì´ë¯¸ ì ìš©ëœ íŒŒì¼ì€ ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ
- **ìˆœì°¨ ì ìš©**: V1 â†’ V2 â†’ V3 â†’ V4 â†’ V5 ìˆœì„œ ë³´ì¥
- **ë©±ë“±ì„±**: ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰í•´ë„ ì•ˆì „í•˜ê²Œ ì„¤ê³„ (IF NOT EXISTS)
- **Rollback ë¶ˆê°€**: ë³µêµ¬ëŠ” ìƒˆ ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œ ìˆ˜í–‰

### 2. Entity í´ë˜ìŠ¤
- **created_at**: JPAê°€ ìë™ ì„¤ì •í•˜ë¯€ë¡œ Builderì—ì„œ ì œì™¸
- **Vector ì°¨ì›**: Entityì—ì„œ ê²€ì¦ (fromFloatArray)
- **Domain Type**: í•˜ë“œì½”ë”© (Factory íŒ¨í„´ì—ì„œ ì‚¬ìš©)

### 3. ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„±
- V3ì—ì„œ ê¸°ì¡´ í…Œì´ë¸” ì´ë¦„ ë³€ê²½ (recruit_embedding_dlq â†’ dlq)
- V3ì—ì„œ recruit_metadataì— created_at ì¶”ê°€ (ê¸°ì¡´ ë°ì´í„°ëŠ” updated_atìœ¼ë¡œ ì„¤ì •)
- V3ì—ì„œ checkpoint PK ë³€ê²½ (id â†’ domain)

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„

### 1. ì¦‰ì‹œ ì‘ì—…
- [ ] ë¡œì»¬ DBì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸
- [ ] flyway_schema_history í™•ì¸
- [ ] ê¸°ì¡´ recruit ë°ì´í„° ì˜í–¥ í™•ì¸

### 2. Candidate ë„ë©”ì¸ êµ¬í˜„
- [ ] CandidateMetadataRepository ì‘ì„±
- [ ] CandidateEmbeddingRepository ì‘ì„±
- [ ] CandidateChunkProcessor ì‘ì„±
- [ ] gRPC Proto ì—…ë°ì´íŠ¸ (CandidateData ì¶”ê°€)

### 3. API Server ë™ê¸°í™”
- [ ] DB ìŠ¤í‚¤ë§ˆ ë³€ê²½ ê³µì§€
- [ ] GraphQL ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸
- [ ] Resolver êµ¬í˜„ (candidate ì¿¼ë¦¬)

### 4. í…ŒìŠ¤íŠ¸
- [ ] Repository ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
- [ ] Processor í†µí•© í…ŒìŠ¤íŠ¸
- [ ] Python Server ì—°ë™ í…ŒìŠ¤íŠ¸

---

## ğŸ”— ì°¸ì¡°

- **DB ìŠ¤í‚¤ë§ˆ ê°€ì´ë“œ**: `/Backend/docs/DB_ìŠ¤í‚¤ë§ˆ_ê°€ì´ë“œ.md`
- **Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ**: `/Backend/docs/Flyway_ë§ˆì´ê·¸ë ˆì´ì…˜_ê°€ì´ë“œ.md`
- **ERD ë‹¤ì´ì–´ê·¸ë¨**: `/Backend/docs/ERD_ë‹¤ì´ì–´ê·¸ë¨.md`
- **ë„ë©”ì¸ í™•ì¥ ê°€ì´ë“œ**: `/Backend/Batch-Server/docs/ë„ë©”ì¸_í™•ì¥_ê°€ì´ë“œ.md`

---

**ì‘ì—… ì™„ë£Œì¼**: 2025-12-12
