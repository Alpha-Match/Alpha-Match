# ë„ë©”ì¸ë³„ ì œë„¤ë¦­ êµ¬ì¡° êµ¬í˜„

**ì‘ì„±ì¼:** 2025-12-12
**ëª©ì :** Python ì„œë²„ì˜ ë„ë©”ì¸ë³„ ì œë„¤ë¦­ êµ¬ì¡°ì— ë§ì¶° Batch ì„œë²„ë¥¼ ìˆ˜ì •

---

## ğŸ“‹ êµ¬í˜„ ê°œìš”

Python ì„œë²„ëŠ” `Generic + Protocol` íŒ¨í„´ìœ¼ë¡œ ë„ë©”ì¸ë³„ ë¡œë”ë¥¼ ê´€ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.
ì´ì— ë§ì¶° Batch ì„œë²„ë„ **ë„ë©”ì¸ë³„ í”„ë¡œì„¸ì„œ íŒ¨í„´**ì„ êµ¬í˜„í•˜ì—¬ í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°ë¥¼ ì™„ì„±í–ˆìŠµë‹ˆë‹¤.

### Python ì„œë²„ êµ¬ì¡° (ì°¸ê³ )
```python
# infrastructure/loaders.py
class DataLoader(Protocol[T_Row]):
    def load(self, file_path: str) -> List[T_Row]: ...

class PklRecruitLoader(DataLoader[RecruitData]): ...
class PklCandidateLoader(DataLoader[CandidateData]): ...

def get_loader(domain: str) -> DataLoader:
    return _loader_registry.get(domain)
```

### Batch ì„œë²„ êµ¬ì¡° (êµ¬í˜„ ì™„ë£Œ)
```java
// application/processor/DataProcessor.java
public interface DataProcessor<T> {
    List<T> parseChunk(byte[] jsonChunk);
    void saveToDatabase(List<T> entities);
    String getDomain();
}

// application/processor/RecruitDataProcessor.java
public class RecruitDataProcessor implements DataProcessor<RecruitRowDto> { ... }

// application/processor/DataProcessorFactory.java
public DataProcessor<?> getProcessor(String domain) {
    return processorRegistry.get(domain);
}
```

---

## ğŸ—ï¸ êµ¬í˜„ ì•„í‚¤í…ì²˜

### 1. gRPC í†µì‹  íŒ¨í„´ (Client Streaming)

**Proto ì •ì˜ (embedding_stream.proto)**
```protobuf
service EmbeddingStreamService {
  rpc IngestDataStream(stream IngestDataRequest) returns (IngestDataResponse);
}

message IngestDataRequest {
  oneof request_type {
    IngestMetadata metadata = 1;  // ì²« ë²ˆì§¸ ë©”ì‹œì§€
    bytes data_chunk = 2;          // ì´í›„ ë©”ì‹œì§€ë“¤
  }
}

message IngestMetadata {
  string domain = 1;           // "recruit", "candidate" ë“±
  string file_name = 2;
  int32 vector_dimension = 3;
}
```

### 2. ë°ì´í„° í”Œë¡œìš°

```
[Python Server]
FastAPI POST /data/ingest/recruit?file_name=...
  â†“
IngestionService.ingest_data_from_file()
  â†“
get_loader("recruit") â†’ PklRecruitLoader
  â†“
loader.load(file_path) â†’ List[RecruitData]
  â†“
gRPC Client Streaming to Batch Server
  â†“ (1) IngestMetadata (domain="recruit")
  â†“ (2) data_chunk (JSON bytes)
  â†“ (3) data_chunk (JSON bytes)
  â†“ ...

[Batch Server]
EmbeddingStreamServiceImpl.ingestDataStream()
  â†“
(1) metadata ìˆ˜ì‹  â†’ domain ì‹ë³„
  â†“
DataProcessorFactory.getProcessor("recruit")
  â†“
RecruitDataProcessor ì„ íƒ
  â†“
(2+) data_chunk ìˆ˜ì‹  â†’ Virtual Thread ì „í™˜
  â†“
processor.parseChunk(jsonChunk) â†’ List<RecruitRowDto>
  â†“
processor.saveToDatabase(dtos)
  â†“
Metadata/Embedding ë¶„ë¦¬ â†’ Upsert
  â†“
PostgreSQL (recruit_metadata + recruit_embedding)
```

---

## ğŸ“¦ êµ¬í˜„ëœ ì»´í¬ë„ŒíŠ¸

### 1. ë„ë©”ì¸ë³„ í”„ë¡œì„¸ì„œ ì¸í„°í˜ì´ìŠ¤

**íŒŒì¼:** `application/processor/DataProcessor.java`

```java
public interface DataProcessor<T> {
    List<T> parseChunk(byte[] jsonChunk);
    void saveToDatabase(List<T> entities);
    String getDomain();
}
```

**ì—­í• :**
- Pythonì˜ `DataLoader` Protocolê³¼ ëŒ€ì‘
- ì œë„¤ë¦­ íƒ€ì… `T`ë¡œ ë„ë©”ì¸ë³„ DTO ì§€ì •
- íŒŒì‹±ê³¼ ì €ì¥ ë¡œì§ ë¶„ë¦¬

---

### 2. DTO í´ë˜ìŠ¤

**íŒŒì¼:**
- `application/processor/dto/RecruitRowDto.java`
- `application/processor/dto/CandidateRowDto.java` (ìŠ¤ì¼ˆë ˆí†¤)

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class RecruitRowDto {
    @JsonProperty("id")
    private String id;

    @JsonProperty("company_name")
    private String companyName;

    @JsonProperty("exp_years")
    private Integer expYears;

    @JsonProperty("english_level")
    private String englishLevel;

    @JsonProperty("primary_keyword")
    private String primaryKeyword;

    @JsonProperty("vector")
    private List<Float> vector;
}
```

**ì—­í• :**
- Pythonì˜ `RecruitData` Pydantic ëª¨ë¸ê³¼ ì¼ì¹˜í•˜ëŠ” êµ¬ì¡°
- Jacksonìœ¼ë¡œ JSON ì—­ì§ë ¬í™”
- `@JsonProperty`ë¡œ Python snake_case â†’ Java camelCase ë§¤í•‘

---

### 3. Recruit ë„ë©”ì¸ í”„ë¡œì„¸ì„œ

**íŒŒì¼:** `application/processor/RecruitDataProcessor.java`

```java
@Component
public class RecruitDataProcessor implements DataProcessor<RecruitRowDto> {

    @Override
    public String getDomain() {
        return "recruit";
    }

    @Override
    public List<RecruitRowDto> parseChunk(byte[] jsonChunk) {
        // JSON ë°°ì—´ ë¬¸ìì—´ â†’ List<String>
        String jsonArrayString = new String(jsonChunk, "UTF-8");
        List<String> jsonItems = objectMapper.readValue(
            jsonArrayString, new TypeReference<List<String>>() {}
        );

        // ê° JSON ë¬¸ìì—´ â†’ RecruitRowDto
        List<RecruitRowDto> rows = new ArrayList<>();
        for (String jsonItem : jsonItems) {
            RecruitRowDto dto = objectMapper.readValue(jsonItem, RecruitRowDto.class);
            rows.add(dto);
        }

        return rows;
    }

    @Override
    @Transactional
    public void saveToDatabase(List<RecruitRowDto> dtos) {
        // DTO â†’ Entity ë³€í™˜
        List<MetadataEntity> metadataList = ...
        List<EmbeddingEntity> embeddingList = ...

        // Vector ì°¨ì› ê²€ì¦
        int expectedDim = batchProperties.getVectorDimension();

        // Upsert (Metadata â†’ Embedding ìˆœì„œ)
        metadataRepository.upsertAll(metadataList);
        embeddingRepository.upsertAll(embeddingList);
    }
}
```

**ì£¼ìš” ê¸°ëŠ¥:**
- JSON ì²­í¬ íŒŒì‹± (Pythonì—ì„œ ì „ì†¡í•œ `["{...}", "{...}"]` í˜•íƒœ)
- DTO â†’ Entity ë³€í™˜
- Vector ì°¨ì› ê²€ì¦ (384ì°¨ì›)
- Metadata/Embedding ë¶„ë¦¬ ì €ì¥
- ìƒì„¸ ë¡œê¹… (Thread, Chunk size, ë§ˆì§€ë§‰ UUID/Company)

---

### 4. Candidate ë„ë©”ì¸ í”„ë¡œì„¸ì„œ (ìŠ¤ì¼ˆë ˆí†¤)

**íŒŒì¼:** `application/processor/CandidateDataProcessor.java`

```java
@Component
public class CandidateDataProcessor implements DataProcessor<CandidateRowDto> {

    @Override
    public String getDomain() {
        return "candidate";
    }

    @Override
    public List<CandidateRowDto> parseChunk(byte[] jsonChunk) {
        throw new UnsupportedOperationException(
            "Candidate ë„ë©”ì¸ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¶”í›„ í™•ì¥ ì˜ˆì •ì…ë‹ˆë‹¤."
        );
    }

    @Override
    public void saveToDatabase(List<CandidateRowDto> entities) {
        throw new UnsupportedOperationException(...);
    }
}
```

**ì—­í• :**
- ì¶”í›„ Candidate ë„ë©”ì¸ êµ¬í˜„ ì‹œ í™•ì¥ ì˜ˆì •
- í˜„ì¬ëŠ” UnsupportedOperationException ë°˜í™˜

---

### 5. í”„ë¡œì„¸ì„œ íŒ©í† ë¦¬

**íŒŒì¼:** `application/processor/DataProcessorFactory.java`

```java
@Component
public class DataProcessorFactory {

    private final List<DataProcessor<?>> processors;
    private final Map<String, DataProcessor<?>> processorRegistry = new HashMap<>();

    @PostConstruct
    public void init() {
        for (DataProcessor<?> processor : processors) {
            String domain = processor.getDomain();
            processorRegistry.put(domain, processor);
            log.info("[PROCESSOR_REGISTRY] Registered processor for domain: {}", domain);
        }
    }

    public DataProcessor<?> getProcessor(String domain) {
        DataProcessor<?> processor = processorRegistry.get(domain);

        if (processor == null) {
            throw new IllegalArgumentException(
                String.format("ì§€ì›í•˜ì§€ ì•ŠëŠ” ë„ë©”ì¸ì…ë‹ˆë‹¤: '%s'. ì‚¬ìš© ê°€ëŠ¥í•œ ë„ë©”ì¸: %s",
                    domain, processorRegistry.keySet())
            );
        }

        return processor;
    }
}
```

**ì—­í• :**
- Pythonì˜ `get_loader()` íŒ©í† ë¦¬ í•¨ìˆ˜ì™€ ëŒ€ì‘
- Spring Beanìœ¼ë¡œ ë“±ë¡ëœ ëª¨ë“  `DataProcessor` ìë™ ìˆ˜ì§‘
- `@PostConstruct`ë¡œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì´ˆê¸°í™”
- ë„ë©”ì¸ ì´ë¦„ìœ¼ë¡œ í”„ë¡œì„¸ì„œ ì¡°íšŒ

---

### 6. gRPC ì„œë²„ êµ¬í˜„

**íŒŒì¼:** `grpc/EmbeddingStreamServiceImpl.java`

```java
@Service
public class EmbeddingStreamServiceImpl
    extends EmbeddingStreamServiceGrpc.EmbeddingStreamServiceImplBase {

    private final DataProcessorFactory processorFactory;
    private final Executor virtualThreadExecutor;

    @Override
    public StreamObserver<IngestDataRequest> ingestDataStream(
            StreamObserver<IngestDataResponse> responseObserver) {

        return new StreamObserver<IngestDataRequest>() {
            private String domain;
            private DataProcessor<?> processor;

            @Override
            public void onNext(IngestDataRequest request) {
                // 1. ì²« ë©”ì‹œì§€: ë©”íƒ€ë°ì´í„° ìˆ˜ì‹ 
                if (request.hasMetadata()) {
                    domain = request.getMetadata().getDomain();
                    processor = processorFactory.getProcessor(domain);
                    // Vector ì°¨ì› ê²€ì¦
                    return;
                }

                // 2. ì´í›„ ë©”ì‹œì§€: ë°ì´í„° ì²­í¬ ìˆ˜ì‹ 
                if (request.hasDataChunk()) {
                    byte[] jsonChunk = request.getDataChunk().toByteArray();

                    // Virtual Threadë¡œ ì „í™˜
                    CompletableFuture.runAsync(() -> {
                        var parsedData = processor.parseChunk(jsonChunk);
                        processor.saveToDatabase(parsedData);
                    }, virtualThreadExecutor);
                }
            }

            @Override
            public void onCompleted() {
                IngestDataResponse response = IngestDataResponse.newBuilder()
                    .setSuccess(true)
                    .setReceivedChunks(receivedChunks.get())
                    .build();
                responseObserver.onNext(response);
                responseObserver.onCompleted();
            }
        };
    }
}
```

**ì£¼ìš” ê¸°ëŠ¥:**
- Client Streaming ì²˜ë¦¬
- ë©”íƒ€ë°ì´í„°ì—ì„œ domain ì‹ë³„ â†’ í”„ë¡œì„¸ì„œ ì„ íƒ
- Virtual Threadë¡œ Blocking JPA ì €ì¥
- ìƒì„¸ ë¡œê¹… (Domain, Thread, Chunk, Times)

---

## ğŸ”§ ì„¤ì • ë³€ê²½

### application.yml

```yaml
# gRPC ì„œë²„ ì„¤ì • ì¶”ê°€
grpc:
  server:
    port: 50051  # Python ì„œë²„ê°€ ì ‘ì†í•  í¬íŠ¸
```

---

## ğŸ“ ë¡œê¹… ì˜ˆì‹œ

### Python ì„œë²„
```
[INFO] API ìš”ì²­ ìˆ˜ì‹ : POST /data/ingest/recruit?file_name=processed_recruitment_data.pkl
[INFO] 'ì±„ìš© ê³µê³ (recruit)' ë„ë©”ì¸ ë°ì´í„° ìˆ˜ì§‘ ì„œë¹„ìŠ¤ ì‹œì‘
[DEBUG] ë„ë©”ì¸ 'recruit'ì— ëŒ€í•œ ë¡œë”ë¥¼ ì°¾ëŠ” ì¤‘...
[INFO] ì‚¬ìš©í•  ë¡œë”: PklRecruitLoader
[DEBUG] 'data/processed_recruitment_data.pkl' íŒŒì¼ ë¡œë”© ì¤‘...
[INFO] ì´ 141,897ê°œì˜ í–‰(row) ë°ì´í„° ë¡œë“œ ì™„ë£Œ
[INFO] ìŠ¤íŠ¸ë¦¼ ì‹œì‘: ë©”íƒ€ë°ì´í„° ì „ì†¡ (ë„ë©”ì¸: recruit, íŒŒì¼: processed_recruitment_data.pkl)
[DEBUG] ë°ì´í„° ì²­í¬ 1/474 ì „ì†¡
...
[INFO] ëª¨ë“  ë°ì´í„° ì²­í¬ ì „ì†¡ ì™„ë£Œ
```

### Batch ì„œë²„
```
[INFO] [PROCESSOR_REGISTRY] Registered processor for domain: recruit
[INFO] [PROCESSOR_REGISTRY] Registered processor for domain: candidate
[INFO] [PROCESSOR_REGISTRY] Total registered processors: 2 | Domains: [recruit, candidate]

[INFO] [INGEST_METADATA] Domain: recruit | File: processed_recruitment_data.pkl | Vector Dimension: 384
[INFO] [PROCESSOR_SELECTED] Domain: recruit | Processor: RecruitDataProcessor

[DEBUG] [INGEST_CHUNK] Domain: recruit | Chunk: 1 | Size: 45231 bytes
[DEBUG] [INGEST_PROCESSING] Domain: recruit | Chunk: 1 | Thread: VirtualThread[#123]
[DEBUG] [PARSE] Domain: recruit | Thread: VirtualThread[#123] | Rows: 100 | Time: 15ms
[INFO] [SAVE] Domain: recruit | Thread: VirtualThread[#123] | Chunk: 100 rows |
       Last UUID: abc-123-def | Last Company: ì‚¼ì„±ì „ì |
       Times: convert=12ms, db_save=45ms, total=57ms

[INFO] [INGEST] Domain: recruit | Chunk: 1 | Thread: VirtualThread[#123] |
        Rows: 100 | Times: parse=15ms, save=57ms, total=72ms

...

[INFO] [INGEST_STREAM_COMPLETED] Domain: recruit | File: processed_recruitment_data.pkl |
       Total chunks received: 474 | Processed: 474
```

---

## âœ… êµ¬í˜„ ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] DataProcessor ì¸í„°í˜ì´ìŠ¤ ì •ì˜
- [x] RecruitRowDto / CandidateRowDto ì‘ì„±
- [x] RecruitDataProcessor êµ¬í˜„ (JSON íŒŒì‹± + DB ì €ì¥)
- [x] CandidateDataProcessor ìŠ¤ì¼ˆë ˆí†¤ êµ¬í˜„
- [x] DataProcessorFactory êµ¬í˜„ (ìë™ ë“±ë¡ + ì¡°íšŒ)
- [x] EmbeddingStreamServiceImpl êµ¬í˜„ (Client Streaming)
- [x] application.ymlì— gRPC ì„œë²„ í¬íŠ¸ ì„¤ì •
- [x] ë¹Œë“œ ì„±ê³µ í™•ì¸
- [x] ìƒì„¸ ë¡œê¹… êµ¬í˜„

---

## ğŸš€ í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. Batch Server ì‹¤í–‰
```bash
cd Backend/Batch-Server
./gradlew bootRun
```

### 2. Python Server ì‹¤í–‰
```bash
cd Demo-Python
python src/main.py
```

### 3. FastAPIë¡œ ë°ì´í„° ì „ì†¡ íŠ¸ë¦¬ê±°
```bash
curl -X POST "http://localhost:8000/data/ingest/recruit?file_name=processed_recruitment_data.pkl"
```

### 4. ë¡œê·¸ í™•ì¸
- Python: ìŠ¤íŠ¸ë¦¬ë° ì§„í–‰ ìƒí™©
- Batch: í”„ë¡œì„¸ì„œ ì„ íƒ, ì²­í¬ ì²˜ë¦¬, DB ì €ì¥

---

## ğŸ” ê²€ì¦ í¬ì¸íŠ¸

### 1. í”„ë¡œì„¸ì„œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì´ˆê¸°í™”
```
[PROCESSOR_REGISTRY] Registered processor for domain: recruit
[PROCESSOR_REGISTRY] Registered processor for domain: candidate
[PROCESSOR_REGISTRY] Total registered processors: 2
```

### 2. ë„ë©”ì¸ ì‹ë³„ ë° í”„ë¡œì„¸ì„œ ì„ íƒ
```
[INGEST_METADATA] Domain: recruit
[PROCESSOR_SELECTED] Domain: recruit | Processor: RecruitDataProcessor
```

### 3. ì²­í¬ ì²˜ë¦¬
```
[INGEST_CHUNK] Domain: recruit | Chunk: 1 | Size: 45231 bytes
[PARSE] Domain: recruit | Thread: VirtualThread[#123] | Rows: 100 | Time: 15ms
[SAVE] Domain: recruit | Chunk: 100 rows | Last UUID: ... | Last Company: ...
```

### 4. Virtual Thread ì‚¬ìš©
```
Thread: VirtualThread[#123]
Thread: VirtualThread[#124]
...
```

### 5. Vector ì°¨ì› ê²€ì¦
```
Vector dimension: 384
Expected: 384, Actual: 384 âœ“
```

---

## ğŸ“š ê´€ë ¨ íŒŒì¼

### ìƒˆë¡œ ìƒì„±ëœ íŒŒì¼
1. `application/processor/DataProcessor.java`
2. `application/processor/DataProcessorFactory.java`
3. `application/processor/RecruitDataProcessor.java`
4. `application/processor/CandidateDataProcessor.java`
5. `application/processor/dto/RecruitRowDto.java`
6. `application/processor/dto/CandidateRowDto.java`
7. `grpc/EmbeddingStreamServiceImpl.java`

### ìˆ˜ì •ëœ íŒŒì¼
1. `application.yml` (gRPC ì„œë²„ í¬íŠ¸ ì¶”ê°€)
2. ê¸°ì¡´ íŒŒì¼ë“¤ì˜ import ìˆ˜ì • (proto íŒ¨í‚¤ì§€ ë³€ê²½)

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

### 1. í†µí•© í…ŒìŠ¤íŠ¸ (ìš°ì„ ìˆœìœ„: ë†’ìŒ)
- Python â†’ Batch Server ì „ì²´ í”Œë¡œìš° ê²€ì¦
- 141,897 rows ë°ì´í„° ì „ì†¡ í…ŒìŠ¤íŠ¸
- DB ì €ì¥ í™•ì¸ (recruit_metadata + recruit_embedding)

### 2. DLQ ì²˜ë¦¬ (ìš°ì„ ìˆœìœ„: ë†’ìŒ)
- íŒŒì‹± ì‹¤íŒ¨ ë˜ëŠ” ì €ì¥ ì‹¤íŒ¨ ì‹œ DLQ í…Œì´ë¸”ì— ê¸°ë¡
- ì—ëŸ¬ ë³µêµ¬ ë¡œì§ êµ¬í˜„

### 3. Candidate ë„ë©”ì¸ êµ¬í˜„ (ìš°ì„ ìˆœìœ„: ì¤‘ê°„)
- CandidateMetadata Entity ì •ì˜
- CandidateEmbedding Entity ì •ì˜
- CandidateDataProcessor êµ¬í˜„

### 4. ìºì‹œ ë¬´íš¨í™” í†µí•© (ìš°ì„ ìˆœìœ„: ì¤‘ê°„)
- ë°ì´í„° ì €ì¥ í›„ API Server ìºì‹œ ë¬´íš¨í™”
- CacheInvalidateGrpcClient ì—°ë™

---

**ìµœì¢… ìˆ˜ì •ì¼:** 2025-12-12
**ì‘ì„±ì:** Claude Sonnet 4.5
**ìƒíƒœ:** êµ¬í˜„ ì™„ë£Œ, í…ŒìŠ¤íŠ¸ ëŒ€ê¸°
