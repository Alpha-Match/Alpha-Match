spring:
  application:
    name: batch-service

  # PostgreSQL + pgvector 설정
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5433}/${DB_NAME:postgres}
    username: ${DB_USER:postgres}
    password: ${DB_PASSWORD:postgres}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  # JPA 설정
  jpa:
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        format_sql: true
        use_sql_comments: true
        jdbc:
          batch_size: 300
        order_inserts: true
        order_updates: true
    show-sql: true

  # Batch 설정
  batch:
    job:
      enabled: false  # 자동 실행 방지 (스케줄러로 제어)
    jdbc:
      initialize-schema: never  # Flyway로 관리

  # Flyway 설정 (DB 마이그레이션)
  flyway:
    enabled: true
    baseline-on-migrate: true
    locations: classpath:db/migration

  # Quartz 설정 - 스케줄링 라이브러리
  quartz:
    job-store-type: jdbc   # Quartz JobStore를 JDBC 기반으로 사용. DB에 Job/Trigger 상태 저장
    jdbc:
      initialize-schema: never   # Flyway로 관리
    properties:
      org.quartz.scheduler.instanceName: BatchScheduler   # 스케줄러 인스턴스 이름
      org.quartz.scheduler.instanceId: AUTO               # 인스턴스 ID 자동 생성 (클러스터 환경에서 유용)
      org.quartz.threadPool.class: org.quartz.simpl.SimpleThreadPool   # Quartz가 사용할 스레드풀 구현체
      org.quartz.threadPool.threadCount: 10       # 동시에 실행 가능한 Job 수 (스레드 개수)
      org.quartz.threadPool.threadPriority: 5     # 스레드 우선순위 (기본값 5)

      org.quartz.jobStore.class: org.quartz.impl.jdbcjobstore.JobStoreTX   # JDBC JobStore 구현체 (트랜잭션 지원)
      org.quartz.jobStore.driverDelegateClass: org.quartz.impl.jdbcjobstore.PostgreSQLDelegate
      org.quartz.jobStore.useProperties: false    # JobDataMap을 직렬화 방식으로 저장 (false면 BLOB 사용)
      org.quartz.jobStore.tablePrefix: QRTZ_      # Quartz 테이블 접두사 (예: QRTZ_JOB_DETAILS)
      org.quartz.jobStore.isClustered: false      # 단일 인스턴스 모드
      org.quartz.jobStore.misfireThreshold: 60000 # Misfire(지연 실행) 판단 기준 시간(ms). 60초 이상 지연되면 Misfire 처리
    # Quartz 전용 DataSource 명시
    datasource:
      quartzDataSource:
        url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5433}/${DB_NAME:postgres}
        username: ${DB_USER:postgres}
        password: ${DB_PASSWORD:postgres}
        driver-class-name: org.postgresql.Driver

# gRPC 설정
grpc:
  # gRPC 서버 설정 (Python에서 Client Streaming으로 데이터 수신)
  server:
    port: 50051  # Batch Server (IngestDataStream 수신)

  client:
    # Python AI Server (Embedding Stream)
    python-embedding:
      address: static://localhost:50053  # Python 서버 주소
      negotiation-type: plaintext
      max-inbound-message-size: 104857600  # 100MB

    # API Server (Cache Invalidate)
    api-cache:
      address: static://localhost:50052
      negotiation-type: plaintext

    #- dns:///service-name → DNS 기반 서비스 디스커버리
    #- static://host:port → 고정된 주소
    #- xds:// → Envoy/xDS 기반 서비스 디스커버리

# 커스텀 배치 설정
batch:
  embedding:
    chunk-size: 300                    # 한 번에 처리할 row 수
    max-retry: 3                       # 실패 시 재시도 횟수
    retry-backoff-ms: 1000            # 재시도 대기 시간 (ms)

    # 도메인별 설정
    domains:
      recruit:
        vector-dimension: 384          # Recruit Embedding 차원
        table-prefix: recruit          # 테이블 접두사
      candidate:
        vector-dimension: 768          # Candidate Embedding 차원
        table-prefix: candidate        # 테이블 접두사

  scheduler:
    enabled: true                      # 스케줄러 활성화 (false로 설정 시 수동 실행만 가능)
    jobs:
      recruit:
        cron: "0 0 2 * * ?"           # Recruit Job 실행 시간 (매일 새벽 2시)
        enabled: true                  # Recruit Job 활성화
      # candidate:
      #   cron: "0 0 3 * * ?"         # Candidate Job 실행 시간 (매일 새벽 3시) - 예정
      #   enabled: false               # Candidate Job 비활성화 - 예정

# Logging 설정
logging:
  level:
    com.alpha.backend: DEBUG
    org.springframework.batch: INFO
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    io.grpc: INFO