# ğŸ”„ ë°ì´í„° í”Œë¡œìš°

**ì‘ì„±ì¼:** 2025-12-10
**ì—…ë°ì´íŠ¸:** 2025-12-10

---

## 1. Embedding ë°ì´í„° ì €ì¥ í”Œë¡œìš°

### ì „ì²´ íë¦„

```mermaid
sequenceDiagram
    autonumber
    participant PY as Python AI Server
    participant BS as Batch Server
    participant DB as PostgreSQL(pgvector)
    participant API as API Server
    participant FE as Frontend

    PY->>BS: StreamEmbeddings(gRPC Streaming)
    BS->>DB: Upsert Metadata
    BS->>DB: Upsert Embedding Vector
    BS->>BS: Update Checkpoint
    BS->>API: Cache Invalidate Request
    API->>API: Clear Cache (Caffeine + Redis)
    API-->>BS: Invalidate Response

    Note over FE,API: ì‚¬ìš©ì ìš”ì²­ ì‹œ
    FE->>API: GraphQL Query
    API->>API: Cache Lookup (Miss)
    API->>DB: Vector Query
    DB-->>API: Query Result
    API-->>FE: Response
```

### ë‹¨ê³„ë³„ ìƒì„¸

#### Step 1: Python â†’ Batch (gRPC Streaming)
```python
# Python ì„œë²„
for chunk in chunks:
    yield RowChunk(rows=chunk)  # 300 rows per chunk
```

#### Step 2: Batch â†’ DB (Upsert)
```java
// Batch ì„œë²„
metadataRepository.upsertAll(metadataList);
embeddingRepository.upsertAll(embeddingList);
```

#### Step 3: Checkpoint ì—…ë°ì´íŠ¸
```java
UUID lastId = chunk.getLastRowId();
checkpointRepository.updateLatestCheckpoint(lastId);
```

#### Step 4: ìºì‹œ ë¬´íš¨í™”
```java
cacheInvalidateClient.invalidateCache("recruit");
```

---

## 2. ê²€ìƒ‰/ì¡°íšŒ í”Œë¡œìš°

### GraphQL ì¡°íšŒ íë¦„

```mermaid
flowchart TD
    A[Frontend: GraphQL Query] --> B{API Server}
    B --> C{Caffeine Cache}
    C -->|Hit| D[Return Cached Data]
    C -->|Miss| E{Redis Cache}
    E -->|Hit| F[Return Redis Data]
    E -->|Miss| G[PostgreSQL Query]
    G --> H[pgvector Similarity Search]
    H --> I[Cache Result]
    I --> J[Return to Frontend]
```

### ìºì‹± ì „ëµ

#### L1 Cache: Caffeine (In-Memory)
- **TTL:** 10ë¶„
- **Max Size:** 10,000ê°œ
- **ìš©ë„:** ìì£¼ ì¡°íšŒë˜ëŠ” ë°ì´í„°

#### L2 Cache: Redis (Distributed)
- **TTL:** 1ì‹œê°„
- **ì§ë ¬í™”:** byte[] ê¸°ë°˜
- **ìš©ë„:** ì„œë²„ ê°„ ê³µìœ  ìºì‹œ

#### DB Query
- **ìš©ë„:** Cache Miss ì‹œë§Œ ì‹¤í–‰
- **ìµœì í™”:** pgvector ì¸ë±ìŠ¤ í™œìš©

---

## 3. Vector Similarity Search í”Œë¡œìš°

### ìœ ì‚¬ë„ ê²€ìƒ‰ ê³¼ì •

```sql
-- pgvector L2 distance ê²€ìƒ‰
SELECT * FROM recruit_embedding
ORDER BY vector <-> CAST(:queryVector AS vector)
LIMIT :limit;
```

### ê²€ìƒ‰ ìµœì í™”

#### IVFFlat ì¸ë±ìŠ¤
```sql
CREATE INDEX recruit_embedding_ivfflat
ON recruit_embedding USING ivfflat (vector vector_l2_ops)
WITH (lists = 100);
```

#### ì„±ëŠ¥ íŠœë‹
- **lists:** í´ëŸ¬ìŠ¤í„° ìˆ˜ (100~1000)
- **probes:** ê²€ìƒ‰ ì‹œ í™•ì¸í•  í´ëŸ¬ìŠ¤í„° ìˆ˜
- **Trade-off:** ì •í™•ë„ vs ì†ë„

---

## 4. ì˜ˆì™¸ ìƒí™© ì²˜ë¦¬ í”Œë¡œìš°

### 4.1 gRPC Stream ì¤‘ë‹¨

```mermaid
flowchart TD
    A[Stream ì¤‘ë‹¨ ë°œìƒ] --> B[ë§ˆì§€ë§‰ Checkpoint í™•ì¸]
    B --> C[last_processed_uuid ì €ì¥]
    C --> D[ì„œë²„ ì¬ì‹œì‘]
    D --> E[Checkpoint ì´í›„ ë°ì´í„° ìš”ì²­]
    E --> F[ì¬ê°œ]
```

### 4.2 Batch Upsert ì‹¤íŒ¨

```mermaid
flowchart TD
    A[Row ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜] --> B{ì˜¤ë¥˜ íƒ€ì…}
    B -->|Validation Error| C[DLQ í…Œì´ë¸” ì €ì¥]
    B -->|Vector Dimension Mismatch| D[DLQ í…Œì´ë¸” ì €ì¥]
    B -->|DB Connection Error| E[ì „ì²´ Chunk ì¬ì‹œë„]
    C --> F[ë‹¤ìŒ Row ê³„ì† ì²˜ë¦¬]
    D --> F
    E -->|ì‹¤íŒ¨| G[ì•Œë¦¼ + ë¡œê·¸]
```

### 4.3 ìºì‹œ ë¬´íš¨í™” ì‹¤íŒ¨

```mermaid
flowchart TD
    A[Cache Invalidate í˜¸ì¶œ] --> B{API Server ì‘ë‹µ}
    B -->|Success| C[ì™„ë£Œ]
    B -->|Timeout| D[Retry with Backoff]
    B -->|Connection Refused| D
    D -->|3íšŒ ì‹¤íŒ¨| E[ìŠ¤ì¼€ì¤„ëŸ¬ì— ë“±ë¡]
    E --> F[ë‚˜ì¤‘ì— ì¬ì‹œë„]
```

---

## 5. ë°ì´í„° ì¼ê´€ì„± ë³´ì¥

### Checkpoint ê¸°ë°˜ ì¬ì‹œì‘
- **ì €ì¥ ì‹œì :** ê° Chunk ì²˜ë¦¬ ì™„ë£Œ í›„
- **ì €ì¥ ë‚´ìš©:** ë§ˆì§€ë§‰ ì²˜ë¦¬ëœ UUID
- **í™œìš©:** ì¬ì‹œì‘ ì‹œ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€

### Upsert ì „ëµ
```sql
INSERT INTO recruit_metadata (...)
VALUES (...)
ON CONFLICT (id) DO UPDATE SET ...;
```
- **Idempotent:** ë™ì¼ ìš”ì²­ ë°˜ë³µ ì‹¤í–‰ ì•ˆì „
- **ì¥ì :** ì¬ì²˜ë¦¬ ì‹œì—ë„ ë°ì´í„° ì¼ê´€ì„± ìœ ì§€

### Race Condition ë°©ì§€
```java
// ìºì‹œ ë¬´íš¨í™” ì¤‘ë³µ ë°©ì§€
private final AtomicBoolean invalidating = new AtomicBoolean(false);

public void invalidateSafely() {
    if (invalidating.compareAndSet(false, true)) {
        try {
            // ë¬´íš¨í™” ë¡œì§
        } finally {
            invalidating.set(false);
        }
    }
}
```

---

## ê´€ë ¨ ë¬¸ì„œ
- [ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜](./ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜.md)
- [Batch ì„¤ê³„ì„œ](../Backend/Batch-Server/docs/Batchì„¤ê³„ì„œ.md)
