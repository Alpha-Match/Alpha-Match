# v2 ìŠ¤í‚¤ë§ˆ í…ŒìŠ¤íŠ¸ ì„¸íŒ… ê°€ì´ë“œ

**ì‘ì„±ì¼**: 2025-12-21
**ëª©ì **: Flyway V2 ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ ì „ì²´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸

---

## ğŸ“‹ ì‚¬ì „ ì¤€ë¹„

### 1. í•„ìˆ˜ ì†Œí”„íŠ¸ì›¨ì–´ í™•ì¸

```bash
# PostgreSQL 15+ (pgvector ì§€ì›)
psql --version

# Java 21+
java -version

# Python 3.11+
python --version

# Gradle 8+
gradle --version
```

---

## ğŸ—„ï¸ Step 1: PostgreSQL ì„¤ì •

### 1.1 ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±

```sql
-- PostgreSQLì— ì ‘ì†
psql -U postgres

-- ê¸°ì¡´ DB ì‚­ì œ (ì£¼ì˜: ë°ì´í„° ì†ì‹¤)
DROP DATABASE IF EXISTS alpha_match;

-- ìƒˆ DB ìƒì„±
CREATE DATABASE alpha_match;

-- DB ì—°ê²°
\c alpha_match

-- pgvector extension í™•ì¸
CREATE EXTENSION IF NOT EXISTS vector;
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- í™•ì¸
\dx
```

### 1.2 application.yml í™•ì¸

`Backend/Batch-Server/src/main/resources/application.yml`:

```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/alpha_match
    username: postgres
    password: your_password

  flyway:
    enabled: true
    baseline-on-migrate: true
    clean-disabled: false  # í…ŒìŠ¤íŠ¸ ì‹œì—ë§Œ false
```

---

## ğŸ”„ Step 2: Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

### 2.1 ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ í™•ì¸

```bash
cd Backend/Batch-Server

# V1, V2 íŒŒì¼ ì¡´ì¬ í™•ì¸
ls src/main/resources/db/migration/
# V1__init_database_schema.sql
# V2__restructure_schema_to_v2.sql
```

### 2.2 ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™” (Clean Start)

```bash
# Flyway Clean (ëª¨ë“  í…Œì´ë¸” ì‚­ì œ)
./gradlew flywayClean

# Flyway Migrate (V1 â†’ V2 ìˆœì°¨ ì‹¤í–‰)
./gradlew flywayMigrate

# ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸
./gradlew flywayInfo
```

**ì˜ˆìƒ ì¶œë ¥:**
```
+-----------+---------+----------------------------+----------+
| Category  | Version | Description                | State    |
+-----------+---------+----------------------------+----------+
| Versioned | 1       | init database schema       | Success  |
| Versioned | 2       | restructure schema to v2   | Success  |
+-----------+---------+----------------------------+----------+
```

### 2.3 í…Œì´ë¸” ìƒì„± í™•ì¸

```sql
-- PostgreSQLì—ì„œ í™•ì¸
\c alpha_match

-- ëª¨ë“  í…Œì´ë¸” ì¡°íšŒ
\dt

-- ì˜ˆìƒ í…Œì´ë¸” (v2):
-- skill_category_dic
-- skill_embedding_dic
-- candidate
-- candidate_description
-- candidate_skill
-- candidate_skills_embedding
-- recruit
-- recruit_description
-- recruit_skill
-- recruit_skills_embedding
-- dlq
-- checkpoint
-- (+ Spring Batch, Quartz í…Œì´ë¸”ë“¤)

-- ë²¡í„° ì°¨ì› í™•ì¸
SELECT
    tablename,
    attname,
    atttypid::regtype
FROM pg_attribute
JOIN pg_class ON pg_class.oid = attrelid
WHERE attname LIKE '%vector%' AND relnamespace = 'public'::regnamespace;

-- ì˜ˆìƒ ì¶œë ¥:
-- skill_embedding_dic     | skill_vector       | vector(384)
-- candidate_skills_embedding | skills_vector   | vector(384)
-- recruit_skills_embedding   | skills_vector   | vector(384)
```

---

## ğŸ Step 3: Demo-Python ì„œë²„ ì¤€ë¹„

### 3.1 ë°ì´í„° íŒŒì¼ í™•ì¸

```bash
cd Demo-Python

# ë°ì´í„° íŒŒì¼ ì¡´ì¬ í™•ì¸
ls data/
# skill_embeddings.json  (ê¸°ìˆ  ìŠ¤íƒ ì„ë² ë”© ì‚¬ì „)
# recruitment_v1.pkl     (ì±„ìš© ê³µê³  ë°ì´í„°)

# JSON íŒŒì¼ êµ¬ì¡° í™•ì¸
head -n 20 data/skill_embeddings.json
```

**ì˜ˆìƒ êµ¬ì¡° (skill_embeddings.json):**
```json
[
  {
    "name": "Java",
    "category": "Backend",
    "vector": [0.123, -0.456, ...] // 384ì°¨ì›
  },
  ...
]
```

### 3.2 Python í™˜ê²½ ì„¤ì •

```bash
# ê°€ìƒí™˜ê²½ ìƒì„±
python -m venv venv

# í™œì„±í™”
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# íŒ¨í‚¤ì§€ ì„¤ì¹˜
pip install -r requirements.txt

# ì£¼ìš” íŒ¨í‚¤ì§€ í™•ì¸
pip list | grep -E "grpcio|protobuf|pandas|numpy"
```

### 3.3 Proto íŒŒì¼ ì»´íŒŒì¼

```bash
# Proto íŒŒì¼ ì»´íŒŒì¼ (v2 ì—…ë°ì´íŠ¸ í›„)
python -m grpc_tools.protoc \
    -I../Backend/Batch-Server/src/main/proto \
    --python_out=./src/generated \
    --grpc_python_out=./src/generated \
    ../Backend/Batch-Server/src/main/proto/embedding_stream.proto

# ìƒì„±ëœ íŒŒì¼ í™•ì¸
ls src/generated/
# embedding_stream_pb2.py
# embedding_stream_pb2_grpc.py
```

### 3.4 Python ì„œë²„ ì‹¤í–‰

```bash
# gRPC ì„œë²„ ì‹œì‘
python src/grpc_server.py

# ì˜ˆìƒ ì¶œë ¥:
# [INFO] Starting gRPC Server on port 50051
# [INFO] Loaded skill_embeddings.json: 150 skills
# [INFO] Loaded recruitment_v1.pkl: 10000 records
# [INFO] Server started successfully
```

---

## â˜• Step 4: Batch-Server ì‹¤í–‰

### 4.1 Gradle ë¹Œë“œ

```bash
cd Backend/Batch-Server

# ì „ì²´ ë¹Œë“œ (Proto ì»´íŒŒì¼ í¬í•¨)
./gradlew clean build -x test

# ë¹Œë“œ ì„±ê³µ í™•ì¸
ls build/libs/
# Batch-Server-0.0.1-SNAPSHOT.jar
```

### 4.2 ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰

```bash
# Spring Boot ì‹¤í–‰
./gradlew bootRun

# ë˜ëŠ” JAR ì‹¤í–‰
java -jar build/libs/Batch-Server-0.0.1-SNAPSHOT.jar
```

**ì˜ˆìƒ ë¡œê·¸:**
```
[INFO] Starting BatchServerApplication
[INFO] Flyway migration check: V2 applied
[INFO] gRPC Channel created: localhost:50051
[INFO] Quartz Scheduler started
[INFO] BatchJobFactory initialized: [recruit, candidate, skill_dic]
[INFO] Application started successfully
```

---

## ğŸ§ª Step 5: í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: Skill Embedding Dictionary ì ì¬

#### 5.1 ìˆ˜ë™ Job íŠ¸ë¦¬ê±°

```bash
# PostgreSQLì—ì„œ í™•ì¸
psql -U postgres -d alpha_match

-- Checkpoint ì´ˆê¸°í™”
DELETE FROM checkpoint WHERE domain = 'skill_dic';
INSERT INTO checkpoint (domain, last_processed_uuid, processed_count, updated_at)
VALUES ('skill_dic', NULL, 0, NOW());

-- Batch Job ìˆ˜ë™ ì‹¤í–‰ (Quartz ë˜ëŠ” API í˜¸ì¶œ)
```

#### 5.2 ê²°ê³¼ í™•ì¸

```sql
-- skill_category_dic í™•ì¸
SELECT category_id, category, created_at
FROM skill_category_dic
ORDER BY category;

-- skill_embedding_dic í™•ì¸
SELECT skill_id, skill, category_id,
       vector_dims(skill_vector) as dimension
FROM skill_embedding_dic
LIMIT 10;

-- ì˜ˆìƒ ê²°ê³¼:
-- dimension = 384 (ëª¨ë“  ë ˆì½”ë“œ)

-- ë²¡í„° ìœ ì‚¬ë„ í…ŒìŠ¤íŠ¸
SELECT skill,
       1 - (skill_vector <=> (SELECT skill_vector FROM skill_embedding_dic WHERE skill = 'Java')) as similarity
FROM skill_embedding_dic
ORDER BY similarity DESC
LIMIT 5;
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: Recruit ë°ì´í„° ì ì¬

#### 5.1 Job ì‹¤í–‰

```sql
-- Checkpoint ì´ˆê¸°í™”
DELETE FROM checkpoint WHERE domain = 'recruit';
INSERT INTO checkpoint (domain, last_processed_uuid, processed_count, updated_at)
VALUES ('recruit', NULL, 0, NOW());
```

#### 5.2 ê²°ê³¼ í™•ì¸

```sql
-- recruit ë©”íƒ€ë°ì´í„°
SELECT recruit_id, position, company_name, experience_years, published_at
FROM recruit
LIMIT 5;

-- recruit_description
SELECT recruit_id,
       LEFT(long_description, 100) as description_preview,
       description_lang
FROM recruit_description
LIMIT 5;

-- recruit_skill
SELECT recruit_id, skill
FROM recruit_skill
WHERE recruit_id = (SELECT recruit_id FROM recruit LIMIT 1);

-- recruit_skills_embedding
SELECT recruit_id,
       skills,
       vector_dims(skills_vector) as dimension
FROM recruit_skills_embedding
LIMIT 5;

-- ë²¡í„° ìœ ì‚¬ë„ ê²€ìƒ‰
SELECT r.recruit_id, r.position, r.company_name,
       1 - (rse.skills_vector <=> '[0.1, 0.2, ...]'::vector(384)) as similarity
FROM recruit r
JOIN recruit_skills_embedding rse ON r.recruit_id = rse.recruit_id
ORDER BY similarity DESC
LIMIT 10;
```

### ì‹œë‚˜ë¦¬ì˜¤ 3: Candidate ë°ì´í„° ì ì¬

#### 5.1 Job ì‹¤í–‰

```sql
-- Checkpoint ì´ˆê¸°í™”
DELETE FROM checkpoint WHERE domain = 'candidate';
INSERT INTO checkpoint (domain, last_processed_uuid, processed_count, updated_at)
VALUES ('candidate', NULL, 0, NOW());
```

#### 5.2 ê²°ê³¼ í™•ì¸

```sql
-- candidate ë©”íƒ€ë°ì´í„°
SELECT candidate_id, position_category, experience_years
FROM candidate
LIMIT 5;

-- candidate_description
SELECT candidate_id,
       LEFT(original_resume, 100) as resume_preview
FROM candidate_description
LIMIT 5;

-- candidate_skill
SELECT candidate_id, skill
FROM candidate_skill
WHERE candidate_id = (SELECT candidate_id FROM candidate LIMIT 1);

-- candidate_skills_embedding
SELECT candidate_id,
       skills,
       vector_dims(skills_vector) as dimension
FROM candidate_skills_embedding
LIMIT 5;
```

---

## ğŸ” Step 6: í†µí•© ê²€ì¦

### 6.1 ë°ì´í„° ì¼ê´€ì„± ì²´í¬

```sql
-- 1. FK ë¬´ê²°ì„± ê²€ì¦
SELECT 'recruit' as domain,
       (SELECT COUNT(*) FROM recruit) as metadata_count,
       (SELECT COUNT(*) FROM recruit_skills_embedding) as embedding_count,
       (SELECT COUNT(*) FROM recruit) - (SELECT COUNT(*) FROM recruit_skills_embedding) as diff
UNION ALL
SELECT 'candidate',
       (SELECT COUNT(*) FROM candidate),
       (SELECT COUNT(*) FROM candidate_skills_embedding),
       (SELECT COUNT(*) FROM candidate) - (SELECT COUNT(*) FROM candidate_skills_embedding);

-- 2. ë²¡í„° ì°¨ì› ì¼ê´€ì„±
SELECT 'skill_dic' as table_name,
       MIN(vector_dims(skill_vector)) as min_dim,
       MAX(vector_dims(skill_vector)) as max_dim,
       AVG(vector_dims(skill_vector))::int as avg_dim
FROM skill_embedding_dic
UNION ALL
SELECT 'recruit_skills_embedding',
       MIN(vector_dims(skills_vector)),
       MAX(vector_dims(skills_vector)),
       AVG(vector_dims(skills_vector))::int
FROM recruit_skills_embedding
UNION ALL
SELECT 'candidate_skills_embedding',
       MIN(vector_dims(skills_vector)),
       MAX(vector_dims(skills_vector)),
       AVG(vector_dims(skills_vector))::int
FROM candidate_skills_embedding;

-- ì˜ˆìƒ ê²°ê³¼: ëª¨ë“  ë²¡í„° 384ì°¨ì›

-- 3. DLQ í™•ì¸ (ì‹¤íŒ¨ ë ˆì½”ë“œ)
SELECT domain, COUNT(*) as failed_count
FROM dlq
GROUP BY domain;

-- ì˜ˆìƒ: 0ê±´ (ì •ìƒ ì²˜ë¦¬ ì‹œ)
```

### 6.2 ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

```sql
-- ë²¡í„° ì¸ë±ìŠ¤ ì„±ëŠ¥ í™•ì¸
EXPLAIN ANALYZE
SELECT recruit_id,
       1 - (skills_vector <=> '[0.1, 0.2, ...]'::vector(384)) as similarity
FROM recruit_skills_embedding
ORDER BY skills_vector <=> '[0.1, 0.2, ...]'::vector(384)
LIMIT 10;

-- IVFFlat ì¸ë±ìŠ¤ ì‚¬ìš© í™•ì¸
-- "Index Scan using idx_recruit_skills_vector" ì¶œë ¥ë˜ì–´ì•¼ í•¨
```

---

## ğŸš¨ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: Flyway ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨

**ì¦ìƒ:**
```
ERROR: relation "recruit_metadata" does not exist
```

**í•´ê²°:**
```bash
# Flyway Clean í›„ ì¬ì‹¤í–‰
./gradlew flywayClean
./gradlew flywayMigrate
```

### ë¬¸ì œ 2: ë²¡í„° ì°¨ì› ë¶ˆì¼ì¹˜

**ì¦ìƒ:**
```
ERROR: vector dimension mismatch: expected 384, got 768
```

**í•´ê²°:**
- Python ë°ì´í„° íŒŒì¼ í™•ì¸ (skill_embeddings.jsonì˜ vector ê¸¸ì´)
- Entityì˜ VECTOR_DIMENSION ìƒìˆ˜ í™•ì¸ (384ë¡œ ì„¤ì •)

### ë¬¸ì œ 3: gRPC ì—°ê²° ì‹¤íŒ¨

**ì¦ìƒ:**
```
ERROR: io.grpc.StatusRuntimeException: UNAVAILABLE
```

**í•´ê²°:**
```bash
# Python ì„œë²„ ì‹¤í–‰ í™•ì¸
netstat -an | grep 50051

# ë°©í™”ë²½ í™•ì¸
# Windows: ë°©í™”ë²½ì—ì„œ 50051 í¬íŠ¸ í—ˆìš©
```

### ë¬¸ì œ 4: UUID ìë™ ìƒì„± ì•ˆë¨

**ì¦ìƒ:**
```
ERROR: null value in column "skill_id" violates not-null constraint
```

**í•´ê²°:**
- Entityì— `@GeneratedValue(strategy = GenerationType.AUTO)` í™•ì¸
- PostgreSQL uuid-ossp extension ì„¤ì¹˜ í™•ì¸

---

## ğŸ“Š ëª¨ë‹ˆí„°ë§

### ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸

```bash
# Batch-Server ë¡œê·¸
tail -f Backend/Batch-Server/logs/application.log

# Python ì„œë²„ ë¡œê·¸
tail -f Demo-Python/logs/grpc_server.log
```

### ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë‹ˆí„°ë§

```sql
-- ì‹¤ì‹œê°„ ì²˜ë¦¬ ì§„í–‰ë¥ 
SELECT domain,
       processed_count,
       last_processed_uuid,
       updated_at
FROM checkpoint
ORDER BY updated_at DESC;

-- Quartz Job ìƒíƒœ
SELECT job_name, trigger_state, next_fire_time
FROM qrtz_triggers
ORDER BY next_fire_time;
```

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

í…ŒìŠ¤íŠ¸ ì™„ë£Œ ì „ í™•ì¸:

- [ ] PostgreSQL 15+ ì„¤ì¹˜ ë° pgvector extension í™œì„±í™”
- [ ] Flyway V2 ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ (V1 â†’ V2)
- [ ] ëª¨ë“  í…Œì´ë¸” ìƒì„± í™•ì¸ (13ê°œ + Spring Batch + Quartz)
- [ ] ëª¨ë“  ë²¡í„° ì°¨ì› 384d í™•ì¸
- [ ] Python ì„œë²„ ì‹¤í–‰ ë° í¬íŠ¸ 50051 ë¦¬ìŠ¤ë‹
- [ ] Batch-Server ì‹¤í–‰ ë° gRPC ì—°ê²° ì„±ê³µ
- [ ] Skill Dictionary ë°ì´í„° ì ì¬ ì„±ê³µ
- [ ] Recruit ë°ì´í„° ì ì¬ ì„±ê³µ (4ê°œ í…Œì´ë¸”)
- [ ] Candidate ë°ì´í„° ì ì¬ ì„±ê³µ (4ê°œ í…Œì´ë¸”)
- [ ] FK ë¬´ê²°ì„± ê²€ì¦ í†µê³¼
- [ ] DLQ 0ê±´ (ì—ëŸ¬ ì—†ìŒ)
- [ ] ë²¡í„° ìœ ì‚¬ë„ ê²€ìƒ‰ ë™ì‘ í™•ì¸

---

**ìµœì¢… ìˆ˜ì •ì¼**: 2025-12-21
